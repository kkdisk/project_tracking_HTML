<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Tracker v6.8 </title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            safelist: [
                'bg-rose-50', 'bg-rose-50/50', 'border-rose-500', 'bg-rose-100', 'text-rose-700',
                'bg-red-50', 'hover:bg-red-50/30', 'border-red-500', 'bg-red-100', 'text-red-700', 'border-red-200',
                'bg-orange-50', 'bg-orange-50/30', 'border-orange-500', 'bg-orange-100', 'text-orange-700', 'border-orange-200',
                'bg-yellow-100', 'text-yellow-700', 'border-yellow-200',
                'border-l-4'
            ]
        }
    </script>

    <!-- React & ReactDOM -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>

    <!-- Prop Types -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>

    <!-- Recharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.10.3/Recharts.min.js"></script>

    <!-- Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <!-- SheetJS for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Data Converter - å¼·åˆ¶é‡æ–°è¼‰å…¥ä¿®å¾©å¾Œçš„ç‰ˆæœ¬ -->
    <script>
/**
 * UnifiedTaskManager Excel æ ¼å¼è½‰æ›å™¨
 * å°‡ Excel è³‡æ–™æ ¼å¼è½‰æ›ç‚º Project Tracker æ‰€éœ€æ ¼å¼
 * VERSION: 2025-12-11_1300 - æ”¯æ´ Excel åºåˆ—è™Ÿæ—¥æœŸæ ¼å¼
 */

// ç¢ºèªæ­¤ç‰ˆæœ¬å·²è¼‰å…¥
console.log('âœ… data_converter.js å·²è¼‰å…¥ - ç‰ˆæœ¬: 2025-12-11_1300 (æ”¯æ´ Excel æ—¥æœŸåºåˆ—è™Ÿ)');

/**
 * normalizeDate å‡½æ•¸å·²åœ¨ index.html ä¸­å®šç¾©ï¼ˆè¦†å¯«ç‰ˆæœ¬ï¼‰
 * æ­¤è™•ä¸å†å®šç¾©ï¼Œç›´æ¥ä½¿ç”¨å…¨åŸŸç‰ˆæœ¬
 * è©²å‡½æ•¸æ”¯æ´ Excel æ—¥æœŸåºåˆ—è™Ÿå’Œå­—ä¸²æ ¼å¼
 */

/**
 * è¨ˆç®—å…©å€‹æ—¥æœŸä¹‹é–“çš„å¤©æ•¸å·®
 */
function calculateDuration(startDateStr, endDateStr) {
    if (!startDateStr || !endDateStr) return 0;

    try {
        const start = new Date(startDateStr);
        const end = new Date(endDateStr);

        if (isNaN(start.getTime()) || isNaN(end.getTime())) return 0;

        const diffTime = end.getTime() - start.getTime();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        return Math.max(0, diffDays); // ç¢ºä¿ä¸ç‚ºè² æ•¸
    } catch (e) {
        console.error('Duration è¨ˆç®—éŒ¯èª¤:', startDateStr, endDateStr, e);
        return 0;
    }
}

/**
 * å°æ‡‰ç‹€æ…‹å€¼
 * UnifiedTaskManager: done, closed, report, in-progress, todo ç­‰
 * Project Tracker: Done, InProgress, Todo
 */
function mapStatus(utmStatus) {
    if (!utmStatus) return 'Todo';

    const status = String(utmStatus).toLowerCase().trim();

    // å®Œæˆç‹€æ…‹
    if (['done', 'closed', 'report', 'completed'].includes(status)) {
        return 'Done';
    }

    // é€²è¡Œä¸­
    if (['in-progress', 'in progress', 'ongoing', 'active'].includes(status)) {
        return 'InProgress';
    }

    // é è¨­ç‚ºå¾…è¾¦
    return 'Todo';
}

/**
 * å°æ‡‰å„ªå…ˆç´š
 * UnifiedTaskManager: p0, p1, p2, p3 ç­‰
 * Project Tracker: High, Medium, Low
 */
function mapPriority(utmPriority) {
    if (!utmPriority) return 'Medium';

    const priority = String(utmPriority).toLowerCase().trim();

    // é«˜å„ªå…ˆç´š
    if (['p0', 'p1', 'high', 'critical', 'urgent'].includes(priority)) {
        return 'High';
    }

    // ä½å„ªå…ˆç´š
    if (['p3', 'p4', 'low'].includes(priority)) {
        return 'Low';
    }

    // é è¨­ä¸­å„ªå…ˆç´š
    return 'Medium';
}

/**
 * æ¬„ä½åç¨±æ˜ å°„è¡¨ - è™•ç†ä¸åŒçš„æ¬„ä½å‘½åæ…£ä¾‹
 */
const FIELD_ALIASES = {
    'ID': ['ID', 'id'],
    'Project': ['Project', 'project'],
    'Team': ['Team', 'team'],
    'Purpose': ['Purpose', 'purpose'],
    'Task': ['Task', 'task'],
    'PIC': ['PIC', 'pic', 'Owner', 'owner'],
    'Issue Date': ['Issue Date', 'Issue date', 'issue date', 'IssueDate'],
    'Start Date': ['Start Date', 'Start date', 'start date', 'StartDate'],
    'End Date': ['End Date', 'end date', 'Due Date', 'Due date', 'due date', 'DueDate'],
    'Status': ['Status', 'status'],
    'Priority': ['Priority', 'priority'],
    'Dependencies': ['Dependencies', 'dependencies', 'Dependency', 'dependency'],
    'Note': ['Note', 'note', 'Notes', 'notes'],
    'Verification': ['Verification', 'verification']
};

/**
 * å–å¾—æ¬„ä½å€¼ - è‡ªå‹•è™•ç†æ¬„ä½åç¨±è®Šé«”
 */
function getFieldValue(row, standardFieldName) {
    const aliases = FIELD_ALIASES[standardFieldName] || [standardFieldName];
    for (const alias of aliases) {
        if (row.hasOwnProperty(alias) && row[alias] !== undefined && row[alias] !== '') {
            return row[alias];
        }
    }
    return undefined;
}

/**
 * åˆ¤æ–·æ˜¯å¦ç‚ºé‡Œç¨‹ç¢‘
 * è¦å‰‡ï¼šå„ªå…ˆç´šç‚º p0/p1 æˆ–ä»»å‹™åç¨±åŒ…å«ç‰¹å®šé—œéµå­—
 */
function isCheckpoint(row) {
    const priority = String(getFieldValue(row, 'Priority') || '').toLowerCase();
    const task = String(getFieldValue(row, 'Task') || '').toLowerCase();
    const purpose = String(getFieldValue(row, 'Purpose') || '').toLowerCase();

    // P0/P1 è¦–ç‚ºé‡Œç¨‹ç¢‘
    if (['p0', 'p1'].includes(priority)) return true;

    // åŒ…å«é‡Œç¨‹ç¢‘é—œéµå­—
    const checkpointKeywords = ['milestone', 'é‡Œç¨‹ç¢‘', 'checkpoint', 'release', 'ç™¼å¸ƒ', 'review', 'å¯©æŸ¥'];
    return checkpointKeywords.some(keyword =>
        task.includes(keyword) || purpose.includes(keyword)
    );
}

/**
 * é©—è­‰å–®ç­†è³‡æ–™çš„å¿…å¡«æ¬„ä½
 */
function validateRow(row, rowIndex) {
    const errors = [];

    const id = getFieldValue(row, 'ID');
    const task = getFieldValue(row, 'Task');

    if (!id) {
        errors.push(`ç¬¬ ${rowIndex + 1} åˆ—ï¼šç¼ºå°‘ ID`);
    }

    if (!task) {
        errors.push(`ç¬¬ ${rowIndex + 1} åˆ— (ID: ${id})ï¼šç¼ºå°‘ Task`);
    }

    // End Date æ”¹ç‚ºé¸å¡« - å…è¨± TBD æˆ–æœªå®šç¾©æˆªæ­¢æ—¥æœŸçš„ä»»å‹™

    return errors;
}

/**
 * ä¸»è¦è½‰æ›å‡½æ•¸
 * å°‡ UnifiedTaskManager Excel è³‡æ–™è½‰æ›ç‚º Project Tracker æ ¼å¼
 * 
 * @param {Array} utmData - Excel è§£æå¾Œçš„ JSON è³‡æ–™
 * @returns {Object} { success: boolean, data: Array, errors: Array }
 */
function convertUTMToTracker(utmData) {
    if (!Array.isArray(utmData)) {
        return {
            success: false,
            data: [],
            errors: ['è¼¸å…¥è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼šå¿…é ˆæ˜¯é™£åˆ—']
        };
    }

    const convertedData = [];
    const allErrors = [];

    utmData.forEach((row, index) => {
        // é©—è­‰å¿…å¡«æ¬„ä½
        const validationErrors = validateRow(row, index);
        if (validationErrors.length > 0) {
            allErrors.push(...validationErrors);
            return; // è·³éç„¡æ•ˆè³‡æ–™åˆ—
        }

        try {
            // ä½¿ç”¨ getFieldValue å–å¾—æ¬„ä½å€¼,æ”¯æ´å¤šç¨®åç¨±æ ¼å¼
            // å¼·åˆ¶ä½¿ç”¨å…¨åŸŸç‰ˆæœ¬çš„ normalizeDateï¼ˆæ”¯æ´ Excel åºåˆ—è™Ÿï¼‰
            const rawEndDate = getFieldValue(row, 'End Date');
            const rawStartDate = getFieldValue(row, 'Start Date');

            console.log('[CONVERT] é–‹å§‹è½‰æ›ç¬¬', index + 1, 'åˆ—ï¼ŒåŸå§‹æ—¥æœŸ:', { rawEndDate, rawStartDate });
            console.log('[CONVERT] window.normalizeDate å­˜åœ¨?', typeof window.normalizeDate);

            const endDate = window.normalizeDate(rawEndDate);
            const startDate = window.normalizeDate(rawStartDate);

            // å¦‚æœæ²’æœ‰ endDate å’Œ startDate,ä½¿ç”¨ç©ºå­—ä¸²(å…è¨± TBD ä»»å‹™)
            const finalEndDate = endDate || '';
            const finalStartDate = startDate || endDate || '';

            const duration = (finalStartDate && finalEndDate) ? calculateDuration(finalStartDate, finalEndDate) : 0;

            const convertedRow = {
                // åŸºæœ¬æ¬„ä½å°æ‡‰
                id: Number(getFieldValue(row, 'ID')) || getFieldValue(row, 'ID'),
                team: getFieldValue(row, 'Team') || 'å…¶ä»–', // Excel çš„ Team æ¬„ä½ç›´æ¥æ˜ å°„åˆ° team
                category: getFieldValue(row, 'Category') || 'Unassigned',
                task: getFieldValue(row, 'Task') || '',
                owner: getFieldValue(row, 'PIC') || 'Unassigned',
                date: finalEndDate,
                status: mapStatus(getFieldValue(row, 'Status')),
                priority: mapPriority(getFieldValue(row, 'Priority')),
                duration: duration,
                isCheckpoint: isCheckpoint(row),
                dependency: getFieldValue(row, 'Dependencies') || '',
                notes: getFieldValue(row, 'Note') || '',

                // æ“´å……æ¬„ä½ï¼ˆä¿ç•™ UnifiedTaskManager ç‰¹æœ‰è³‡æ–™ï¼‰
                verification: getFieldValue(row, 'Verification') || '',
                issueDate: window.normalizeDate(getFieldValue(row, 'Issue Date')) || '',
                purpose: getFieldValue(row, 'Purpose') || '',
                startDate: finalStartDate
            };

            convertedData.push(convertedRow);

        } catch (error) {
            allErrors.push(`ç¬¬ ${index + 1} åˆ— (ID: ${getFieldValue(row, 'ID')})ï¼šè½‰æ›å¤±æ•— - ${error.message}`);
        }
    });

    return {
        success: allErrors.length === 0,
        data: convertedData,
        errors: allErrors,
        stats: {
            total: utmData.length,
            converted: convertedData.length,
            failed: utmData.length - convertedData.length
        }
    };
}

/**
 * åå‘è½‰æ›ï¼šProject Tracker æ ¼å¼è½‰å› UnifiedTaskManager æ ¼å¼
 * ç”¨æ–¼åŒ¯å‡º Excel æ™‚ä½¿ç”¨
 */
function convertTrackerToUTM(trackerData) {
    return trackerData.map(row => ({
        'ID': row.id,
        'Project': row.project,
        'Team': row.category,
        'Purpose': row.purpose || '',
        'Task': row.task,
        'PIC': row.owner,
        'Issue Date': row.issueDate || '',
        'Start Date': row.startDate || '',
        'End Date': row.date,
        'Status': row.status,
        'Priority': row.priority,
        'Dependencies': row.dependency || '',
        'Note': row.notes || '',
        'Verification': row.verification || ''
    }));
}

// å¦‚æœåœ¨ Node.js ç’°å¢ƒä¸­ï¼ŒåŒ¯å‡ºæ¨¡çµ„
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        convertUTMToTracker,
        convertTrackerToUTM,
        normalizeDate,
        calculateDuration,
        mapStatus,
        mapPriority
    };
}

</script>

    <!-- ç«‹å³è¦†å¯« normalizeDate å‡½æ•¸ä»¥ä¿®å¾© Excel æ—¥æœŸå•é¡Œ -->
    <script>
        // å¼·åˆ¶åˆªé™¤èˆŠç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (typeof normalizeDate !== 'undefined') {
            try {
                delete window.normalizeDate;
                // ä¹Ÿå˜—è©¦åˆªé™¤å…¨åŸŸä½œç”¨åŸŸä¸­çš„å®šç¾©
                if (typeof normalizeDate !== 'undefined') {
                    normalizeDate = undefined;
                }
            } catch (e) {
                console.warn('[FIX] ç„¡æ³•åˆªé™¤èˆŠ normalizeDate:', e);
            }
        }

        // å®šç¾©æ–°çš„ normalizeDate å‡½æ•¸ï¼ˆæ”¯æ´ Excel åºåˆ—è™Ÿ + ISO å­—ä¸²ï¼‰
        window.normalizeDate = function (dateInput) {
            if (!dateInput && dateInput !== 0) return '';

            // å·²ç¶“æ˜¯ YYYY-MM-DD æ ¼å¼
            if (typeof dateInput === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateInput)) {
                return dateInput;
            }

            try {
                let date;

                // è™•ç† Excel æ—¥æœŸåºåˆ—è™Ÿï¼ˆæ•¸å­—é¡å‹ï¼‰
                if (typeof dateInput === 'number') {
                    console.log('[FIX] è™•ç† Excel åºåˆ—è™Ÿ:', dateInput);
                    // Excel çš„æ—¥æœŸåºåˆ—è™ŸåŸºæº–æ˜¯ 1900-01-01
                    const excelEpoch = new Date(1899, 11, 30); // 1899-12-30
                    const milliseconds = dateInput * 86400000;
                    date = new Date(excelEpoch.getTime() + milliseconds);
                    console.log('[FIX] è½‰æ›çµæœ:', date.toISOString());
                } else if (typeof dateInput === 'string') {
                    // è™•ç† ISO å­—ä¸²ï¼ˆGoogle Sheetsï¼‰æˆ–å…¶ä»–æ—¥æœŸå­—ä¸²
                    console.log('[FIX] è™•ç†æ—¥æœŸå­—ä¸²:', dateInput);
                    date = new Date(dateInput);

                    // å¦‚æœæ˜¯ ISO å­—ä¸²æ ¼å¼ï¼ˆå«æ™‚å€ï¼‰ï¼Œéœ€è¦èª¿æ•´ç‚ºç•¶åœ°æ—¥æœŸ
                    if (/^\d{4}-\d{2}-\d{2}T/.test(dateInput)) {
                        // ISO å­—ä¸²åŒ…å«æ™‚é–“ï¼Œå¯èƒ½æœ‰æ™‚å€å•é¡Œ
                        // ä½¿ç”¨ UTC æ—¥æœŸéƒ¨åˆ†é¿å…æ™‚å€è½‰æ›
                        const utcDate = new Date(dateInput);
                        date = new Date(utcDate.getUTCFullYear(), utcDate.getUTCMonth(), utcDate.getUTCDate());
                        console.log('[FIX] ISO å­—ä¸²èª¿æ•´ç‚ºæœ¬åœ°æ—¥æœŸ:', date);
                    }
                } else {
                    // å…¶ä»–é¡å‹å˜—è©¦ç›´æ¥è§£æ
                    date = new Date(dateInput);
                }

                if (isNaN(date.getTime())) {
                    console.warn('[FIX] ç„¡æ³•è§£æ:', dateInput);
                    return '';
                }

                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const result = `${year}-${month}-${day}`;
                console.log('[FIX] æœ€çµ‚çµæœ:', result);
                return result;
            } catch (e) {
                console.error('[FIX] éŒ¯èª¤:', dateInput, e);
                return '';
            }
        };

        // å¼·åˆ¶è¨­ç½®ç‚ºå…¨åŸŸå‡½æ•¸ï¼ˆå¤šç¨®æ–¹å¼ç¢ºä¿ç”Ÿæ•ˆï¼‰
        if (typeof window !== 'undefined') {
            window.normalizeDate = window.normalizeDate;
        }
        if (typeof global !== 'undefined') {
            global.normalizeDate = window.normalizeDate;
        }
        // ç›´æ¥è³¦å€¼åˆ°å…¨åŸŸä½œç”¨åŸŸ
        normalizeDate = window.normalizeDate;

        console.log('[FIX] normalizeDate å·²å¼·åˆ¶è¦†å¯«ï¼Œæ¸¬è©¦:', normalizeDate(45672));
    </script>

    <style>
        /* ... æ‰€æœ‰æ¨£å¼ä¿æŒä¸è®Š ... */
        /* (å¾åŸå§‹ index.html è¤‡è£½ 124-448 è¡Œçš„æ¨£å¼) */
    </style>
</head>

<body>
    <div id="root"></div>

    <script>
/**
 * é…ç½®æª”æ¡ˆ
 * config.js
 */

// API é…ç½®
const API_URL = "https://script.google.com/macros/s/AKfycbxXrSwPBhGcyGhWc8Q4zAeCcugafQhunMX7tWAZHA73gUUzBiRIp95s2ZfWAV4ppkJK/exec";

// ğŸ” API Key é©—è­‰ï¼ˆå‹•æ…‹å¾ localStorage è®€å–ï¼‰
// ç”¨æˆ¶ç™»å…¥å¾Œæœƒå„²å­˜åˆ° localStorage
const getApiKey = () => {
    return localStorage.getItem('apiKey') || '';
};

// ç‚ºäº†å‘å¾Œç›¸å®¹ï¼Œä¿ç•™ API_KEY è®Šæ•¸
const API_KEY = getApiKey();

// ğŸ” æ¬Šé™æª¢æŸ¥å·¥å…·å‡½æ•¸
const API_KEY_PERMISSIONS = {
    'cytesi-admin-2025-Q1': 'admin',
    'cytesi-editor-2025-Q1': 'editor',
    'cytesi-viewer-2025-Q1': 'viewer'
};

/**
 * ç²å–ç•¶å‰ç”¨æˆ¶çš„æ¬Šé™å±¤ç´š
 * @returns {string} 'admin' | 'editor' | 'viewer' | 'guest'
 */
const getUserPermission = () => {
    const apiKey = getApiKey();
    return API_KEY_PERMISSIONS[apiKey] || 'guest';
};

/**
 * æª¢æŸ¥æ˜¯å¦æ»¿è¶³æ‰€éœ€æ¬Šé™
 * @param {string} requiredPermission - æ‰€éœ€æ¬Šé™å±¤ç´š
 * @returns {boolean}
 */
const hasPermission = (requiredPermission) => {
    const hierarchy = {
        'admin': 3,
        'editor': 2,
        'viewer': 1,
        'guest': 0
    };

    const userPermission = getUserPermission();
    const required = hierarchy[requiredPermission] || 0;
    const current = hierarchy[userPermission] || 0;

    return current >= required;
};




// å¸¸æ•¸
const PX_PER_DAY = 40;
const ROW_HEIGHT = 40;

// é è¨­è³‡æ–™ (Fallback)
const TEAMS = ['æ™¶ç‰‡', 'æ©Ÿæ§‹', 'è»Ÿé«”', 'é›»æ§', 'æµé“', 'ç”Ÿé†«', 'QA', 'ç®¡ç†', 'issue'];
const PROJECTS = ['CKSX', 'Jamstec', 'Genentech', '5880 Chip', 'Internal', 'TBD', 'Other'];
const OWNERS = ['Anting', 'James', 'Weber', 'Allen', 'Yoyo', 'Dean']; // é è¨­åå–®ï¼Œæœƒè¢« API è¦†è“‹

const CATEGORIES = ['Mechanism', 'Electrical', 'Software', 'QA', 'Design', 'Flow'];

// åˆå§‹è³‡æ–™ï¼ˆå¯é¸ï¼‰
const INITIAL_DATA = [];

</script>
    <script type="text/babel">
/**
 * Icons å®šç¾©
 * icons.js
 */

const Icon = ({ path, size = 18, color = "currentColor", onClick, className = "" }) => (
    <svg onClick={onClick} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={{ cursor: onClick ? 'pointer' : 'default' }}>
        {path}
    </svg>
);

const paths = {
    flag: <React.Fragment><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z" /><line x1="4" y1="22" x2="4" y2="15" /></React.Fragment>,
    clock: <React.Fragment><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></React.Fragment>,
    calendar: <React.Fragment><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></React.Fragment>,
    list: <React.Fragment><line x1="8" y1="6" x2="21" y2="6" /><line x1="8" y1="12" x2="21" y2="12" /><line x1="8" y1="18" x2="21" y2="18" /><line x1="3" y1="6" x2="3.01" y2="6" /><line x1="3" y1="12" x2="3.01" y2="12" /><line x1="3" y1="18" x2="3.01" y2="18" /></React.Fragment>,
    plus: <React.Fragment><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></React.Fragment>,
    trash: <React.Fragment><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></React.Fragment>,
    edit: <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />,
    x: <React.Fragment><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></React.Fragment>,
    alert: <React.Fragment><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></React.Fragment>,
    check: <React.Fragment><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></React.Fragment>,
    timer: <React.Fragment><line x1="10" y1="2" x2="14" y2="2" /><line x1="12" y1="14" x2="15" y2="11" /><circle cx="12" cy="14" r="8" /></React.Fragment>,
    left: <polyline points="15 18 9 12 15 6" />,
    right: <polyline points="9 18 15 12 9 6" />,
    file: <React.Fragment><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><polyline points="10 9 9 9 8 9" /></React.Fragment>,
    link: <React.Fragment><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" /><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" /></React.Fragment>,
    gantt: <React.Fragment><path d="M12 2v20" /><path d="M2 6h20" /><path d="M6 10h8" /><path d="M4 14h12" /><path d="M8 18h10" /></React.Fragment>,
    settings: <React.Fragment><circle cx="12" cy="12" r="3" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" /></React.Fragment>,
    search: <React.Fragment><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /></React.Fragment>
};

window.Icon = Icon;
window.paths = paths;

</script>
    <script type="text/babel">
/**
 * Helper Functions
 * è¼”åŠ©å‡½æ•¸é›†åˆ
 */

// å–å¾— Team é¡è‰²
const getTeamColor = (team) => {
    const colors = {
        'æ™¶ç‰‡': '#3b82f6',      // blue
        'æ©Ÿæ§‹': '#8b5cf6',      // purple
        'è»Ÿé«”': '#10b981',      // emerald
        'é›»æ§': '#f59e0b',      // amber
        'æµé“': '#06b6d4',      // cyan
        'ç”Ÿé†«': '#ec4899',      // pink
        'QA': '#6366f1',        // indigo
        'ç®¡ç†': '#84cc16',      // lime
        'issue': '#ef4444'      // red
    };
    return colors[team] || '#64748b'; // slate as default
};

// å–å¾—å°ˆæ¡ˆé¡è‰²
const getProjectColor = (project) => {
    const colorMap = {
        'CKSX': 'bg-blue-100 text-blue-700 border-blue-200',
        'Jamstec': 'bg-purple-100 text-purple-700 border-purple-200',
        'Genentech': 'bg-emerald-100 text-emerald-700 border-emerald-200',
        '5880 Chip': 'bg-amber-100 text-amber-700 border-amber-200',
        'Internal': 'bg-cyan-100 text-cyan-700 border-cyan-200',
        'TBD': 'bg-slate-100 text-slate-600 border-slate-200',
        'Other': 'bg-pink-100 text-pink-700 border-pink-200'
    };
    return colorMap[project] || 'bg-slate-100 text-slate-600 border-slate-200';
};
const getTeamBadgeClass = (team) => {
    const classes = {
        'æ™¶ç‰‡': 'text-blue-600 border-blue-200 bg-blue-50',
        'æ©Ÿæ§‹': 'text-purple-600 border-purple-200 bg-purple-50',
        'è»Ÿé«”': 'text-emerald-600 border-emerald-200 bg-emerald-50',
        'é›»æ§': 'text-amber-600 border-amber-200 bg-amber-50',
        'æµé“': 'text-cyan-600 border-cyan-200 bg-cyan-50',
        'ç”Ÿé†«': 'text-pink-600 border-pink-200 bg-pink-50',
        'QA': 'text-indigo-600 border-indigo-200 bg-indigo-50',
        'ç®¡ç†': 'text-lime-600 border-lime-200 bg-lime-50',
        'issue': 'text-red-600 border-red-200 bg-red-50'
    };
    return classes[team] || 'text-slate-600 border-slate-200 bg-slate-50';
};


// å–å¾—å°ç£ç•¶å¤©æ—¥æœŸ
const getTaiwanToday = () => new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Taipei' });

// è¨ˆç®—é–‹å§‹æ—¥æœŸ
const getStartDate = (endDateStr, duration) => {
    if (!duration || !endDateStr) return '';
    try {
        const end = new Date(endDateStr);
        const start = new Date(end);
        start.setDate(end.getDate() - duration);
        return start.toLocaleDateString('en-CA', { timeZone: 'Asia/Taipei' });
    } catch (e) { return ''; }
};

// è§£æç›¸ä¾æ€§å­—ä¸²ç‚ºé™£åˆ—
const parseDependencies = (depStr) => {
    if (!depStr || typeof depStr !== 'string') return [];
    return depStr.split(',').map(id => id.trim()).filter(id => id);
};

// é©—è­‰ç›¸ä¾æ€§æ ¼å¼èˆ‡æœ‰æ•ˆæ€§
const validateDependencies = (depStr, currentTaskId, allTasks) => {
    const errors = [];
    if (!depStr || !depStr.trim()) return errors;

    const depIds = parseDependencies(depStr);

    // é™åˆ¶æœ€å¤§ç›¸ä¾æ•¸é‡
    if (depIds.length > 10) {
        errors.push('âš ï¸ ç›¸ä¾æ€§æ•¸é‡ä¸å¯è¶…é 10 å€‹');
        return errors;
    }

    for (const depId of depIds) {
        // æª¢æŸ¥æ ¼å¼ï¼ˆå¿…é ˆæ˜¯æ•¸å­—ï¼‰
        if (isNaN(depId) || depId.includes('.')) {
            errors.push(`âŒ ç›¸ä¾æ€§ ID "${depId}" æ ¼å¼ä¸æ­£ç¢ºï¼ˆå¿…é ˆæ˜¯æ•´æ•¸ï¼‰`);
            continue;
        }

        // æª¢æŸ¥æ˜¯å¦ç›¸ä¾è‡ªå·±
        if (String(depId) === String(currentTaskId)) {
            errors.push(`âŒ ä»»å‹™ä¸èƒ½ç›¸ä¾è‡ªå·± (ID: ${depId})`);
            continue;
        }

        // æª¢æŸ¥ç›¸ä¾çš„ä»»å‹™æ˜¯å¦å­˜åœ¨
        const depTask = allTasks.find(t => String(t.id) === String(depId));
        if (!depTask) {
            errors.push(`âš ï¸ æ‰¾ä¸åˆ°ç›¸ä¾ä»»å‹™ ID: ${depId}`);
        }
    }

    return errors;
};

// é©—è­‰ä»»å‹™
const validateTask = (task) => {
    const errors = [];

    // ä»»å‹™åç¨±é©—è­‰
    if (!task.task?.trim()) {
        errors.push('âŒ ä»»å‹™åç¨±ä¸èƒ½ç‚ºç©º');
    } else if (task.task.length > 100) {
        errors.push('âŒ ä»»å‹™åç¨±ä¸èƒ½è¶…é100å­—å…ƒ');
    }

    // æ—¥æœŸé©—è­‰
    // å‡è¨­ normalizeDate æ˜¯å…¨åŸŸå‡½æ•¸ï¼Œå¦‚æœä¸æ˜¯ï¼Œéœ€è¦åœ¨æ­¤æª”æ¡ˆå®šç¾©æˆ–å‚³å…¥
    // index.html å®šç¾©äº† window.normalizeDateï¼Œæ‰€ä»¥é€™è£¡æ˜¯å¯ç”¨çš„
    const normalizedDate = typeof window !== 'undefined' && window.normalizeDate ? window.normalizeDate(task.date) : task.date;

    if (!task.date || !normalizedDate) {
        errors.push('âŒ å®Œæˆæ—¥æœŸæ ¼å¼ä¸æ­£ç¢º');
    } else {
        const taskDate = new Date(normalizedDate);
        const startDate = new Date(getStartDate(normalizedDate, task.duration));

        if (startDate > taskDate) {
            errors.push('âš ï¸ é–‹å§‹æ—¥æœŸæ™šæ–¼å®Œæˆæ—¥æœŸï¼Œè«‹ç¢ºèªå·¥æ™‚è¨­å®š');
        }

        // æª¢æŸ¥æ—¥æœŸæ˜¯å¦åœ¨åˆç†ç¯„åœå…§ï¼ˆéå»5å¹´åˆ°æœªä¾†5å¹´ï¼‰
        const fiveYearsAgo = new Date();
        fiveYearsAgo.setFullYear(fiveYearsAgo.getFullYear() - 5);
        const fiveYearsLater = new Date();
        fiveYearsLater.setFullYear(fiveYearsLater.getFullYear() + 5);

        if (taskDate < fiveYearsAgo || taskDate > fiveYearsLater) {
            errors.push('âš ï¸ æ—¥æœŸè¶…å‡ºåˆç†ç¯„åœï¼ˆ5å¹´å…§ï¼‰');
        }
    }

    // å·¥æ™‚é©—è­‰
    if (task.duration < 0) {
        errors.push('âŒ å·¥æ™‚ä¸èƒ½ç‚ºè² æ•¸');
    } else if (task.duration > 365) {
        errors.push('âš ï¸ å·¥æ™‚è¶…é365å¤©ï¼Œè«‹ç¢ºèªæ˜¯å¦æ­£ç¢º');
    }

    // è² è²¬äººé©—è­‰
    if (!task.owner?.trim()) {
        errors.push('âŒ è² è²¬äººä¸èƒ½ç‚ºç©º');
    }

    return errors;
};

// å¾ªç’°ç›¸ä¾æ€§æª¢æŸ¥
const detectCircularDependency = (taskId, dependencyStr, currentTasks) => {
    const depIds = parseDependencies(dependencyStr);
    if (depIds.length === 0) return false;

    // ä½¿ç”¨ BFS æª¢æŸ¥æ¯å€‹ç›¸ä¾æ€§éˆ
    for (const depId of depIds) {
        const visited = new Set();
        const queue = [depId];
        let depth = 0;

        while (queue.length > 0 && depth < 100) {
            const current = queue.shift();

            // æª¢æŸ¥æ˜¯å¦å½¢æˆå¾ªç’°
            if (String(current) === String(taskId)) return true;

            // é¿å…é‡è¤‡è¨ªå•
            if (visited.has(current)) continue;
            visited.add(current);

            // æ‰¾åˆ°ç•¶å‰ä»»å‹™çš„æ‰€æœ‰ç›¸ä¾æ€§
            const parent = currentTasks.find(t => String(t.id) === String(current));
            if (parent?.dependency) {
                const parentDeps = parseDependencies(parent.dependency);
                queue.push(...parentDeps);
            }

            depth++;
        }
    }
    return false;
};

// å–å¾—ç‹€æ…‹å¾½ç« 
const getStatusBadge = (t, todayStr) => {
    // è‹¥æœªå‚³å…¥ todayStrï¼Œå˜—è©¦ç²å–
    if (!todayStr) todayStr = getTaiwanToday();

    // å¦‚æœæ˜¯ JSXï¼Œå› ç‚º helpers.js æ˜¯ç´” JSï¼Œä¸èƒ½ç›´æ¥å¯« JSXï¼Œé™¤éä½¿ç”¨ Babel ç·¨è­¯
    // é€™è£¡æˆ‘å€‘å‡è¨­ä½¿ç”¨ React.createElement æˆ–è¿”å›ç‰©ä»¶çµæ§‹ä¾›çµ„ä»¶ä½¿ç”¨
    // ä½†ç‚ºäº†æ–¹ä¾¿ï¼Œæˆ‘å€‘å‡è¨­ helpers.js ä¹Ÿæœƒè¢« Babel è™•ç†
    // å¦‚æœä¸è¡Œçš„è©±ï¼Œé€™äº›å‡½æ•¸æ‡‰è©²ä¿ç•™åœ¨çµ„ä»¶å…§æˆ– index.html
    // æ—¢ç„¶ index.html æœ‰ babelï¼Œå®ƒå¼•å…¥ helpers.js (type="text/babel") æ‡‰è©²æ²’å•é¡Œ

    if (t.date < todayStr && t.status !== 'Done') return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-red-100 text-red-700 border border-red-200">â›” é€¾æœŸ</span>;
    const startDate = getStartDate(t.date, t.duration);
    if (t.status === 'Todo' && startDate <= todayStr) return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-yellow-100 text-yellow-700 border border-yellow-200">âš ï¸ æ‡‰é–‹å·¥</span>;
    switch (t.status) {
        case 'Todo': return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-slate-100 text-slate-600">å¾…è¾¦</span>;
        case 'InProgress': return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-blue-100 text-blue-700 border border-blue-200">é€²è¡Œä¸­</span>;
        case 'Done': return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-green-100 text-green-700 border border-green-200">å®Œæˆ</span>;
        case 'Delayed': return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-orange-100 text-orange-700 border border-orange-200">å»¶èª¤</span>;
        default: return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-gray-100 text-gray-600">{t.status}</span>;
    }
};

// å–å¾—è¡Œé«˜äº®æ¨£å¼
const getRowHighlight = (task, highlightUrgent, todayStr) => {
    if (!highlightUrgent) return '';
    if (!todayStr) todayStr = getTaiwanToday();

    // å·²å®Œæˆçš„ä»»å‹™ä¸é«˜äº®
    if (task.status === 'Done') return '';

    // å»¶é²ä»»å‹™ï¼ˆæœ€é«˜å„ªå…ˆï¼‰- åŒ…å« status ç‚º Delayed æˆ–å®Œæˆæ—¥æœŸå·²é
    const isOverdue = task.date < todayStr;
    if (task.status === 'Delayed' || (task.status !== 'Done' && isOverdue)) {
        return 'bg-red-50 border-l-4 border-red-500';
    }

    // æ‡‰é–‹å·¥æœªå‹•
    const startDate = getStartDate(task.date, task.duration);
    if (task.status === 'Todo' && startDate <= todayStr && task.date >= todayStr) {
        return 'bg-yellow-50 border-l-4 border-yellow-500';
    }

    return '';
};

// ========================================
// ğŸŒ Global Export (è®“å…¶ä»–æª”æ¡ˆå¯ä»¥ä½¿ç”¨é€™äº›å‡½æ•¸)
// ========================================
// å› ç‚ºä½¿ç”¨ Babel è¼‰å…¥ï¼Œconst è²æ˜æ˜¯æ¨¡çµ„ä½œç”¨åŸŸ
// éœ€è¦æ˜ç¢ºé™„åŠ åˆ° window æ‰èƒ½è·¨æª”æ¡ˆè¨ªå•

window.getTeamColor = getTeamColor;
window.getProjectColor = getProjectColor;
window.getTeamBadgeClass = getTeamBadgeClass;
window.getTaiwanToday = getTaiwanToday;
window.getStartDate = getStartDate;
window.parseDependencies = parseDependencies;
window.validateDependencies = validateDependencies;
window.validateTask = validateTask;
window.detectCircularDependency = detectCircularDependency;
window.getStatusBadge = getStatusBadge;
window.getRowHighlight = getRowHighlight;



</script>
    <script type="text/babel">
/**
 * LoginScreen çµ„ä»¶
 * ç”¨æ–¼ API Key é©—è­‰çš„ç™»å…¥ç•«é¢
 */

const LoginScreen = ({ onLogin }) => {
    const [inputKey, setInputKey] = React.useState('');
    const [error, setError] = React.useState('');
    const [isLoading, setIsLoading] = React.useState(false);

    const handleSubmit = async (e) => {
        e.preventDefault();

        if (!inputKey.trim()) {
            setError('è«‹è¼¸å…¥è¨ªå•å¯†é‘°');
            return;
        }

        setIsLoading(true);
        setError('');

        try {
            // é©—è­‰ API Keyï¼ˆé€šéç™¼é€æ¸¬è©¦è«‹æ±‚ï¼‰
            const response = await fetch(`${API_URL}?action=ping`);
            const result = await response.json();

            if (result.success) {
                // API Key æ ¼å¼é©—è­‰
                const validKeys = [
                    'cytesi-admin-2025-Q1',
                    'cytesi-editor-2025-Q1',
                    'cytesi-viewer-2025-Q1'
                ];

                if (validKeys.includes(inputKey.trim())) {
                    // å„²å­˜åˆ° localStorage
                    localStorage.setItem('apiKey', inputKey.trim());
                    onLogin(inputKey.trim());
                } else {
                    setError('ç„¡æ•ˆçš„è¨ªå•å¯†é‘°ï¼Œè«‹æª¢æŸ¥å¾Œé‡è©¦');
                }
            } else {
                setError('ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨ï¼Œè«‹ç¨å¾Œé‡è©¦');
            }
        } catch (err) {
            console.error('ç™»å…¥éŒ¯èª¤:', err);
            setError('é©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 p-4">
            {/* èƒŒæ™¯è£é£¾ */}
            <div className="absolute inset-0 overflow-hidden">
                <div className="absolute -top-40 -right-40 w-80 h-80 bg-white/10 rounded-full blur-3xl"></div>
                <div className="absolute -bottom-40 -left-40 w-80 h-80 bg-white/10 rounded-full blur-3xl"></div>
            </div>

            {/* ç™»å…¥å¡ç‰‡ */}
            <div className="relative bg-white/95 backdrop-blur-xl p-8 rounded-2xl shadow-2xl max-w-md w-full border border-white/20">
                {/* Logo å€åŸŸ */}
                <div className="text-center mb-8">
                    <div className="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-2xl mb-4 shadow-lg">
                        <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                    </div>
                    <h1 className="text-3xl font-bold text-slate-800 mb-2">Project Tracker</h1>
                    <p className="text-slate-600 text-sm">è«‹è¼¸å…¥è¨ªå•å¯†é‘°ä»¥ç¹¼çºŒ</p>
                </div>

                {/* è¡¨å–® */}
                <form onSubmit={handleSubmit} className="space-y-6">
                    {/* è¼¸å…¥æ¡† */}
                    <div>
                        <label htmlFor="apiKey" className="block text-sm font-medium text-slate-700 mb-2">
                            è¨ªå•å¯†é‘°
                        </label>
                        <input
                            id="apiKey"
                            type="password"
                            value={inputKey}
                            onChange={(e) => {
                                setInputKey(e.target.value);
                                setError('');
                            }}
                            placeholder="è«‹è¼¸å…¥æ‚¨çš„ API Key"
                            className="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 outline-none transition-all text-slate-800 placeholder-slate-400"
                            disabled={isLoading}
                            autoFocus
                        />
                    </div>

                    {/* éŒ¯èª¤è¨Šæ¯ */}
                    {error && (
                        <div className="flex items-center gap-2 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm animate-shake">
                            <svg className="w-5 h-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                            </svg>
                            <span>{error}</span>
                        </div>
                    )}

                    {/* ç™»å…¥æŒ‰éˆ• */}
                    <button
                        type="submit"
                        disabled={isLoading}
                        className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 px-6 rounded-xl font-medium hover:from-indigo-700 hover:to-purple-700 focus:ring-4 focus:ring-indigo-100 transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                    >
                        {isLoading ? (
                            <>
                                <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                                <span>é©—è­‰ä¸­...</span>
                            </>
                        ) : (
                            <>
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                                </svg>
                                <span>ç™»å…¥</span>
                            </>
                        )}
                    </button>
                </form>

                {/* æç¤ºè¨Šæ¯ */}
                <div className="mt-6 p-4 bg-slate-50 border border-slate-200 rounded-xl">
                    <p className="text-xs text-slate-600 text-center">
                        <span className="font-medium">æç¤ºï¼š</span> å¦‚éœ€è¨ªå•æ¬Šé™ï¼Œè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡ç²å– API Key
                    </p>
                </div>

                {/* ç‰ˆæœ¬è³‡è¨Š */}
                <div className="mt-4 text-center text-xs text-slate-400">
                    v6.9 | Powered by CyteSi
                </div>
            </div>

            {/* CSS å‹•ç•« */}
            <style>{`
                @keyframes shake {
                    0%, 100% { transform: translateX(0); }
                    25% { transform: translateX(-8px); }
                    75% { transform: translateX(8px); }
                }
                .animate-shake {
                    animation: shake 0.4s ease-in-out;
                }
            `}</style>
        </div>
    );
};

window.LoginScreen = LoginScreen;

</script>
    <script type="text/babel">
// GanttView Component
// éœ€ç¢ºä¿å¼•å…¥: React, Recharts(é›–ç„¶æ­¤çµ„ä»¶æ²’ç”¨), helpers.js, icons.js
// Props: tasks, ganttFilterTeam, searchQuery, setGanttFilterTeam, setEditingTask, setIsModalOpen, setViewMode, isMobile, todayStr, showDependencies, setShowDependencies (if managed externally, but here it manages its own state for showDependencies unless lifted) 

// Note: In original code, showDependencies was state in App? 
// Let's check App: line 573: const [showDependencies, setShowDependencies] = useState(false);
// So it is passed as props or context.
// In the original GanttView definition in index.html, it used showDependencies from App scope.
// So I must add showDependencies and setShowDependencies to props.

const GanttView = () => {
    const {
        tasks = [],
        ganttFilterTeam = 'All',
        searchQuery = '',
        setGanttFilterTeam,
        setEditingTask,
        setIsModalOpen,
        setViewMode,
        isMobile,
        todayStr,
        showDependencies,
        setShowDependencies,
        TEAMS = []
    } = useAppContext();

    // Constants
    const PX_PER_DAY = 40;
    const ROW_HEIGHT = 40;
    const { useState, useEffect, useMemo, useRef } = React;

    const { sortedTasks, minDate, totalDays } = useMemo(() => {
        // å…ˆä¾æ“š Team ç¯©é¸
        let ganttTasks = tasks.filter(t => ganttFilterTeam === 'All' || (t.team && t.team === ganttFilterTeam));

        // å†ä¾æ“šæœå°‹æ¢ä»¶ç¯©é¸ï¼ˆæ”¯æ´å‰ç¶´è©æœå°‹ï¼‰
        if (searchQuery.trim()) {
            const query = searchQuery.trim();

            // æª¢æŸ¥æ˜¯å¦ä½¿ç”¨å‰ç¶´è©æœå°‹ (ä¾‹å¦‚: "project:Genentech" æˆ– "pic:James")
            const prefixMatch = query.match(/^(project|owner|pic|team|task|note):(.*)/i);

            if (prefixMatch) {
                // å‰ç¶´è©æœå°‹æ¨¡å¼
                const field = prefixMatch[1].toLowerCase();
                const searchValue = prefixMatch[2].toLowerCase();

                ganttTasks = ganttTasks.filter(t => {
                    switch (field) {
                        case 'project':
                            return t.project && String(t.project).toLowerCase().includes(searchValue);
                        case 'owner':
                        case 'pic':
                            return t.owner && String(t.owner).toLowerCase().includes(searchValue);
                        case 'team':
                            return t.team && String(t.team).toLowerCase().includes(searchValue);
                        case 'task':
                            return t.task && String(t.task).toLowerCase().includes(searchValue);
                        case 'note':
                            return t.notes && String(t.notes).toLowerCase().includes(searchValue);
                        default:
                            return false;
                    }
                });
            } else {
                // ä¸€èˆ¬æœå°‹æ¨¡å¼ï¼ˆæœå°‹æ‰€æœ‰æ¬„ä½ï¼‰
                const lowerQuery = query.toLowerCase();
                ganttTasks = ganttTasks.filter(t => {
                    const matchTask = t.task && String(t.task).toLowerCase().includes(lowerQuery);
                    const matchOwner = t.owner && String(t.owner).toLowerCase().includes(lowerQuery);
                    const matchTeam = t.team && String(t.team).toLowerCase().includes(lowerQuery);
                    const matchProject = t.project && String(t.project).toLowerCase().includes(lowerQuery);
                    const matchNotes = t.notes && String(t.notes).toLowerCase().includes(lowerQuery);
                    return matchTask || matchOwner || matchTeam || matchProject || matchNotes;
                });
            }
        }

        const sorted = ganttTasks.sort((a, b) => new Date(getStartDate(a.date, a.duration)) - new Date(getStartDate(b.date, b.duration)));
        let min = new Date();
        let max = new Date();
        if (sorted.length > 0) {
            const dates = sorted.flatMap(t => [new Date(getStartDate(t.date, t.duration)), new Date(t.date)]);
            min = new Date(Math.min(...dates));
            max = new Date(Math.max(...dates));
        }
        min.setDate(min.getDate() - 5);
        max.setDate(max.getDate() + 15);
        const days = Math.ceil((max - min) / (1000 * 60 * 60 * 24));
        return { sortedTasks: sorted, minDate: min, totalDays: days };
    }, [tasks, ganttFilterTeam, searchQuery]);

    const getLeftPos = (dStr) => {
        const d = new Date(dStr);
        const diff = Math.ceil((d - minDate) / (1000 * 60 * 60 * 24));
        return diff * PX_PER_DAY;
    };

    const todayPos = getLeftPos(todayStr);

    const drawDependencies = () => {
        if (!showDependencies) return null;
        const lines = [];

        sortedTasks.forEach((task, taskIndex) => {
            if (!task.dependency) return;

            // è§£æå¤šå€‹ç›¸ä¾æ€§
            const depIds = parseDependencies(task.dependency);

            depIds.forEach(depId => {
                const parent = sortedTasks.find(p => String(p.id) === String(depId));
                const parentIndex = sortedTasks.indexOf(parent);
                if (!parent || parentIndex === -1) return;

                const parentStartStr = getStartDate(parent.date, parent.duration);
                const parentX = getLeftPos(parentStartStr) + (parent.duration * PX_PER_DAY);
                const parentY = parentIndex * ROW_HEIGHT + 20;
                const childStartStr = getStartDate(task.date, task.duration);
                const childX = getLeftPos(childStartStr);
                const childY = taskIndex * ROW_HEIGHT + 20;

                const path = `M ${parentX} ${parentY} C ${parentX + 20} ${parentY}, ${childX - 20} ${childY}, ${childX} ${childY}`;
                lines.push(
                    <path key={`${parent.id}-${task.id}`} d={path} stroke="#94a3b8" strokeWidth="1.5" fill="none" markerEnd="url(#arrowhead)" />
                );
            });
        });

        return lines;
    };

    // Group days by month for the month header
    const monthHeaders = useMemo(() => {
        const headers = [];
        let currentMonth = -1;
        let monthStartDay = 0;

        for (let i = 0; i < totalDays; i++) {
            const d = new Date(minDate);
            d.setDate(d.getDate() + i);
            const month = d.getMonth();

            if (month !== currentMonth) {
                if (currentMonth !== -1) {
                    headers.push({
                        month: currentMonth,
                        year: new Date(minDate.getTime() + (monthStartDay * 24 * 60 * 60 * 1000)).getFullYear(),
                        startDay: monthStartDay,
                        daysCount: i - monthStartDay
                    });
                }
                currentMonth = month;
                monthStartDay = i;
            }
        }
        // Add last month segment
        headers.push({
            month: currentMonth,
            year: new Date(minDate.getTime() + (monthStartDay * 24 * 60 * 60 * 1000)).getFullYear(),
            startDay: monthStartDay,
            daysCount: totalDays - monthStartDay
        });

        return headers;
    }, [minDate, totalDays]);

    // Grid lines for timeline
    const gridLines = Array.from({ length: totalDays }).map((_, i) => (
        <div key={i} className={`gantt-grid-col ${i % 7 === 0 || i % 7 === 6 ? 'bg-slate-50' : ''}`} style={{ width: `${PX_PER_DAY}px` }}></div>
    ));

    // Timeline day header cells
    const timelineDayHeaders = Array.from({ length: totalDays }).map((_, i) => {
        const d = new Date(minDate);
        d.setDate(d.getDate() + i);
        return <div key={i} className={`gantt-day-cell ${d.getDay() === 0 || d.getDay() === 6 ? 'is-weekend' : ''}`} style={{ width: `${PX_PER_DAY}px` }}>{d.getDate()}</div>
    });

    // åŒæ­¥æ»¾å‹• refs
    const headerRef = useRef(null);
    const bodyRef = useRef(null);

    // åŒæ­¥æ°´å¹³æ»¾å‹•
    useEffect(() => {
        const bodyEl = bodyRef.current;
        const headerEl = headerRef.current;

        if (!bodyEl || !headerEl) return;

        const handleBodyScroll = () => {
            if (headerEl) {
                headerEl.scrollLeft = bodyEl.scrollLeft;
            }
        };

        bodyEl.addEventListener('scroll', handleBodyScroll);
        return () => bodyEl.removeEventListener('scroll', handleBodyScroll);
    }, []);

    // è¡Œå‹•ç‰ˆå‹å–„æç¤º
    if (isMobile) {
        return (
            <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden p-8 text-center">
                <div className="text-6xl mb-4">ğŸ“±</div>
                <h3 className="text-xl font-bold text-slate-800 mb-2">å»ºè­°ä½¿ç”¨æ¡Œé¢ç‰ˆç€è¦½</h3>
                <p className="text-slate-600 mb-4">
                    ç”˜ç‰¹åœ–åœ¨å¤§è¢å¹•ä¸Šæœ‰æ›´å¥½çš„ä½¿ç”¨é«”é©—ã€‚<br />
                    å»ºè­°æ‚¨åœ¨æ¡Œä¸Šå‹é›»è…¦æˆ–å¹³æ¿æ©«å‘æ¨¡å¼ä¸‹æŸ¥çœ‹ã€‚
                </p>
                <button
                    onClick={() => setViewMode('dashboard')}
                    className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors"
                >
                    è¿”å›åˆ—è¡¨è¦–åœ–
                </button>
            </div>
        );
    }

    return (
        <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col h-[600px]">
            <div className="p-4 border-b bg-slate-50 flex justify-between items-center">
                <h3 className="font-bold text-slate-700">å°ˆæ¡ˆç”˜ç‰¹åœ– (Gantt)</h3>
                <div className="flex items-center gap-4">
                    <div className="flex items-center gap-2 text-xs text-slate-600 bg-white px-2 py-1 rounded border shadow-sm">
                        <input type="checkbox" id="toggleDeps" checked={showDependencies} onChange={(e) => setShowDependencies(e.target.checked)} className="rounded text-indigo-600 focus:ring-indigo-500" />
                        <label htmlFor="toggleDeps" className="cursor-pointer select-none">é¡¯ç¤ºé€£ç·š (Beta)</label>
                    </div>
                    <div className="flex gap-2 flex-wrap">
                        {console.log('ğŸ“Š Gantt TEAMS:', TEAMS) || TEAMS.map(t => (
                            <button
                                key={t}
                                onClick={() => {
                                    console.log('ğŸ”˜ é»æ“Š Team:', t, 'ç›®å‰ç¯©é¸:', ganttFilterTeam);
                                    setGanttFilterTeam(prev => prev === t ? 'All' : t);
                                }}
                                className={`px-3 py-1.5 rounded-md text-xs font-medium transition-colors cursor-pointer whitespace-nowrap ${ganttFilterTeam === 'All' || ganttFilterTeam === t
                                    ? 'bg-indigo-600 text-white shadow-md'
                                    : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                    }`}
                            >
                                {t || '(ç„¡åç¨±)'}
                            </button>
                        ))}
                    </div>
                </div>
            </div>

            <div className="gantt-wrapper">
                {/* Header Row */}
                <div className="gantt-header-row" ref={headerRef} style={{ overflowX: 'hidden' }}>
                    <div className="gantt-header-wrapper">
                        <div className="gantt-header-task">ä»»å‹™åç¨±</div>
                        <div className="gantt-header-timeline" style={{ width: `${totalDays * PX_PER_DAY}px` }}>
                            <div className="gantt-header-month-row">
                                {monthHeaders.map((m, idx) => (
                                    <div key={idx} className={`gantt-month-cell ${idx % 2 === 0 ? 'bg-white' : 'bg-slate-50'}`} style={{ width: `${m.daysCount * PX_PER_DAY}px` }}>
                                        {m.year}å¹´{m.month + 1}æœˆ
                                    </div>
                                ))}
                            </div>
                            <div className="gantt-header-day-row">
                                {timelineDayHeaders}
                            </div>
                        </div>
                    </div>
                </div>

                {/* Body */}
                <div className="gantt-body" ref={bodyRef}>
                    <div className="gantt-body-content" style={{ width: `${200 + totalDays * PX_PER_DAY}px` }}>
                        {/* Grid Background */}
                        <div className="gantt-grid-lines" style={{ width: `${totalDays * PX_PER_DAY}px` }}>{gridLines}</div>

                        {/* Today Line */}
                        {todayPos > 0 && <div className="today-line" style={{ left: `${200 + todayPos}px`, height: '100%' }}></div>}

                        {/* SVG Lines */}
                        <svg className="dependency-svg" style={{ left: '200px', width: `${totalDays * PX_PER_DAY}px`, height: `${sortedTasks.length * ROW_HEIGHT}px` }}>
                            <defs>
                                <marker id="arrowhead" markerWidth="6" markerHeight="4" refX="5" refY="2" orient="auto">
                                    <polygon points="0 0, 6 2, 0 4" fill="#94a3b8" />
                                </marker>
                            </defs>
                            {drawDependencies()}
                        </svg>

                        {/* Task Rows */}
                        {sortedTasks.map(t => {
                            const start = getStartDate(t.date, t.duration);
                            const left = getLeftPos(start);
                            const width = t.duration * PX_PER_DAY;
                            const colorClass = t.project === 'PlanB' ? 'bg-emerald-500' : t.project === 'Machine' ? 'bg-purple-500' : 'bg-blue-500';

                            return (
                                <div key={t.id} className="gantt-row">
                                    <div className="gantt-task-col truncate" title={t.task}>{t.task}</div>
                                    <div className="gantt-timeline-col">
                                        <div
                                            className={`gantt-bar ${colorClass} ${t.status === 'Done' ? 'opacity-50 grayscale' : ''}`}
                                            style={{ left: `${left}px`, width: `${width}px` }}
                                            onClick={() => { setEditingTask(t); setIsModalOpen(true); }}
                                            title={`${t.task} (${t.duration}å¤©)`}
                                        >
                                            {t.duration > 2 && <span className="text-[10px] pl-1">{t.owner}</span>}
                                        </div>
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                </div>
            </div>
        </div>
    );
};

window.GanttView = GanttView;

</script>
    <script type="text/babel">
// CalendarView Component
// Props: tasks, calendarMonth, setCalendarMonth, setEditingTask, setIsModalOpen
// éœ€å¼•å…¥: React, icons.js, helpers.js (getProjectColor)

const CalendarView = () => {
    const {
        tasks,
        calendarMonth,
        setCalendarMonth,
        setEditingTask,
        setIsModalOpen,
        searchQuery = ''
    } = useAppContext();
    const { useMemo } = React;

    // æ•ˆèƒ½å„ªåŒ–ï¼šå¿«å–æ—¥æ›†è¦–åœ–è³‡æ–™ï¼ˆæ·»åŠ æœå°‹éæ¿¾ï¼‰
    // åªæœ‰åœ¨æœˆä»½ã€ä»»å‹™æˆ–æœå°‹æ¢ä»¶æ”¹è®Šæ™‚æ‰é‡æ–°è¨ˆç®—
    const calendarDays = useMemo(() => {
        const year = calendarMonth.getFullYear();
        const month = calendarMonth.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const days = [];

        for (let i = 0; i < firstDay.getDay(); i++) days.push(null);

        for (let i = 1; i <= lastDay.getDate(); i++) {
            const dStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            let dayTasks = tasks.filter(t => t.date === dStr);

            // âœ… æ‡‰ç”¨æœå°‹éæ¿¾ï¼ˆèˆ‡ Dashboard/GanttView ä¸€è‡´ï¼‰
            if (searchQuery.trim()) {
                const query = searchQuery.trim();
                const prefixMatch = query.match(/^(project|owner|pic|team|task|note|category):(.*)/i);

                if (prefixMatch) {
                    // å‰ç¶´è©æœå°‹
                    const field = prefixMatch[1].toLowerCase();
                    const searchValue = prefixMatch[2].toLowerCase();

                    dayTasks = dayTasks.filter(t => {
                        switch (field) {
                            case 'project':
                                return t.project && String(t.project).toLowerCase().includes(searchValue);
                            case 'owner':
                            case 'pic':
                                return t.owner && String(t.owner).toLowerCase().includes(searchValue);
                            case 'team':
                                return t.team && String(t.team).toLowerCase().includes(searchValue);
                            case 'task':
                                return t.task && String(t.task).toLowerCase().includes(searchValue);
                            case 'note':
                                return t.notes && String(t.notes).toLowerCase().includes(searchValue);
                            case 'category':
                                return t.category && String(t.category).toLowerCase().includes(searchValue);
                            default:
                                return false;
                        }
                    });
                } else {
                    // ä¸€èˆ¬æœå°‹
                    const lowerQuery = query.toLowerCase();
                    dayTasks = dayTasks.filter(t => {
                        const matchTask = t.task && String(t.task).toLowerCase().includes(lowerQuery);
                        const matchOwner = t.owner && String(t.owner).toLowerCase().includes(lowerQuery);
                        const matchNotes = t.notes && String(t.notes).toLowerCase().includes(lowerQuery);
                        const matchCategory = t.category && String(t.category).toLowerCase().includes(lowerQuery);
                        const matchTeam = t.team && String(t.team).toLowerCase().includes(lowerQuery);
                        const matchProject = t.project && String(t.project).toLowerCase().includes(lowerQuery);
                        return matchTask || matchOwner || matchNotes || matchCategory || matchTeam || matchProject;
                    });
                }
            }

            days.push({ date: i, fullDate: dStr, tasks: dayTasks });
        }
        return days;
    }, [calendarMonth, tasks, searchQuery]);

    const changeMonth = (offset) => {
        setCalendarMonth(prev => {
            const next = new Date(prev);
            next.setMonth(next.getMonth() + offset);
            return next;
        });
    };

    return (
        <div className="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-lg font-bold text-slate-800">
                    {calendarMonth.toLocaleString('default', { year: 'numeric', month: 'long' })}
                </h2>
                <div className="flex gap-2">
                    <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-slate-100 rounded-full">
                        <Icon path={paths.left} />
                    </button>
                    <button onClick={() => changeMonth(1)} className="p-2 hover:bg-slate-100 rounded-full">
                        <Icon path={paths.right} />
                    </button>
                </div>
            </div>
            <div className="grid grid-cols-7 gap-px bg-slate-200 border border-slate-200 rounded-lg overflow-hidden">
                {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => (
                    <div key={d} className="bg-slate-50 py-2 text-center text-xs font-bold text-slate-500 uppercase">{d}</div>
                ))}
                {calendarDays.map((day, idx) => (
                    <div key={idx} className={`bg-white min-h-[120px] p-2 relative calendar-cell ${!day ? 'bg-slate-50/50' : ''}`}>
                        {day && (
                            <>
                                <span className={`text-xs font-medium ${day.date === new Date().getDate() && calendarMonth.getMonth() === new Date().getMonth() ? 'bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center' : 'text-slate-400'}`}>{day.date}</span>
                                <div className="mt-1 space-y-1 overflow-y-auto max-h-[100px] scrollbar-hide">
                                    {day.tasks.map(t => (
                                        <div key={t.id}
                                            onClick={() => { setEditingTask(t); setIsModalOpen(true); }}
                                            className={`group text-[10px] p-1 rounded border-l-2 cursor-pointer hover:opacity-80 flex items-center gap-1 ${getProjectColor(t.project)} ${t.isCheckpoint ? 'font-bold' : ''}`}>
                                            {t.isCheckpoint && <Icon path={paths.flag} size={8} />}
                                            <span className="truncate">
                                                <span className="font-mono text-[9px] mr-1 opacity-70 hidden group-hover:inline">#{t.id}</span>
                                                {t.task}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            </>
                        )}
                    </div>
                ))}
            </div>
        </div>
    );
};

window.CalendarView = CalendarView;

</script>
    <script type="text/babel">
// TaskModal Component
// Props: isOpen, onClose, editingTask, onSubmit, TEAMS, PROJECTS, OWNERS, CATEGORIES
// éœ€è¦å¼•å…¥: React (if needed for refs), icons.js

const TaskModal = ({
    isOpen,
    onClose,
    editingTask,
    onSubmit,
    TEAMS,
    PROJECTS,
    OWNERS,
    CATEGORIES
}) => {
    const { useState, useEffect } = React;
    const todayStr = new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Taipei' });

    if (!isOpen) return null;

    return (
        <div
            className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
            role="dialog"
            aria-modal="true"
            aria-labelledby="modal-title"
        >
            <div className="bg-white rounded-xl shadow-xl w-full max-w-lg max-h-[90vh] animate-fade-in overflow-hidden flex flex-col">
                <div className="p-4 border-b flex justify-between items-center bg-slate-50 flex-shrink-0">
                    <h3 id="modal-title" className="font-bold text-slate-800">{editingTask ? 'ç·¨è¼¯ä»»å‹™' : 'æ–°å¢ä»»å‹™'}</h3>
                    <button
                        onClick={onClose}
                        className="text-slate-400 hover:text-slate-600"
                        aria-label="é—œé–‰å°è©±æ¡†"
                    >
                        <Icon path={paths.x} />
                    </button>
                </div>
                {/* å¯æ»¾å‹•å…§å®¹å€ */}
                <div className="overflow-y-auto flex-1">
                    <form onSubmit={onSubmit} id="task-form" className="p-6 space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">ä»»å‹™å…§å®¹ <span className="text-red-500">*</span></label>
                            <input name="task" defaultValue={editingTask?.task} required className="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" />
                        </div>

                        {/* åŸºæœ¬è³‡è¨Šå€å¡Š */}
                        <div className="bg-slate-50 p-4 rounded-lg border space-y-3">
                            <h4 className="text-xs font-semibold text-slate-600 uppercase">åŸºæœ¬è³‡è¨Š</h4>

                            {/* Project */}
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">
                                    å°ˆæ¡ˆ (Project) <span className="text-red-500">*</span>
                                </label>
                                <select name="project" defaultValue={editingTask?.project || PROJECTS[0]} required className="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500">
                                    {PROJECTS.map(p => <option key={p} value={p}>{p}</option>)}
                                </select>
                            </div>

                            {/* Team */}
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Team <span className="text-red-500">*</span></label>
                                <select name="team" defaultValue={editingTask?.team || 'æ™¶ç‰‡'} className="w-full border rounded-lg p-2 text-sm">
                                    {TEAMS.map(t => <option key={t} value={t}>{t}</option>)}
                                </select>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">è² è²¬äºº <span className="text-red-500">*</span></label>
                                    <input list="owners" name="owner" defaultValue={editingTask?.owner} required className="w-full border rounded-lg p-2 text-sm" />
                                    <datalist id="owners">{OWNERS.map(o => <option key={o} value={o} />)}</datalist>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">é è¨ˆå·¥æ™‚ (å¤©)</label>
                                    <input type="number" name="duration" defaultValue={editingTask?.duration || 1} min="0" className="w-full border rounded-lg p-2 text-sm" />
                                </div>
                            </div>
                        </div>

                        {/* æ™‚é–“è¦åŠƒå€å¡Š */}
                        <div className="bg-slate-50 p-4 rounded-lg border space-y-3">
                            <h4 className="text-xs font-semibold text-slate-600 uppercase">æ™‚é–“è¦åŠƒ</h4>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">é–‹å§‹æ—¥æœŸ</label>
                                    <input type="date" name="startDate" defaultValue={editingTask?.startDate || ''} className="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">å®Œæˆæ—¥ <span className="text-red-500">*</span></label>
                                    <input type="date" name="date" defaultValue={editingTask?.date || todayStr} required className="w-full border rounded-lg p-2 text-sm" />
                                </div>
                            </div>
                        </div>

                        {/* ç‹€æ…‹èˆ‡å„ªå…ˆç´šå€å¡Š */}
                        <div className="bg-slate-50 p-4 rounded-lg border space-y-3">
                            <h4 className="text-xs font-semibold text-slate-600 uppercase">ç‹€æ…‹èˆ‡å„ªå…ˆç´š</h4>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">ç‹€æ…‹</label>
                                    <select name="status" defaultValue={editingTask?.status || 'Todo'} className="w-full border rounded-lg p-2 text-sm">
                                        <option value="Todo">å¾…åŸ·è¡Œ</option>
                                        <option value="InProgress">é€²è¡Œä¸­</option>
                                        <option value="Pending">æš«åœ/ç­‰å¾…</option>
                                        <option value="Done">å®Œæˆ</option>
                                        <option value="Closed">ä¸åŸ·è¡Œ/å–æ¶ˆ</option>
                                        <option value="Delayed">å»¶èª¤</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">å„ªå…ˆç´š</label>
                                    <select name="priority" defaultValue={editingTask?.priority || 'Medium'} className="w-full border rounded-lg p-2 text-sm">
                                        <option value="Low">Low</option><option value="Medium">Medium</option><option value="High">High</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        {/* é—œè¯è³‡è¨Šå€å¡Š */}
                        <div className="space-y-3">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">å‰ç½®ä»»å‹™ / ç›¸ä¾æ€§ (Dependency)</label>
                                <input name="dependency" defaultValue={editingTask?.dependency} placeholder="è¼¸å…¥å‰ç½®ä»»å‹™ IDï¼Œå¤šå€‹è«‹ç”¨é€—è™Ÿåˆ†éš” (ä¾‹å¦‚: 5,12,18)" className="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" />
                                <p className="text-xs text-slate-500 mt-1">ğŸ’¡ æç¤º:å¯å¡«å¯«å¤šå€‹ ID,ç”¨é€—è™Ÿåˆ†éš”,æœ€å¤š 10 å€‹</p>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">é©—è­‰æ–¹å¼ (Verification)</label>
                                <textarea name="verification" defaultValue={editingTask?.verification} rows="2" placeholder="å¦‚ä½•é©—è­‰æ­¤ä»»å‹™å·²å®Œæˆ? ä¾‹å¦‚: é€šéæ¸¬è©¦ã€å®¢æˆ¶ç°½æ”¶ã€æ–‡ä»¶å¯©æ ¸..." className="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"></textarea>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">å‚™è¨» (Notes)</label>
                                <textarea name="notes" defaultValue={editingTask?.notes} rows="2" placeholder="è©³ç´°èªªæ˜..." className="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"></textarea>
                            </div>
                        </div>

                        {/* ç‰¹æ®Šæ¨™è¨˜å€å¡Š */}
                        <div className="bg-slate-50 p-4 rounded-lg border space-y-3">
                            <h4 className="text-xs font-semibold text-slate-600 uppercase">ç‰¹æ®Šæ¨™è¨˜</h4>

                            {/* Checkpointè¤‡é¸æ¡† */}
                            <div className="flex items-center gap-3">
                                <div className="checkbox-container">
                                    <input type="checkbox" name="isCheckpoint" id="chk" defaultChecked={editingTask?.isCheckpoint} className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all" />
                                    <label htmlFor="chk" className="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer transition-all"></label>
                                </div>
                                <label htmlFor="chk" className="text-sm font-medium text-slate-700 cursor-pointer flex items-center gap-1">è¨­ç‚ºæª¢æŸ¥é» (Checkpoint) <Icon path={paths.flag} size={14} /></label>
                            </div>

                            {/* Issue Poolè¤‡é¸æ¡† */}
                            <div className="flex items-center gap-3">
                                <input
                                    type="checkbox"
                                    name="issuePool"
                                    id="issuePool"
                                    defaultChecked={editingTask?.issuePool || false}
                                    className="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer"
                                />
                                <label htmlFor="issuePool" className="text-sm font-medium text-slate-700 cursor-pointer">
                                    ğŸ”– åŠ å…¥Issueèªé ˜å€
                                </label>
                            </div>
                        </div>
                    </form>
                </div>

                {/* å›ºå®šæŒ‰éˆ•å€ */}
                <div className="p-4 border-t bg-white flex justify-end gap-2 flex-shrink-0">
                    <button type="button" onClick={onClose} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm">å–æ¶ˆ</button>
                    <button type="submit" form="task-form" className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 shadow-sm">å„²å­˜</button>
                </div>
            </div>
        </div>
    );
};

window.TaskModal = TaskModal;

</script>
    <script type="text/babel">
// Dashboard Component
// Props: tasks, filteredTasks, stats, filterTeam, setFilterTeam, filterProject, setFilterProject, filterStat, toggleStatFilter, searchQuery, setSearchQuery, hideCompleted, setHideCompleted, highlightUrgent, setHighlightUrgent, setEditingTask, setIsModalOpen, handleDelete, TEAMS, PROJECTS, chartData, isLoading, todayStr
// éœ€å¼•å…¥: React, Recharts, Icon, paths, helpers.js

const Dashboard = () => {
    const {
        // Data
        tasks,
        filteredTasks,
        stats,
        chartData,
        isLoading,
        TEAMS,
        PROJECTS,
        todayStr,

        // State / Setters
        filterTeam,
        setFilterTeam,
        filterProject,
        setFilterProject,
        filterStat,
        toggleStatFilter,
        searchQuery,
        setSearchQuery,
        hideCompleted,
        setHideCompleted,
        highlightUrgent,
        setHighlightUrgent,
        setEditingTask,
        setIsModalOpen,
        handleDelete,

        // Alerts
        alerts
    } = useAppContext();
    const { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend } = window.Recharts || {};

    return (
        <div className="space-y-4">
            {/* Stat Cards - 1è¡Œç·Šæ¹Šç‰ˆ */}
            <div className="grid grid-cols-1 md:grid-cols-6 gap-3 mb-4">
                {[
                    { label: 'ç¸½ä»»å‹™', val: stats.total, color: 'text-slate-800', bgGradient: 'from-slate-50 to-slate-100', icon: 'ğŸ“Š', type: null },
                    { label: 'æª¢æŸ¥é»', val: stats.checkpoints, color: 'text-indigo-600', bgGradient: 'from-indigo-50 to-indigo-100', icon: 'ğŸ“', type: 'Checkpoints' },
                    { label: 'å¾…è¾¦æ€¥ä»¶', val: stats.pendingHigh, color: 'text-orange-600', bgGradient: 'from-orange-50 to-orange-100', icon: 'âš¡', type: 'Urgent' },
                    { label: 'æ‡‰é–‹å·¥æœªå‹•', val: stats.lateStart, color: 'text-red-600', bgGradient: 'from-red-50 to-red-100', icon: 'â°', type: 'LateStart' },
                    { label: 'å·²é€¾æœŸ', val: stats.delayed, color: 'text-rose-600', bgGradient: 'from-rose-50 to-rose-100', icon: 'âŒ', type: 'Delayed' },
                    { label: 'å·²å®Œæˆ', val: stats.completed, color: 'text-green-600', bgGradient: 'from-green-50 to-green-100', icon: 'âœ“', type: 'Completed' }
                ].map((s, i) => (
                    <button
                        key={i}
                        onClick={() => s.type !== undefined && toggleStatFilter(s.type)}
                        className={`bg-gradient-to-br ${s.bgGradient} p-4 rounded-lg border-2 shadow-md text-left transition-all duration-200 hover:shadow-xl hover:-translate-y-1 hover:scale-105 ${filterStat === s.type
                            ? 'ring-2 ring-indigo-500 border-indigo-300'
                            : 'border-transparent hover:border-slate-200'
                            }`}
                    >
                        <div className="flex items-center justify-between mb-1.5">
                            <div className="text-xs text-slate-600 font-medium">{s.label}</div>
                            <div className="text-xl">{s.icon}</div>
                        </div>
                        <div className={`text-3xl font-bold ${s.color}`}>{s.val}</div>
                    </button>
                ))}
            </div>

            {/* ç¯©é¸èˆ‡æœå°‹å€ - å„ªåŒ–å¸ƒå±€ */}
            <div className="space-y-3">
                {/* ç¬¬ä¸€è¡Œ: Team ç¯©é¸æŒ‰éˆ• */}
                <div className="flex flex-wrap gap-2 bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                    {['All', ...TEAMS].map(t => (
                        <button
                            key={t}
                            onClick={() => setFilterTeam(t)}
                            className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all whitespace-nowrap ${filterTeam === t
                                ? 'bg-slate-800 text-white shadow-md'
                                : 'text-slate-600 hover:bg-slate-100 hover:shadow-sm'
                                }`}
                        >
                            {t}
                        </button>
                    ))}
                </div>

                {/* ç¬¬äºŒè¡Œ: åŠŸèƒ½æ§åˆ¶åˆ— (æœå°‹ + é–‹é—œ) */}
                <div className="flex flex-col md:flex-row gap-3">
                    {/* æœå°‹æ¡† */}
                    <div className="flex-1 relative">
                        <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400">
                            <Icon path={paths.search} size={16} />
                        </div>
                        <input
                            type="text"
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            placeholder="æœå°‹ä»»å‹™ã€è² è²¬äººã€å‚™è¨»..."
                            className="w-full pl-10 pr-10 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none shadow-sm h-10"
                        />
                        {searchQuery && (
                            <button
                                onClick={() => setSearchQuery('')}
                                className="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600"
                            >
                                <Icon path={paths.x} size={16} />
                            </button>
                        )}
                    </div>

                    {/* æ§åˆ¶é–‹é—œç¾¤çµ„ */}
                    <div className="flex gap-3">
                        {/* éš±è—å·²å®Œæˆ */}
                        <label className="flex items-center gap-2 text-sm bg-white px-3 py-2 rounded-lg border shadow-sm cursor-pointer whitespace-nowrap h-10 hover:bg-slate-50">
                            <input
                                type="checkbox"
                                checked={hideCompleted}
                                onChange={(e) => setHideCompleted(e.target.checked)}
                                className="w-4 h-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500 focus:ring-2"
                            />
                            <span className="font-medium">éš±è—å·²å®Œæˆ</span>
                        </label>

                        {/* é«˜äº®é–‹é—œ */}
                        <div className="flex items-center gap-2 text-sm bg-white px-3 py-2 rounded-lg border shadow-sm h-10 hover:bg-slate-50">
                            <input
                                type="checkbox"
                                id="highlightUrgent"
                                checked={highlightUrgent}
                                onChange={(e) => setHighlightUrgent(e.target.checked)}
                                className="rounded text-indigo-600 focus:ring-indigo-500 cursor-pointer"
                            />
                            <label htmlFor="highlightUrgent" className="text-slate-600 cursor-pointer select-none whitespace-nowrap font-medium">
                                å¼·èª¿å»¶é²/æ‡‰é–‹å·¥
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            {/* æœå°‹çµæœæç¤º */}
            {searchQuery && (
                <div className="px-4 py-3 bg-indigo-50 border border-indigo-200 rounded-lg flex items-center justify-between">
                    <span className="text-sm text-indigo-700 flex items-center gap-2">
                        <Icon path={paths.search} size={14} />
                        æœå°‹ã€Œ<strong>{searchQuery}</strong>ã€æ‰¾åˆ° <strong>{filteredTasks.length}</strong> å€‹çµæœ
                    </span>
                    <button
                        onClick={() => setSearchQuery('')}
                        className="text-indigo-600 hover:text-indigo-800 text-sm font-medium transition-colors"
                    >
                        æ¸…é™¤æœå°‹
                    </button>
                </div>
            )}

            {filteredTasks.length === 0 && !isLoading ? (
                <div className="p-12 text-center bg-white rounded-xl border shadow-sm">
                    <div className="text-slate-300 mb-4"><Icon path={paths.list} size={48} className="mx-auto" /></div>
                    <h3 className="text-lg font-bold text-slate-600 mb-2">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ä»»å‹™</h3>
                    <p className="text-slate-400">è«‹èª¿æ•´ç¯©é¸æ¢ä»¶æˆ–æ–°å¢ä»»å‹™</p>
                </div>
            ) : (
                <div className="bg-white rounded-xl border-2 border-slate-200 shadow-md overflow-hidden">
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead className="bg-gradient-to-r from-slate-50 to-slate-100 border-b-2 border-slate-200">
                                <tr>
                                    <th className="px-4 py-4 text-left font-semibold text-slate-700 w-44">ID</th>
                                    <th className="px-4 py-4 text-left font-semibold text-slate-700 w-32">ç‹€æ…‹</th>
                                    <th className="px-4 py-4 text-left font-semibold text-slate-700">ä»»å‹™</th>
                                    <th className="px-4 py-4 text-left font-semibold text-slate-700 w-36">å·¥æ™‚/å»ºè­°é–‹å§‹</th>
                                    <th className="px-4 py-4 text-left font-semibold text-slate-700 w-28">å®Œæˆæ—¥</th>
                                    <th className="px-4 py-4 text-left font-semibold text-slate-700 w-20">è² è²¬äºº</th>
                                    <th className="px-4 py-4 text-right font-semibold text-slate-700 w-24">å‹•ä½œ</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-200">
                                {filteredTasks.sort((a, b) => new Date(a.date) - new Date(b.date)).map(t => (
                                    <tr
                                        key={t.id}
                                        className={`hover:bg-slate-50 group transition-all duration-150 ${t.isCheckpoint ? 'bg-indigo-50/50' : ''} ${getRowHighlight(t, highlightUrgent, todayStr)}`}
                                        tabIndex={0}
                                    >
                                        <td className="px-4 py-4">
                                            <div className="font-mono text-xs text-slate-600 font-semibold">#{t.id}</div>
                                        </td>
                                        <td className="px-4 py-4">
                                            {getStatusBadge(t, todayStr)}
                                            <div className={`text-[10px] mt-1.5 px-2 py-0.5 w-fit rounded-full border font-medium ${getTeamBadgeClass(t.team)}`}>{t.team}</div>
                                            {t.project && <div className={`text-[10px] mt-1 px-2 py-0.5 w-fit rounded-md border font-medium ${getProjectColor(t.project)}`}>{t.project}</div>}
                                        </td>
                                        <td className="px-4 py-4">
                                            <div className="font-medium text-slate-900 flex items-center gap-2">
                                                {t.isCheckpoint && <Icon path={paths.flag} size={14} className="text-indigo-600 fill-indigo-100 flex-shrink-0" />}
                                                <span className="line-clamp-2">{t.task}</span>
                                                {t.dependency && <div className="tooltip-container flex-shrink-0"><Icon path={paths.link} size={12} className="text-slate-400" /><span className="tooltip-text">å‰ç½®ä»»å‹™: {parseDependencies(t.dependency).map(id => `#${id}`).join(', ')}</span></div>}
                                                {t.notes && <div className="tooltip-container flex-shrink-0"><Icon path={paths.file} size={12} className="text-slate-400" /><span className="tooltip-text">{t.notes}</span></div>}
                                            </div>
                                            {t.priority === 'High' && <span className="text-[10px] text-orange-600 font-bold mt-1 inline-block">âš¡ æ€¥ä»¶</span>}
                                        </td>
                                        <td className="px-4 py-4 text-slate-600">
                                            <div className="flex items-center gap-1.5"><Icon path={paths.timer} size={14} className="text-slate-400" /> <span className="font-medium">{t.duration}</span> å¤©</div>
                                            <div className="text-[10px] text-slate-400 mt-1">Start: {getStartDate(t.date, t.duration)}</div>
                                        </td>
                                        <td className="px-4 py-4">
                                            <div className="font-semibold text-slate-700">{t.date}</div>
                                        </td>
                                        <td className="px-4 py-4">
                                            <div className="w-8 h-8 rounded-full bg-gradient-to-br from-slate-200 to-slate-300 flex items-center justify-center text-xs font-bold text-slate-700 shadow-sm">
                                                {t.owner ? t.owner[0] : '?'}
                                            </div>
                                        </td>
                                        <td className="px-4 py-4 text-right">
                                            <div className="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-all duration-200">
                                                <button
                                                    onClick={() => { setEditingTask(t); setIsModalOpen(true); }}
                                                    className="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded transition-colors"
                                                    title="ç·¨è¼¯"
                                                >
                                                    <Icon path={paths.edit} size={16} />
                                                </button>
                                                <button
                                                    onClick={() => handleDelete(t.id)}
                                                    className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors"
                                                    title="åˆªé™¤"
                                                >
                                                    <Icon path={paths.trash} size={16} />
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* åœ“é¤…åœ– - ç§»åˆ°ä»»å‹™åˆ—è¡¨ä¸‹æ–¹ */}
            <div className="bg-white p-6 rounded-xl border-2 border-slate-200 shadow-md">
                <div className="flex items-center justify-between mb-4">
                    <h3 className="font-bold text-slate-800 text-lg flex items-center gap-2">
                        <span>ğŸ“Š</span>
                        å°ˆæ¡ˆåˆ†å¸ƒ
                    </h3>
                    <div className="text-xs text-slate-500">
                        ä¾Teamåˆ†é¡çµ±è¨ˆ
                    </div>
                </div>
                <div className="h-80">
                    {window.Recharts && (
                        <ResponsiveContainer width="100%" height="100%">
                            <PieChart>
                                <Pie
                                    data={chartData}
                                    dataKey="value"
                                    cx="50%"
                                    cy="50%"
                                    innerRadius={80}
                                    outerRadius={120}
                                    paddingAngle={5}
                                >
                                    {chartData.map((e, i) => <Cell key={i} fill={e.color} />)}
                                </Pie>
                                <Tooltip />
                                <Legend verticalAlign="bottom" height={36} />
                            </PieChart>
                        </ResponsiveContainer>
                    )}
                </div>
            </div>
        </div>
    );
};

window.Dashboard = Dashboard;

</script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend } = window.Recharts || {};

        // âœ… Task IDéƒ¨é–€ä»£ç¢¼Mapping (ç”¨æ–¼æœªä¾†Task IDå‡ç´š)
        const DEPT_CODES = {
            'æ™¶ç‰‡': 'CHIP',
            'æ©Ÿæ§‹': 'MECH',
            'è»Ÿé«”': 'SW',
            'é›»æ§': 'EC',
            'æµé“': 'FLOW',
            'ç”Ÿé†«': 'BIO',
            'QA': 'QA',
            'ç®¡ç†': 'MGT',
            'issue': 'ISS'
        };
    </script>

    
    <!-- Custom Hooks -->
    <script type="text/babel">
// ===== hooks/useAuth.js =====
/**
 * useAuth Hook
 * ç®¡ç†ä½¿ç”¨è€…èªè­‰ç‹€æ…‹
 */

// ç¢ºä¿ React Hooks å¯ç”¨
const { useState, useEffect } = React;

const useAuth = () => {
    const [isAuthenticated, setIsAuthenticated] = useState(false);
    const [userApiKey, setUserApiKey] = useState('');

    // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥ï¼ˆå¾ localStorageï¼‰
    useEffect(() => {
        const savedKey = localStorage.getItem('apiKey');
        if (savedKey) {
            setUserApiKey(savedKey);
            setIsAuthenticated(true);
        }
    }, []);

    // ç™»å…¥è™•ç†
    const handleLogin = (apiKey) => {
        setUserApiKey(apiKey);
        setIsAuthenticated(true);
        // é‡æ–°æ•´ç†ä»¥è¼‰å…¥è³‡æ–™
        window.location.reload();
    };

    // ç™»å‡ºè™•ç†
    const handleLogout = () => {
        localStorage.removeItem('apiKey');
        setIsAuthenticated(false);
        setUserApiKey('');
    };

    return {
        isAuthenticated,
        userApiKey,
        handleLogin,
        handleLogout
    };
};


// ===== hooks/useTaskData.js =====
/**
 * useTaskData Hook
 * ç®¡ç†ä»»å‹™è³‡æ–™çš„è¼‰å…¥ã€ä¸Šå‚³ã€å„²å­˜å’Œåˆªé™¤
 */

function useTaskData(isAuthenticated) {
    // State
    const [tasks, setTasks] = React.useState([]);
    const [isLoading, setIsLoading] = React.useState(true);
    const [isOffline, setIsOffline] = React.useState(false);
    const [apiError, setApiError] = React.useState(null);
    const [dataSource, setDataSource] = React.useState('google');
    const [uploadProgress, setUploadProgress] = React.useState('');
    const fileInputRef = React.useRef(null);

    // è¼‰å…¥ä»»å‹™è³‡æ–™
    React.useEffect(() => {
        if (!isAuthenticated) return;

        setIsLoading(true);
        const fetchData = async () => {
            try {
                setApiError(null);
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), 8000);
                const response = await fetch(API_URL + '?action=read', { signal: controller.signal });
                clearTimeout(id);
                if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
                const result = await response.json();

                console.log('===== Google Sheets è³‡æ–™é™¤éŒ¯ =====');
                console.log('APIå®Œæ•´å›æ‡‰:', result);

                const data = result.data || result;

                console.log('è³‡æ–™ç­†æ•¸:', data.length);
                if (data.length > 0) {
                    console.log('ç¬¬ä¸€ç­†è³‡æ–™:', data[0]);
                    console.log('æ¬„ä½åç¨±:', Object.keys(data[0]));
                }

                if (Array.isArray(data) && data.length > 0) {
                    const firstItem = data[0];
                    const isUTMFormat = firstItem.hasOwnProperty('ID') || firstItem.hasOwnProperty('Task');

                    console.log('è³‡æ–™æ ¼å¼:', isUTMFormat ? 'UnifiedTaskManager' : 'Project Tracker');

                    let formatted;
                    if (isUTMFormat) {
                        const convertResult = convertUTMToTracker(data);
                        formatted = convertResult.data;
                        console.log('è½‰æ›çµæœ:', convertResult.stats);
                    } else {
                        formatted = data.map(item => ({
                            ...item,
                            id: item.id,
                            duration: Number(item.duration),
                            isCheckpoint: item.isCheckpoint === true || item.isCheckpoint === "TRUE",
                            date: normalizeDate(item.date),
                            dependency: item.dependency || '',
                            notes: item.notes || '',
                            category: item.category || item.team || 'Mechanism'
                        }));
                    }
                    setTasks(formatted);
                    setDataSource('google');
                    setIsOffline(false);
                } else {
                    setTasks(INITIAL_DATA);
                    setIsOffline(false);
                }

            } catch (err) {
                console.error("API Error:", err);
                let errorMsg = 'æœªçŸ¥éŒ¯èª¤';

                if (err.name === 'AbortError') {
                    errorMsg = 'é€£ç·šé€¾æ™‚ (è¶…é8ç§’)';
                } else if (err.message.includes('Failed to fetch')) {
                    errorMsg = 'ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯';
                } else if (err.message.includes('HTTP Error')) {
                    errorMsg = `ä¼ºæœå™¨éŒ¯èª¤: ${err.message}`;
                } else {
                    errorMsg = err.message;
                }

                setApiError(errorMsg);

                const backup = localStorage.getItem('tasks_backup');
                if (backup) {
                    try {
                        const backupTasks = JSON.parse(backup);
                        const backupTime = localStorage.getItem('tasks_backup_time');
                        setTasks(backupTasks);
                        setApiError(`${errorMsg} - ä½¿ç”¨æœ¬åœ°å‚™ä»½ (${new Date(backupTime).toLocaleString('zh-TW')})`);
                    } catch (e) {
                        setTasks(INITIAL_DATA);
                    }
                } else {
                    setTasks(INITIAL_DATA);
                }
                setIsOffline(true);
            } finally {
                setIsLoading(false);
            }
        };
        fetchData();
    }, [isAuthenticated]);

    // Excel æª”æ¡ˆä¸Šå‚³è™•ç†
    const handleFileUpload = async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const validExtensions = ['.xlsx', '.xls', '.csv'];
        const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
        if (!validExtensions.includes(fileExtension)) {
            alert('æª”æ¡ˆæ ¼å¼ä¸æ”¯æ´ï¼è«‹ä¸Šå‚³ Excel (.xlsx, .xls) æˆ– CSV (.csv) æª”æ¡ˆ');
            return;
        }

        setIsLoading(true);
        setUploadProgress(`æ­£åœ¨è®€å– ${file.name}...`);

        try {
            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    setUploadProgress('æ­£åœ¨è§£ææª”æ¡ˆ...');

                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: true });

                    setUploadProgress('æ­£åœ¨è½‰æ›è³‡æ–™æ ¼å¼...');

                    const result = convertUTMToTracker(jsonData);

                    if (!result.success) {
                        const errorMsg = result.errors.join('\n');
                        if (result.data.length > 0) {
                            alert(`éƒ¨åˆ†è³‡æ–™è½‰æ›å¤±æ•—:\n${errorMsg}\n\nå·²æˆåŠŸè¼‰å…¥ ${result.stats.converted} / ${result.stats.total} ç­†ä»»å‹™`);
                        } else {
                            throw new Error(`è³‡æ–™è½‰æ›å¤±æ•—:\n${errorMsg}`);
                        }
                    }

                    if (result.data.length === 0) {
                        throw new Error('æª”æ¡ˆä¸­æ²’æœ‰æœ‰æ•ˆçš„ä»»å‹™è³‡æ–™');
                    }

                    setTasks(result.data);
                    setDataSource('excel');
                    setIsOffline(true);
                    setApiError(null);

                    try {
                        localStorage.setItem('tasks_backup', JSON.stringify(result.data));
                        localStorage.setItem('tasks_backup_time', new Date().toISOString());
                        localStorage.setItem('tasks_backup_source', file.name);
                    } catch (e) {
                        console.warn('æœ¬åœ°å„²å­˜å¤±æ•—:', e);
                    }

                    setUploadProgress(`âœ“ æˆåŠŸè¼‰å…¥ ${result.data.length} ç­†ä»»å‹™ (ä¾†è‡ª ${file.name})`);
                    setTimeout(() => setUploadProgress(''), 3000);

                } catch (parseError) {
                    console.error('è§£æéŒ¯èª¤:', parseError);
                    alert(`æª”æ¡ˆè§£æå¤±æ•—: ${parseError.message}`);
                    setUploadProgress('');
                } finally {
                    setIsLoading(false);
                }
            };

            reader.onerror = (error) => {
                console.error('æª”æ¡ˆè®€å–éŒ¯èª¤:', error);
                alert('æª”æ¡ˆè®€å–å¤±æ•—ï¼Œè«‹é‡è©¦');
                setUploadProgress('');
                setIsLoading(false);
            };

            reader.readAsArrayBuffer(file);

        } catch (error) {
            console.error('ä¸Šå‚³éŒ¯èª¤:', error);
            alert(`ä¸Šå‚³å¤±æ•—: ${error.message}`);
            setUploadProgress('');
            setIsLoading(false);
        }
    };

    // è™•ç†å„²å­˜
    const handleSave = (e, editingTask, todayStr) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const defaultDate = getTaiwanToday();

        const isEditing = !!editingTask;
        const newItem = {
            ...(isEditing && { id: editingTask.id }),
            project: fd.get('project'),
            team: fd.get('team'),
            task: fd.get('task'),
            owner: fd.get('owner'),
            startDate: fd.get('startDate') || '',
            date: fd.get('date') || defaultDate,
            duration: parseInt(fd.get('duration') || 0),
            isCheckpoint: fd.get('isCheckpoint') === 'on',
            issuePool: fd.get('issuePool') === 'on',
            priority: fd.get('priority'),
            status: fd.get('status'),
            dependency: fd.get('dependency'),
            verification: fd.get('verification'),
            notes: fd.get('notes')
        };

        const validationErrors = validateTask(newItem);
        if (validationErrors.length > 0) {
            alert('é©—è­‰å¤±æ•—:\n' + validationErrors.join('\n'));
            return;
        }

        if (isEditing) {
            const depErrors = validateDependencies(newItem.dependency, newItem.id, tasks);
            if (depErrors.length > 0) {
                alert('ç›¸ä¾æ€§é©—è­‰å¤±æ•—:\n' + depErrors.join('\n'));
                return;
            }
            if (newItem.dependency && detectCircularDependency(newItem.id, newItem.dependency, tasks)) {
                alert('éŒ¯èª¤ï¼šåµæ¸¬åˆ°å¾ªç’°ç›¸ä¾æ€§ï¼');
                return;
            }
        }

        let updatedTasks = tasks;
        if (isEditing) {
            updatedTasks = tasks.map(t => t.id === newItem.id ? newItem : t);
            setTasks(updatedTasks);
        }

        if (isEditing) {
            try {
                localStorage.setItem('tasks_backup', JSON.stringify(updatedTasks));
                localStorage.setItem('tasks_backup_time', new Date().toISOString());
            } catch (e) {
                console.warn('æœ¬åœ°å„²å­˜å¤±æ•—:', e);
            }
        }

        if (!isOffline) {
            const payload = {
                action: isEditing ? 'update' : 'upsert',
                data: newItem
            };

            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8'
                },
                body: JSON.stringify(payload)
            })
                .then(() => {
                    console.log('âœ… å·²ç™¼é€è‡³ Google Sheets');
                    if (!isEditing) {
                        setIsLoading(true);
                        setTimeout(() => {
                            fetch(API_URL + '?action=read')
                                .then(res => res.json())
                                .then(result => {
                                    const data = result.data || result;
                                    if (Array.isArray(data) && data.length > 0) {
                                        const formatted = data.map(item => ({
                                            ...item,
                                            id: item.id,
                                            duration: Number(item.duration),
                                            isCheckpoint: item.isCheckpoint === true || item.isCheckpoint === "TRUE",
                                            date: normalizeDate(item.date),
                                            dependency: item.dependency || '',
                                            notes: item.notes || '',
                                            category: item.category || item.team || 'Mechanism'
                                        }));
                                        setTasks(formatted);
                                    }
                                })
                                .finally(() => setIsLoading(false));
                        }, 1000);
                    }
                })
                .catch(err => {
                    console.error("âŒ ç™¼é€å¤±æ•—:", err);
                    alert('å„²å­˜åˆ° Google Sheets æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œä½†æœ¬åœ°å·²æ›´æ–°');
                });
        }

        return true; // è¡¨ç¤ºå„²å­˜æˆåŠŸï¼Œç”± App é—œé–‰ modal
    };

    const handleDelete = (id) => {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ä»»å‹™å—ï¼Ÿ(å°‡åŒæ­¥åˆªé™¤ Google Sheet è³‡æ–™)')) return;
        setTasks(prev => prev.filter(x => x.id !== id));

        if (!isOffline) {
            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: 'delete', data: { id: id } })
            })
                .then(() => console.log('âœ… åˆªé™¤æˆåŠŸ'))
                .catch(err => console.error("âŒ Delete Error:", err));
        }
    };

    return {
        tasks,
        setTasks,
        isLoading,
        setIsLoading,
        isOffline,
        apiError,
        dataSource,
        uploadProgress,
        fileInputRef,
        handleFileUpload,
        handleSave,
        handleDelete
    };
}

// å°å‡ºåˆ° window
window.useTaskData = useTaskData;


// ===== hooks/useFilters.js =====
/**
 * useFilters Hook
 * ç®¡ç†ç¯©é¸ã€æœå°‹ã€çµ±è¨ˆå’Œåœ–è¡¨è³‡æ–™
 */

function useFilters(tasks, todayStr, apiError, dynamicTeams, TEAMS) {
    // State
    const [filterTeam, setFilterTeam] = React.useState('All');
    const [filterProject, setFilterProject] = React.useState('All');
    const [filterStat, setFilterStat] = React.useState(null);
    const [searchQuery, setSearchQuery] = React.useState('');
    const [ganttFilterTeam, setGanttFilterTeam] = React.useState('All');
    const [showDependencies, setShowDependencies] = React.useState(false);
    const [viewMode, setViewMode] = React.useState('dashboard');

    // å¾ localStorage è®€å–åˆå§‹è¨­å®š
    const [highlightUrgent, setHighlightUrgent] = React.useState(() => {
        const saved = localStorage.getItem('highlightUrgent');
        return saved !== null ? JSON.parse(saved) : true;
    });

    const [hideCompleted, setHideCompleted] = React.useState(() => {
        const saved = localStorage.getItem('hideCompleted');
        return saved !== null ? JSON.parse(saved) : true;
    });

    // æŒä¹…åŒ–è¨­å®š
    React.useEffect(() => {
        localStorage.setItem('highlightUrgent', JSON.stringify(highlightUrgent));
    }, [highlightUrgent]);

    React.useEffect(() => {
        localStorage.setItem('hideCompleted', JSON.stringify(hideCompleted));
    }, [hideCompleted]);

    // çµ±è¨ˆ
    const stats = React.useMemo(() => {
        if (!todayStr) return { total: 0, checkpoints: 0, pendingHigh: 0, completed: 0, lateStart: 0, delayed: 0 };
        const baseTasks = tasks.filter(t => filterTeam === 'All' || (t.team && t.team === filterTeam));
        return {
            total: baseTasks.length,
            checkpoints: baseTasks.filter(t => t.isCheckpoint).length,
            pendingHigh: baseTasks.filter(t => t.priority === 'High' && t.status !== 'Done').length,
            completed: baseTasks.filter(t => t.status === 'Done').length,
            lateStart: baseTasks.filter(t => {
                const startDate = getStartDate(t.date, t.duration);
                return t.status === 'Todo' && startDate <= todayStr && t.date >= todayStr;
            }).length,
            delayed: baseTasks.filter(t => t.date < todayStr && t.status !== 'Done').length
        };
    }, [tasks, todayStr, filterTeam]);

    // ç¯©é¸ä»»å‹™
    const filteredTasks = React.useMemo(() => {
        const filterFunctions = {
            'Checkpoints': (t) => t.isCheckpoint,
            'Urgent': (t) => t.status !== 'Done' && t.priority === 'High',
            'Completed': (t) => t.status === 'Done',
            'LateStart': (t) => {
                const startDate = getStartDate(t.date, t.duration);
                return t.status === 'Todo' && startDate <= todayStr && t.date >= todayStr;
            },
            'Delayed': (t) => t.date < todayStr && t.status !== 'Done'
        };

        let result = tasks.filter(t => {
            if (filterTeam === 'All') return true;
            if (filterTeam === 'issue' || filterTeam === 'Issue') {
                return (t.team && (t.team === 'issue' || t.team === 'Issue')) || t.issuePool === true;
            }
            return t.team && t.team === filterTeam;
        });

        if (filterProject !== 'All') {
            result = result.filter(t => t.project && t.project === filterProject);
        }

        if (filterStat && filterFunctions[filterStat]) {
            result = result.filter(filterFunctions[filterStat]);
        }

        if (searchQuery.trim()) {
            const query = searchQuery.trim();
            const prefixMatch = query.match(/^(project|owner|pic|team|task|note|category):(.*)/i);

            if (prefixMatch) {
                const field = prefixMatch[1].toLowerCase();
                const searchValue = prefixMatch[2].toLowerCase();
                result = result.filter(t => {
                    switch (field) {
                        case 'project': return t.project && String(t.project).toLowerCase().includes(searchValue);
                        case 'owner': case 'pic': return t.owner && String(t.owner).toLowerCase().includes(searchValue);
                        case 'team': return t.team && String(t.team).toLowerCase().includes(searchValue);
                        case 'task': return t.task && String(t.task).toLowerCase().includes(searchValue);
                        case 'note': return t.notes && String(t.notes).toLowerCase().includes(searchValue);
                        case 'category': return t.category && String(t.category).toLowerCase().includes(searchValue);
                        default: return false;
                    }
                });
            } else {
                const lowerQuery = query.toLowerCase();
                result = result.filter(t => {
                    const matchTask = t.task && String(t.task).toLowerCase().includes(lowerQuery);
                    const matchOwner = t.owner && String(t.owner).toLowerCase().includes(lowerQuery);
                    const matchNotes = t.notes && String(t.notes).toLowerCase().includes(lowerQuery);
                    const matchCategory = t.category && String(t.category).toLowerCase().includes(lowerQuery);
                    const matchTeam = t.team && String(t.team).toLowerCase().includes(lowerQuery);
                    const matchProject = t.project && String(t.project).toLowerCase().includes(lowerQuery);
                    return matchTask || matchOwner || matchNotes || matchCategory || matchTeam || matchProject;
                });
            }
        }

        if (hideCompleted) {
            result = result.filter(t => t.status !== 'Done');
        }

        return result;
    }, [tasks, filterTeam, filterProject, filterStat, todayStr, searchQuery, hideCompleted]);

    // è­¦å‘Šè¨Šæ¯
    const alerts = React.useMemo(() => {
        if (!todayStr) return [];
        const list = [];
        const overdueCount = tasks.filter(t => t.date < todayStr && t.status !== 'Done').length;
        if (overdueCount > 0) list.push({ type: 'danger', msg: `æœ‰ ${overdueCount} å€‹ä»»å‹™å·²é€¾æœŸ` });
        if (apiError) list.push({ type: 'warning', msg: `ç³»çµ±é›¢ç·šä¸­ (${apiError})` });
        return list;
    }, [tasks, todayStr, apiError]);

    // Chart Data
    const chartData = React.useMemo(() => {
        const teamList = dynamicTeams.length > 0 ? dynamicTeams : TEAMS;
        return teamList.map(team => ({
            name: team,
            value: tasks.filter(t => t.team && t.team === team).length,
            color: getTeamColor(team)
        })).filter(item => item.value > 0);
    }, [tasks, dynamicTeams, TEAMS]);

    const toggleStatFilter = (type) => {
        setFilterStat(prev => prev === type ? null : type);
        setViewMode('dashboard');
    };

    return {
        // State
        filterTeam,
        setFilterTeam,
        filterProject,
        setFilterProject,
        filterStat,
        setFilterStat,
        searchQuery,
        setSearchQuery,
        ganttFilterTeam,
        setGanttFilterTeam,
        showDependencies,
        setShowDependencies,
        viewMode,
        setViewMode,
        highlightUrgent,
        setHighlightUrgent,
        hideCompleted,
        setHideCompleted,
        // Computed
        stats,
        filteredTasks,
        alerts,
        chartData,
        toggleStatFilter
    };
}

// å°å‡ºåˆ° window
window.useFilters = useFilters;


    </script>

    
    <!-- React Contexts -->
    <script type="text/babel">
// ===== contexts/AppContext.jsx =====
/**
 * AppContext
 * æä¾›å…¨åŸŸç‹€æ…‹ç®¡ç†ï¼Œé¿å… Prop Drilling
 */

const AppContext = React.createContext(null);

const AppProvider = ({ children, value }) => {
    return (
        <AppContext.Provider value={value}>
            {children}
        </AppContext.Provider>
    );
};

// Custom Hook for easier usage
const useAppContext = () => {
    const context = React.useContext(AppContext);
    if (!context) {
        throw new Error('useAppContext must be used within an AppProvider');
    }
    return context;
};

// å°å‡ºåˆ° window
window.AppContext = AppContext;
window.AppProvider = AppProvider;
window.useAppContext = useAppContext;


    </script>

    
    <!-- App Component -->
    <script type="text/babel">
/**
 * App Component
 * é‡æ§‹å¾Œä½¿ç”¨ hooks ç®¡ç†è³‡æ–™èˆ‡ç¯©é¸
 */

// ç¢ºä¿ React Hooks å¯ç”¨
const { useState, useEffect, useMemo, useRef } = React;
// ç¢ºä¿ Recharts çµ„ä»¶å¯ç”¨
const { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend } = window.Recharts || {};

const App = () => {
    // âœ… ä½¿ç”¨ useAuth hook ç®¡ç†èªè­‰
    const { isAuthenticated, userApiKey, handleLogin, handleLogout } = useAuth();

    // âœ… UI ç›¸é—œç‹€æ…‹
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingTask, setEditingTask] = useState(null);
    const [todayStr, setTodayStr] = useState('');
    const [calendarMonth, setCalendarMonth] = useState(new Date());
    const [isMobile, setIsMobile] = useState(false);

    // âœ… Phase 1: å‹•æ…‹ä¸»è³‡æ–™
    const [dynamicTeams, setDynamicTeams] = useState([]);
    const [dynamicProjects, setDynamicProjects] = useState([]);
    const [dynamicOwners, setDynamicOwners] = useState([]);

    // å‚™ä»½åˆ—è¡¨
    const TEAMS_FALLBACK = ['æ™¶ç‰‡', 'æ©Ÿæ§‹', 'è»Ÿé«”', 'é›»æ§', 'æµé“', 'ç”Ÿé†«', 'QA', 'ç®¡ç†', 'issue'];
    const PROJECTS_FALLBACK = ['CKSX', 'Jamstec', 'Genentech', '5880 Chip', 'Internal', 'TBD', 'Other'];
    const OWNERS_FALLBACK = ['Anting', 'å®—è½…', 'Jerry', 'å­å®—', 'Jun', 'æ…¶å¾·', 'HW', 'EE', 'RD', 'QA', 'SW', 'All', 'Unassigned'];

    const TEAMS = dynamicTeams.length > 0 ? dynamicTeams : TEAMS_FALLBACK;
    const PROJECTS = dynamicProjects.length > 0 ? dynamicProjects : PROJECTS_FALLBACK;
    const OWNERS = dynamicOwners.length > 0 ? dynamicOwners : OWNERS_FALLBACK;

    // âœ… ä½¿ç”¨ useTaskData hook
    const {
        tasks,
        setTasks,
        isLoading,
        isOffline,
        apiError,
        dataSource,
        uploadProgress,
        fileInputRef,
        handleFileUpload,
        handleSave: taskDataHandleSave,
        handleDelete
    } = useTaskData(isAuthenticated);

    // âœ… ä½¿ç”¨ useFilters hook
    const {
        filterTeam,
        setFilterTeam,
        filterProject,
        setFilterProject,
        filterStat,
        searchQuery,
        setSearchQuery,
        ganttFilterTeam,
        setGanttFilterTeam,
        showDependencies,
        setShowDependencies,
        viewMode,
        setViewMode,
        highlightUrgent,
        setHighlightUrgent,
        hideCompleted,
        setHideCompleted,
        stats,
        filteredTasks,
        alerts,
        chartData,
        toggleStatFilter
    } = useFilters(tasks, todayStr, apiError, dynamicTeams, TEAMS);

    // ==================== Effects ====================

    // åµæ¸¬è¡Œå‹•è£ç½®
    useEffect(() => {
        const checkMobile = () => setIsMobile(window.innerWidth < 768);
        checkMobile();
        window.addEventListener('resize', checkMobile);
        return () => window.removeEventListener('resize', checkMobile);
    }, []);

    // åˆå§‹åŒ–æ—¥æœŸ
    useEffect(() => {
        setTodayStr(getTaiwanToday());
        setCalendarMonth(new Date());
    }, []);

    // âœ… Phase 1: è¼‰å…¥å‹•æ…‹ä¸»è³‡æ–™
    useEffect(() => {
        const loadMasterData = async () => {
            try {
                const teamsRes = await fetch(`${API_URL}?action=getTeams`);
                const teamsData = await teamsRes.json();
                if (teamsData.success) {
                    setDynamicTeams(teamsData.data.filter(t => t.isActive).map(t => t.teamName));
                    console.log('âœ… å‹•æ…‹è¼‰å…¥ Teams:', teamsData.data.length);
                }

                const projectsRes = await fetch(`${API_URL}?action=getProjects`);
                const projectsData = await projectsRes.json();
                if (projectsData.success) {
                    setDynamicProjects(projectsData.data.map(p => p.projectName));
                    console.log('âœ… å‹•æ…‹è¼‰å…¥ Projects:', projectsData.data.length);
                }

                const ownersRes = await fetch(`${API_URL}?action=getOwners`);
                const ownersData = await ownersRes.json();
                if (ownersData.success) {
                    setDynamicOwners(ownersData.data.filter(o => o.isActive).map(o => o.ownerName));
                    console.log('âœ… å‹•æ…‹è¼‰å…¥ Owners:', ownersData.data.length);
                }
            } catch (error) {
                console.error('âŒ è¼‰å…¥ä¸»è³‡æ–™å¤±æ•—:', error);
            }
        };
        if (isAuthenticated && !isOffline) {
            loadMasterData();
        }
    }, [isAuthenticated, isOffline]);

    // ==================== äº‹ä»¶è™•ç†å‡½æ•¸ ====================

    // åŒ…è£ handleSave ä»¥é—œé–‰ modal
    const handleSave = (e) => {
        const success = taskDataHandleSave(e, editingTask, todayStr);
        if (success) {
            setIsModalOpen(false);
        }
    };

    // è§£æç›¸ä¾æ€§å­—ä¸²
    const parseDependencies = (depStr) => {
        if (!depStr || typeof depStr !== 'string') return [];
        return depStr.split(',').map(id => id.trim()).filter(id => id);
    };

    const changeMonth = (delta) => {
        const d = new Date(calendarMonth);
        d.setMonth(d.getMonth() + delta);
        setCalendarMonth(d);
    };

    // ==================== æº–å‚™ Context Value ====================

    const contextValue = {
        // Auth
        isAuthenticated, userApiKey, handleLogin, handleLogout,

        // UI State
        isModalOpen, setIsModalOpen,
        editingTask, setEditingTask,
        todayStr,
        calendarMonth, setCalendarMonth,
        isMobile,
        viewMode, setViewMode,

        // Master Data
        dynamicTeams, setDynamicTeams,
        dynamicProjects, setDynamicProjects,
        dynamicOwners, setDynamicOwners,
        TEAMS, PROJECTS, OWNERS,

        // Task Data (from useTaskData)
        tasks, setTasks,
        isLoading, isOffline, apiError, dataSource,
        uploadProgress, fileInputRef,
        handleFileUpload,
        handleSave: handleSave, // Use the wrapper
        handleDelete,

        // Filters & Stats (from useFilters)
        filterTeam, setFilterTeam,
        filterProject, setFilterProject,
        filterStat, toggleStatFilter,
        searchQuery, setSearchQuery,
        ganttFilterTeam, setGanttFilterTeam,
        showDependencies, setShowDependencies,
        highlightUrgent, setHighlightUrgent,
        hideCompleted, setHideCompleted,
        stats, filteredTasks, alerts, chartData
    };

    // ==================== æ¸²æŸ“è¦–åœ– ====================

    if (!isAuthenticated) {
        return <LoginScreen onLogin={handleLogin} />;
    }

    return (
        <AppProvider value={contextValue}>
            <div className="min-h-screen pb-10">
                {/* Header */}
                <div className="bg-white border-b sticky top-0 z-30 shadow-sm px-6 py-4 flex justify-between items-center">
                    <div className="flex items-center gap-3">
                        <div className="bg-indigo-600 text-white p-2 rounded-lg"><Icon path={paths.list} /></div>
                        <h1 className="text-xl font-bold text-slate-800">Project Tracker <span className="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full">v6.9</span></h1>
                        {isLoading && <div className="flex items-center text-sm text-slate-500 gap-2 ml-4"><div className="w-4 h-4 border-2 border-indigo-600 border-t-transparent rounded-full spinner"></div> è¼‰å…¥ä¸­...</div>}
                        {uploadProgress && <div className="flex items-center text-sm text-indigo-600 gap-2 ml-4 bg-indigo-50 px-2 py-1 rounded"><Icon path={paths.file} size={14} /> {uploadProgress}</div>}
                        {isOffline && dataSource === 'excel' && <div className="flex items-center text-sm text-emerald-600 gap-2 ml-4 bg-emerald-50 px-2 py-1 rounded"><Icon path={paths.file} size={14} /> Excel æ¨¡å¼</div>}
                        {isOffline && dataSource === 'google' && <div className="flex items-center text-sm text-red-500 gap-2 ml-4 bg-red-50 px-2 py-1 rounded"><Icon path={paths.alert} size={14} /> é›¢ç·š</div>}
                        <div className="text-xs bg-slate-100 text-slate-500 px-3 py-1 rounded-full hidden sm:block ml-4 flex items-center gap-1">
                            <Icon path={paths.clock} size={12} /> {todayStr}
                        </div>
                    </div>
                    <div className="flex items-center gap-4">
                        {/* è¦–åœ–åˆ‡æ›æŒ‰éˆ•çµ„ */}
                        <div className="bg-slate-100 p-1 rounded-lg flex gap-1">
                            <button onClick={() => setViewMode('dashboard')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center gap-2 ${viewMode === 'dashboard' ? 'bg-white text-indigo-600 shadow-md' : 'text-slate-600 hover:text-slate-900'}`} title="åˆ—è¡¨"><Icon path={paths.list} size={16} /><span className="hidden sm:inline">åˆ—è¡¨</span></button>
                            <button onClick={() => setViewMode('calendar')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center gap-2 ${viewMode === 'calendar' ? 'bg-white text-indigo-600 shadow-md' : 'text-slate-600 hover:text-slate-900'}`} title="æ—¥æ›†"><Icon path={paths.calendar} size={16} /><span className="hidden sm:inline">æ—¥æ›†</span></button>
                            <button onClick={() => setViewMode('gantt')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center gap-2 ${viewMode === 'gantt' ? 'bg-white text-indigo-600 shadow-md' : 'text-slate-600 hover:text-slate-900'}`} title="ç”˜ç‰¹åœ–"><Icon path={paths.gantt} size={16} /><span className="hidden sm:inline">ç”˜ç‰¹åœ–</span></button>
                            {hasPermission('admin') && (
                                <button onClick={() => setViewMode('settings')} className={`px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium transition-all duration-200 ${viewMode === 'settings' ? 'bg-indigo-100 text-indigo-700 shadow-sm ring-2 ring-indigo-200' : 'text-slate-600 hover:bg-slate-100 hover:text-slate-800'}`} title="è¨­å®š"><Icon path={paths.settings} size={16} /><span className="hidden sm:inline">è¨­å®š</span></button>
                            )}
                        </div>
                        <div className="w-px h-8 bg-slate-300"></div>
                        {/* Excel ä¸Šå‚³æŒ‰éˆ• */}
                        <button onClick={() => fileInputRef.current?.click()} className="bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium transition-all duration-200 shadow-md hover:shadow-lg hover:-translate-y-0.5"><Icon path={paths.file} size={16} /><span className="hidden sm:inline">ä¸Šå‚³ Excel</span></button>
                        <input ref={fileInputRef} type="file" accept=".xlsx,.xls,.csv" onChange={handleFileUpload} className="hidden" />
                        {/* ç™»å‡ºæŒ‰éˆ• */}
                        <button onClick={handleLogout} className="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium transition-all duration-200" title="ç™»å‡º"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg><span className="hidden sm:inline">ç™»å‡º</span></button>
                        <button onClick={() => { setEditingTask(null); setIsModalOpen(true); }} className="bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium transition-all duration-200 shadow-md hover:shadow-lg hover:-translate-y-0.5"><Icon path={paths.plus} size={16} /><span className="hidden sm:inline">æ–°å¢</span></button>
                    </div>
                </div>

                <div className="max-w-7xl mx-auto px-4 py-8">
                    {/* Alerts */}
                    {alerts.length > 0 && (
                        <div className="mb-6 grid gap-2">
                            {alerts.map((a, i) => (
                                <div key={i} className={`p-3 rounded-md border flex items-center gap-2 text-sm font-medium ${a.type === 'danger' ? 'bg-red-50 border-red-200 text-red-700' : 'bg-orange-50 border-orange-200 text-orange-700'}`}>
                                    <Icon path={paths.alert} size={16} /> {a.msg}
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Main Content */}
                    {viewMode === 'gantt' ? (
                        <>
                            <div className="bg-white rounded-lg border border-slate-200 shadow-sm p-4 space-y-3 mb-6">
                                <div className="relative">
                                    <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"><Icon path={paths.search} size={16} /></div>
                                    <input type="text" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} placeholder="æœå°‹ä»»å‹™æˆ–è² è²¬äºº..." className="w-full pl-10 pr-10 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none" />
                                    {searchQuery && <button onClick={() => setSearchQuery('')} className="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors"><Icon path={paths.x} size={16} /></button>}
                                </div>
                            </div>
                            <GanttView />
                        </>
                    ) : viewMode === 'settings' ? (
                        <SettingsView apiUrl={API_URL} />
                    ) : viewMode === 'calendar' ? (
                        <CalendarView />
                    ) : (
                        <Dashboard />
                    )}
                </div>

                {/* Modal */}
                {isModalOpen && (
                    <TaskModal
                        isOpen={isModalOpen}
                        onClose={() => setIsModalOpen(false)}
                        editingTask={editingTask}
                        onSubmit={handleSave}
                        TEAMS={TEAMS}
                        PROJECTS={PROJECTS}
                        OWNERS={OWNERS}
                        CATEGORIES={['Frontend', 'Backend', 'Database', 'DevOps', 'Testing', 'Design', 'Other']}
                    />
                )}
            </div>
        </AppProvider>
    );
};

    </script>

    <!-- ==================== å¤–éƒ¨çµ„ä»¶å¼•å…¥ ==================== -->
    <!-- Phase 1: ç³»çµ±ç®¡ç†ä»‹é¢ -->
    <script type="text/babel">
// ==================== Phase 1: ç³»çµ±ç®¡ç†ä»‹é¢çµ„ä»¶ ====================
// å°‡æ­¤ä»£ç¢¼æ’å…¥åˆ° index.html çš„ App çµ„ä»¶å®šç¾©ä¹‹å‰ï¼ˆç´„ç¬¬ 2100 è¡Œä¹‹å‰ï¼‰

// ===== Settings Iconï¼ˆå·²å®šç¾©åœ¨ paths ä¸­ï¼Œç¢ºèªæ˜¯å¦å­˜åœ¨ï¼‰=====

// ===== SettingsView ä¸»çµ„ä»¶ =====
const SettingsView = ({ apiUrl }) => {
    const [activeTab, setActiveTab] = useState('teams');
    const [teams, setTeams] = useState([]);
    const [projects, setProjects] = useState([]);
    const [owners, setOwners] = useState([]);
    const [loading, setLoading] = useState(false);

    // è¼‰å…¥æ‰€æœ‰è³‡æ–™
    useEffect(() => {
        loadAllData();
    }, []);

    const loadAllData = async () => {
        setLoading(true);
        try {
            await Promise.all([loadTeams(), loadProjects(), loadOwners()]);
        } catch (error) {
            console.error('âŒ è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
        } finally {
            setLoading(false);
        }
    };

    const loadTeams = async () => {
        try {
            const response = await fetch(`${apiUrl}?action=getTeams`);
            const data = await response.json();
            if (data.success) {
                setTeams(data.data);
                console.log('âœ… è¼‰å…¥ Teams:', data.data.length);
            }
        } catch (error) {
            console.error('âŒ è¼‰å…¥ Teams å¤±æ•—:', error);
        }
    };

    const loadProjects = async () => {
        try {
            const response = await fetch(`${apiUrl}?action=getProjects`);
            const data = await response.json();
            if (data.success) {
                setProjects(data.data);
                console.log('âœ… è¼‰å…¥ Projects:', data.data.length);
            }
        } catch (error) {
            console.error('âŒ è¼‰å…¥ Projects å¤±æ•—:', error);
        }
    };

    const loadOwners = async () => {
        try {
            const response = await fetch(`${apiUrl}?action=getOwners`);
            const data = await response.json();
            if (data.success) {
                setOwners(data.data);
                console.log('âœ… è¼‰å…¥ Owners:', data.data.length);
            }
        } catch (error) {
            console.error('âŒ è¼‰å…¥ Owners å¤±æ•—:', error);
        }
    };

    return (
        <div className="min-h-screen bg-slate-50 p-6">
            <div className="max-w-6xl mx-auto">
                {/* æ¨™é¡Œ */}
                <div className="mb-6">
                    <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                        <Icon path={paths.settings} size={28} />
                        ç³»çµ±è¨­å®š
                    </h1>
                    <p className="text-sm text-slate-500 mt-1">ç®¡ç†éƒ¨é–€ã€å°ˆæ¡ˆå’Œè² è²¬äºº</p>
                </div>

                {/* Tabs */}
                <div className="bg-white rounded-lg shadow-sm border border-slate-200 mb-6">
                    <div className="flex border-b border-slate-200">
                        <button
                            onClick={() => setActiveTab('teams')}
                            className={`px-6 py-3 text-sm font-medium transition ${activeTab === 'teams'
                                ? 'text-indigo-600 border-b-2 border-indigo-600'
                                : 'text-slate-600 hover:text-slate-800'
                                }`}
                        >
                            Teams (éƒ¨é–€)
                        </button>
                        <button
                            onClick={() => setActiveTab('projects')}
                            className={`px-6 py-3 text-sm font-medium transition ${activeTab === 'projects'
                                ? 'text-indigo-600 border-b-2 border-indigo-600'
                                : 'text-slate-600 hover:text-slate-800'
                                }`}
                        >
                            Projects (å°ˆæ¡ˆ)
                        </button>
                        <button
                            onClick={() => setActiveTab('owners')}
                            className={`px-6 py-3 text-sm font-medium transition ${activeTab === 'owners'
                                ? 'text-indigo-600 border-b-2 border-indigo-600'
                                : 'text-slate-600 hover:text-slate-800'
                                }`}
                        >
                            Owners (è² è²¬äºº)
                        </button>
                    </div>
                </div>

                {/* Content */}
                {loading ? (
                    <div className="text-center py-12">
                        <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                        <p className="mt-2 text-slate-500">è¼‰å…¥ä¸­...</p>
                    </div>
                ) : (
                    <>
                        {activeTab === 'teams' && (
                            <TeamsManager
                                teams={teams}
                                apiUrl={apiUrl}
                                onReload={loadTeams}
                            />
                        )}
                        {activeTab === 'projects' && (
                            <ProjectsManager
                                projects={projects}
                                apiUrl={apiUrl}
                                onReload={loadProjects}
                            />
                        )}
                        {activeTab === 'owners' && (
                            <OwnersManager
                                owners={owners}
                                apiUrl={apiUrl}
                                onReload={loadOwners}
                            />
                        )}
                    </>
                )}
            </div>
        </div>
    );
};

// ===== TeamsManager çµ„ä»¶ =====
const TeamsManager = ({ teams, apiUrl, onReload }) => {
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingItem, setEditingItem] = useState(null);
    const [deleteConfirm, setDeleteConfirm] = useState(null);

    const handleAdd = () => {
        setEditingItem(null);
        setIsModalOpen(true);
    };

    const handleEdit = (team) => {
        setEditingItem(team);
        setIsModalOpen(true);
    };

    const handleSave = async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const teamData = {
            teamName: formData.get('teamName'),
            deptCode: formData.get('deptCode'),
            isActive: formData.get('isActive') === 'on',
            apiKey: API_KEY  // ğŸ” æ¬Šé™é©—è­‰
        };

        if (editingItem) {
            teamData.id = editingItem.id;
        }

        try {
            const action = editingItem ? 'updateTeam' : 'addTeam';
            const response = await fetch(apiUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, data: teamData })
            });

            console.log(`âœ… ${editingItem ? 'æ›´æ–°' : 'æ–°å¢'} Team æˆåŠŸ`);
            setIsModalOpen(false);
            // å»¶é²é‡æ–°è¼‰å…¥
            setTimeout(() => onReload(), 1000);
        } catch (error) {
            console.error('âŒ å„²å­˜å¤±æ•—:', error);
            alert('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦');
        }
    };

    const handleDelete = async (id) => {
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'deleteTeam', data: { id, apiKey: API_KEY } })
            });

            console.log('âœ… åˆªé™¤ Team æˆåŠŸ');
            setDeleteConfirm(null);
            setTimeout(() => onReload(), 1000);
        } catch (error) {
            console.error('âŒ åˆªé™¤å¤±æ•—:', error);
            alert('åˆªé™¤å¤±æ•—ï¼Œè«‹é‡è©¦');
        }
    };

    return (
        <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
            {/* Header */}
            <div className="flex justify-between items-center mb-4">
                <h2 className="text-lg font-semibold text-slate-800">éƒ¨é–€ç®¡ç†</h2>
                <button
                    onClick={handleAdd}
                    className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-medium"
                >
                    <Icon path={paths.plus} size={16} />
                    æ–°å¢éƒ¨é–€
                </button>
            </div>

            {/* Table */}
            <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-slate-200">
                    <thead className="bg-slate-50">
                        <tr>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">ID</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">éƒ¨é–€åç¨±</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">ä»£ç¢¼</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">ç‹€æ…‹</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-slate-200">
                        {teams.map((team) => (
                            <tr key={team.id} className="hover:bg-slate-50">
                                <td className="px-4 py-3 text-sm text-slate-600">{team.id}</td>
                                <td className="px-4 py-3 text-sm font-medium text-slate-800">{team.teamName}</td>
                                <td className="px-4 py-3 text-sm text-slate-600">
                                    <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                                        {team.deptCode}
                                    </span>
                                </td>
                                <td className="px-4 py-3 text-sm">
                                    {team.isActive ? (
                                        <span className="text-green-600">âœ“ å•Ÿç”¨</span>
                                    ) : (
                                        <span className="text-slate-400">åœç”¨</span>
                                    )}
                                </td>
                                <td className="px-4 py-3 text-sm">
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => handleEdit(team)}
                                            className="text-indigo-600 hover:text-indigo-800"
                                            title="ç·¨è¼¯"
                                        >
                                            <Icon path={paths.edit} size={16} />
                                        </button>
                                        <button
                                            onClick={() => setDeleteConfirm(team)}
                                            className="text-red-600 hover:text-red-800"
                                            title="åˆªé™¤"
                                        >
                                            <Icon path={paths.trash} size={16} />
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* Modal */}
            {isModalOpen && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 w-full max-w-md">
                        <h3 className="text-lg font-semibold mb-4">
                            {editingItem ? 'ç·¨è¼¯éƒ¨é–€' : 'æ–°å¢éƒ¨é–€'}
                        </h3>
                        <form onSubmit={handleSave}>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">
                                        éƒ¨é–€åç¨± *
                                    </label>
                                    <input
                                        type="text"
                                        name="teamName"
                                        defaultValue={editingItem?.teamName}
                                        required
                                        className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">
                                        éƒ¨é–€ä»£ç¢¼ *
                                    </label>
                                    <input
                                        type="text"
                                        name="deptCode"
                                        defaultValue={editingItem?.deptCode}
                                        required
                                        maxLength={4}
                                        className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none uppercase"
                                    />
                                    <p className="text-xs text-slate-500 mt-1">2-4å€‹å¤§å¯«å­—æ¯</p>
                                </div>
                                <div className="flex items-center">
                                    <input
                                        type="checkbox"
                                        name="isActive"
                                        id="teamActive"
                                        defaultChecked={editingItem?.isActive !== false}
                                        className="w-4 h-4 text-indigo-600 border-gray-300 rounded"
                                    />
                                    <label htmlFor="teamActive" className="ml-2 text-sm text-slate-700">
                                        å•Ÿç”¨
                                    </label>
                                </div>
                            </div>
                            <div className="flex justify-end gap-2 mt-6">
                                <button
                                    type="button"
                                    onClick={() => setIsModalOpen(false)}
                                    className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg"
                                >
                                    å–æ¶ˆ
                                </button>
                                <button
                                    type="submit"
                                    className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                >
                                    å„²å­˜
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Delete Confirm */}
            {deleteConfirm && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 w-full max-w-sm">
                        <h3 className="text-lg font-semibold mb-2">ç¢ºèªåˆªé™¤</h3>
                        <p className="text-sm text-slate-600 mb-4">
                            ç¢ºå®šè¦åˆªé™¤ã€Œ{deleteConfirm.teamName}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚
                        </p>
                        <div className="flex justify-end gap-2">
                            <button
                                onClick={() => setDeleteConfirm(null)}
                                className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg"
                            >
                                å–æ¶ˆ
                            </button>
                            <button
                                onClick={() => handleDelete(deleteConfirm.id)}
                                className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                            >
                                åˆªé™¤
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};



// ===== ProjectsManager çµ„ä»¶ =====
const ProjectsManager = ({ projects, apiUrl, onReload }) => {
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingItem, setEditingItem] = useState(null);
    const [deleteConfirm, setDeleteConfirm] = useState(null);

    const handleAdd = () => {
        setEditingItem(null);
        setIsModalOpen(true);
    };

    const handleEdit = (project) => {
        setEditingItem(project);
        setIsModalOpen(true);
    };

    const handleSave = async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const projectData = {
            projectName: formData.get('projectName'),
            status: formData.get('status'),
            description: formData.get('description') || '',
            apiKey: API_KEY  // ğŸ” æ¬Šé™é©—è­‰
        };

        if (editingItem) {
            projectData.id = editingItem.id;
        }

        try {
            const action = editingItem ? 'updateProject' : 'addProject';
            const response = await fetch(apiUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, data: projectData })
            });

            console.log(`âœ… ${editingItem ? 'æ›´æ–°' : 'æ–°å¢'} Project æˆåŠŸ`);
            setIsModalOpen(false);
            setTimeout(() => onReload(), 1000);
        } catch (error) {
            console.error('âŒ å„²å­˜å¤±æ•—:', error);
            alert('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦');
        }
    };

    const handleDelete = async (id) => {
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'deleteProject', data: { id, apiKey: API_KEY } })
            });

            console.log('âœ… åˆªé™¤ Project æˆåŠŸ');
            setDeleteConfirm(null);
            setTimeout(() => onReload(), 1000);
        } catch (error) {
            console.error('âŒ åˆªé™¤å¤±æ•—:', error);
            alert('åˆªé™¤å¤±æ•—ï¼Œè«‹é‡è©¦');
        }
    };

    return (
        <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
            {/* Header */}
            <div className="flex justify-between items-center mb-4">
                <h2 className="text-lg font-semibold text-slate-800">å°ˆæ¡ˆç®¡ç†</h2>
                <button
                    onClick={handleAdd}
                    className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-medium"
                >
                    <Icon path={paths.plus} size={16} />
                    æ–°å¢å°ˆæ¡ˆ
                </button>
            </div>

            {/* Table */}
            <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-slate-200">
                    <thead className="bg-slate-50">
                        <tr>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">ID</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">å°ˆæ¡ˆåç¨±</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">ç‹€æ…‹</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">èªªæ˜</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-slate-200">
                        {projects.map((project) => (
                            <tr key={project.id} className="hover:bg-slate-50">
                                <td className="px-4 py-3 text-sm text-slate-600">{project.id}</td>
                                <td className="px-4 py-3 text-sm font-medium text-slate-800">{project.projectName}</td>
                                <td className="px-4 py-3 text-sm">
                                    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${project.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-slate-100 text-slate-600'
                                        }`}>
                                        {project.status}
                                    </span>
                                </td>
                                <td className="px-4 py-3 text-sm text-slate-600">{project.description || '-'}</td>
                                <td className="px-4 py-3 text-sm">
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => handleEdit(project)}
                                            className="text-indigo-600 hover:text-indigo-800"
                                            title="ç·¨è¼¯"
                                        >
                                            <Icon path={paths.edit} size={16} />
                                        </button>
                                        <button
                                            onClick={() => setDeleteConfirm(project)}
                                            className="text-red-600 hover:text-red-800"
                                            title="åˆªé™¤"
                                        >
                                            <Icon path={paths.trash} size={16} />
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* Modal */}
            {isModalOpen && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 w-full max-w-md">
                        <h3 className="text-lg font-semibold mb-4">
                            {editingItem ? 'ç·¨è¼¯å°ˆæ¡ˆ' : 'æ–°å¢å°ˆæ¡ˆ'}
                        </h3>
                        <form onSubmit={handleSave}>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">
                                        å°ˆæ¡ˆåç¨± *
                                    </label>
                                    <input
                                        type="text"
                                        name="projectName"
                                        defaultValue={editingItem?.projectName}
                                        required
                                        className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">
                                        ç‹€æ…‹
                                    </label>
                                    <select
                                        name="status"
                                        defaultValue={editingItem?.status || 'Active'}
                                        className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none"
                                    >
                                        <option value="Active">Active</option>
                                        <option value="Completed">Completed</option>
                                        <option value="On Hold">On Hold</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">
                                        èªªæ˜
                                    </label>
                                    <textarea
                                        name="description"
                                        defaultValue={editingItem?.description}
                                        rows="3"
                                        className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none"
                                    />
                                </div>
                            </div>
                            <div className="flex justify-end gap-2 mt-6">
                                <button
                                    type="button"
                                    onClick={() => setIsModalOpen(false)}
                                    className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg"
                                >
                                    å–æ¶ˆ
                                </button>
                                <button
                                    type="submit"
                                    className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                >
                                    å„²å­˜
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Delete Confirm */}
            {deleteConfirm && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 w-full max-w-sm">
                        <h3 className="text-lg font-semibold mb-2">ç¢ºèªåˆªé™¤</h3>
                        <p className="text-sm text-slate-600 mb-4">
                            ç¢ºå®šè¦åˆªé™¤ã€Œ{deleteConfirm.projectName}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚
                        </p>
                        <div className="flex justify-end gap-2">
                            <button
                                onClick={() => setDeleteConfirm(null)}
                                className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg"
                            >
                                å–æ¶ˆ
                            </button>
                            <button
                                onClick={() => handleDelete(deleteConfirm.id)}
                                className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                            >
                                åˆªé™¤
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

// ===== OwnersManager çµ„ä»¶ =====
const OwnersManager = ({ owners, apiUrl, onReload }) => {
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingItem, setEditingItem] = useState(null);
    const [deleteConfirm, setDeleteConfirm] = useState(null);

    const handleAdd = () => {
        setEditingItem(null);
        setIsModalOpen(true);
    };

    const handleEdit = (owner) => {
        setEditingItem(owner);
        setIsModalOpen(true);
    };

    const handleSave = async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const ownerData = {
            ownerName: formData.get('ownerName'),
            email: formData.get('email') || '',
            isActive: formData.get('isActive') === 'on',
            apiKey: API_KEY  // ğŸ” æ¬Šé™é©—è­‰
        };

        if (editingItem) {
            ownerData.id = editingItem.id;
        }

        try {
            const action = editingItem ? 'updateOwner' : 'addOwner';
            const response = await fetch(apiUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, data: ownerData })
            });

            console.log(`âœ… ${editingItem ? 'æ›´æ–°' : 'æ–°å¢'} Owner æˆåŠŸ`);
            setIsModalOpen(false);
            setTimeout(() => onReload(), 1000);
        } catch (error) {
            console.error('âŒ å„²å­˜å¤±æ•—:', error);
            alert('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦');
        }
    };

    const handleDelete = async (id) => {
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'deleteOwner', data: { id, apiKey: API_KEY } })
            });

            console.log('âœ… åˆªé™¤ Owner æˆåŠŸ');
            setDeleteConfirm(null);
            setTimeout(() => onReload(), 1000);
        } catch (error) {
            console.error('âŒ åˆªé™¤å¤±æ•—:', error);
            alert('åˆªé™¤å¤±æ•—ï¼Œè«‹é‡è©¦');
        }
    };

    return (
        <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
            {/* Header */}
            <div className="flex justify-between items-center mb-4">
                <h2 className="text-lg font-semibold text-slate-800">è² è²¬äººç®¡ç†</h2>
                <button
                    onClick={handleAdd}
                    className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-medium"
                >
                    <Icon path={paths.plus} size={16} />
                    æ–°å¢è² è²¬äºº
                </button>
            </div>

            {/* Table */}
            <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-slate-200">
                    <thead className="bg-slate-50">
                        <tr>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">ID</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">å§“å</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Email</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">ç‹€æ…‹</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-slate-200">
                        {owners.map((owner) => (
                            <tr key={owner.id} className="hover:bg-slate-50">
                                <td className="px-4 py-3 text-sm text-slate-600">{owner.id}</td>
                                <td className="px-4 py-3 text-sm font-medium text-slate-800">{owner.ownerName}</td>
                                <td className="px-4 py-3 text-sm text-slate-600">{owner.email || '-'}</td>
                                <td className="px-4 py-3 text-sm">
                                    {owner.isActive ? (
                                        <span className="text-green-600">âœ“ å•Ÿç”¨</span>
                                    ) : (
                                        <span className="text-slate-400">åœç”¨</span>
                                    )}
                                </td>
                                <td className="px-4 py-3 text-sm">
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => handleEdit(owner)}
                                            className="text-indigo-600 hover:text-indigo-800"
                                            title="ç·¨è¼¯"
                                        >
                                            <Icon path={paths.edit} size={16} />
                                        </button>
                                        <button
                                            onClick={() => setDeleteConfirm(owner)}
                                            className="text-red-600 hover:text-red-800"
                                            title="åˆªé™¤"
                                        >
                                            <Icon path={paths.trash} size={16} />
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* Modal */}
            {isModalOpen && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 w-full max-w-md">
                        <h3 className="text-lg font-semibold mb-4">
                            {editingItem ? 'ç·¨è¼¯è² è²¬äºº' : 'æ–°å¢è² è²¬äºº'}
                        </h3>
                        <form onSubmit={handleSave}>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">
                                        å§“å *
                                    </label>
                                    <input
                                        type="text"
                                        name="ownerName"
                                        defaultValue={editingItem?.ownerName}
                                        required
                                        className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">
                                        Email
                                    </label>
                                    <input
                                        type="email"
                                        name="email"
                                        defaultValue={editingItem?.email}
                                        className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none"
                                    />
                                </div>
                                <div className="flex items-center">
                                    <input
                                        type="checkbox"
                                        name="isActive"
                                        id="ownerActive"
                                        defaultChecked={editingItem?.isActive !== false}
                                        className="w-4 h-4 text-indigo-600 border-gray-300 rounded"
                                    />
                                    <label htmlFor="ownerActive" className="ml-2 text-sm text-slate-700">
                                        å•Ÿç”¨
                                    </label>
                                </div>
                            </div>
                            <div className="flex justify-end gap-2 mt-6">
                                <button
                                    type="button"
                                    onClick={() => setIsModalOpen(false)}
                                    className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg"
                                >
                                    å–æ¶ˆ
                                </button>
                                <button
                                    type="submit"
                                    className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                >
                                    å„²å­˜
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Delete Confirm */}
            {deleteConfirm && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 w-full max-w-sm">
                        <h3 className="text-lg font-semibold mb-2">ç¢ºèªåˆªé™¤</h3>
                        <p className="text-sm text-slate-600 mb-4">
                            ç¢ºå®šè¦åˆªé™¤ã€Œ{deleteConfirm.ownerName}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚
                        </p>
                        <div className="flex justify-end gap-2">
                            <button
                                onClick={() => setDeleteConfirm(null)}
                                className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg"
                            >
                                å–æ¶ˆ
                            </button>
                            <button
                                onClick={() => handleDelete(deleteConfirm.id)}
                                className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                            >
                                åˆªé™¤
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

window.SettingsView = SettingsView;

</script>

    <!-- ==================== æ‡‰ç”¨å•Ÿå‹• ==================== -->
    <script type="text/babel">
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

</body>

</html>