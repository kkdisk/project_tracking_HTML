<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ë≥áÊñôÈÅ∑ÁßªÂ∑•ÂÖ∑ - Project Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/config.js"></script>
</head>

<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
    <div id="app"></div>

    <script type="text/babel">
        const { useState } = React;

        const MigrationTool = () => {
            const [step, setStep] = useState(1);
            const [transformedData, setTransformedData] = useState([]);
            const [loading, setLoading] = useState(false);
            const [progress, setProgress] = useState(0);
            const [log, setLog] = useState([]);
            const [conflicts, setConflicts] = useState([]);
            const [stats, setStats] = useState({ total: 0, success: 0, failed: 0, skipped: 0 });

            const OLD_API = 'https://script.google.com/macros/s/AKfycbwJlnYQmCqnQlfl5cGnHc9NLqsu0A7TMkAFXE78KpkylJ0dNbwjw-qN3Faaop3Yr-sn/exec';

            const categoryToTeam = {
                'Mechanism': 'Ê©üÊßã',
                'Software': 'ËªüÈ´î',
                'Electrical': 'ÈõªÊéß',
                'Flow': 'ÊµÅÈÅì',
                'QA': 'QA',
                'Design': 'Êô∂Áâá'
            };

            const statusMap = {
                'InProgress': 'In Progress',
                'Todo': 'Todo',
                'Done': 'Done',
                'Closed': 'Closed'
            };

            const calculateStartDate = (endDate, duration) => {
                const date = new Date(endDate);
                date.setDate(date.getDate() - duration);
                return date.toISOString().split('T')[0];
            };

            const transformTask = (oldTask) => {
                const date = new Date(oldTask.date).toISOString().split('T')[0];
                const startDate = calculateStartDate(date, oldTask.duration);

                return {
                    id: oldTask.id,
                    legacy_id: '',
                    team: categoryToTeam[oldTask.category] || oldTask.category,
                    project: oldTask.project,
                    purpose: '',
                    task: oldTask.task,
                    owner: oldTask.owner,
                    issueDate: '',
                    startDate: startDate,
                    date: date,
                    duration: oldTask.duration,
                    status: statusMap[oldTask.status] || oldTask.status,
                    priority: oldTask.priority,
                    dependency: oldTask.dependency || '',
                    verification: '',
                    notes: oldTask.notes || '',
                    isCheckpoint: oldTask.isCheckpoint,
                    issuePool: false,
                    impact: 'Medium',
                    risk: 'Low',
                    urgency: 'Medium',
                    category: oldTask.category
                };
            };

            // ÊâãÂãïËºâÂÖ• JSONÔºàÁπûÈÅé CORSÔºâ
            const loadDataFromJSON = (jsonText) => {
                setLoading(true);
                addLog('ÈñãÂßãËß£Êûê JSON Ë≥áÊñô...');

                try {
                    const data = JSON.parse(jsonText);

                    if (!Array.isArray(data)) {
                        throw new Error('JSON Ê†ºÂºèÈåØË™§ÔºöÊáâË©≤ÊòØÈô£Âàó');
                    }

                    addLog(`‚úÖ ÊàêÂäüËºâÂÖ• ${data.length} Á≠ÜË≥áÊñô`);

                    const transformed = data.map(transformTask);
                    setTransformedData(transformed);
                    addLog(`‚úÖ Ë≥áÊñôËΩâÊèõÂÆåÊàê`);

                    checkConflicts(transformed);

                    setStep(2);
                } catch (error) {
                    addLog(`‚ùå Ëß£ÊûêÂ§±Êïó: ${error.message}`, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const checkConflicts = async (data) => {
                addLog('Ê™¢Êü• ID Ë°ùÁ™Å...');
                try {
                    const response = await fetch(API_URL);
                    const result = await response.json();

                    if (result.success && result.data) {
                        const existingIds = new Set(result.data.map(t => t.id));
                        const conflictIds = data.filter(t => existingIds.has(t.id));

                        setConflicts(conflictIds);

                        if (conflictIds.length > 0) {
                            addLog(`‚ö†Ô∏è ÁôºÁèæ ${conflictIds.length} Á≠Ü ID Ë°ùÁ™Å`, 'warning');
                        } else {
                            addLog(`‚úÖ ÁÑ° ID Ë°ùÁ™Å`);
                        }
                    }
                } catch (error) {
                    addLog(`‚ö†Ô∏è Ë°ùÁ™ÅÊ™¢Êü•Â§±Êïó: ${error.message}`, 'warning');
                }
            };

            const executeImport = async () => {
                setLoading(true);
                setStep(3);
                addLog('ÈñãÂßãÂåØÂÖ•Ë≥áÊñô...');

                const importStats = { total: transformedData.length, success: 0, failed: 0, skipped: 0 };
                const conflictIdSet = new Set(conflicts.map(c => c.id));

                for (let i = 0; i < transformedData.length; i++) {
                    const task = transformedData[i];
                    setProgress(Math.round((i / transformedData.length) * 100));

                    if (conflictIdSet.has(task.id)) {
                        importStats.skipped++;
                        addLog(`‚è≠Ô∏è Ë∑≥ÈÅéË°ùÁ™Å ID: ${task.id} - ${task.task}`, 'warning');
                        continue;
                    }

                    try {
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'addTask',
                                apiKey: API_KEY,
                                ...task
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            importStats.success++;
                            addLog(`‚úÖ [${i + 1}/${transformedData.length}] ${task.task}`);
                        } else {
                            importStats.failed++;
                            addLog(`‚ùå [${i + 1}/${transformedData.length}] ${task.task}: ${result.error}`, 'error');
                        }
                    } catch (error) {
                        importStats.failed++;
                        addLog(`‚ùå [${i + 1}/${transformedData.length}] ${task.task}: ${error.message}`, 'error');
                    }

                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                setProgress(100);
                setStats(importStats);
                setLoading(false);
                addLog(`\nüìä ÂåØÂÖ•ÂÆåÊàêÔºÅÁ∏ΩË®à: ${importStats.total}, ÊàêÂäü: ${importStats.success}, Â§±Êïó: ${importStats.failed}, Ë∑≥ÈÅé: ${importStats.skipped}`);
            };

            const addLog = (message, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString('zh-TW');
                setLog(prev => [...prev, { time: timestamp, message, type }]);
            };

            return (
                <div className="container mx-auto px-4 py-8 max-w-6xl">
                    <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <h1 className="text-3xl font-bold text-slate-800 flex items-center gap-3">
                                    <span>üîÑ</span>
                                    Ë≥áÊñôÈÅ∑ÁßªÂ∑•ÂÖ∑
                                </h1>
                                <p className="text-slate-600 mt-2">ÂæûËàä API ÈÅ∑ÁßªË≥áÊñôÂà∞ Project Tracker</p>
                            </div>
                            <a href="index.html" className="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 transition-colors">
                                ËøîÂõû‰∏ªÈ†Å
                            </a>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div className="flex items-center justify-between">
                            {[
                                { num: 1, label: 'ËºâÂÖ•Ë≥áÊñô', icon: 'üì•' },
                                { num: 2, label: 'È†êË¶ΩÁ¢∫Ë™ç', icon: 'üëÅÔ∏è' },
                                { num: 3, label: 'Âü∑Ë°åÂåØÂÖ•', icon: '‚ö°' }
                            ].map((s, i) => (
                                <div key={s.num} className="flex items-center flex-1">
                                    <div className={`flex flex-col items-center ${step >= s.num ? 'opacity-100' : 'opacity-40'}`}>
                                        <div className={`w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold ${step > s.num ? 'bg-green-500 text-white' :
                                                step === s.num ? 'bg-indigo-600 text-white' :
                                                    'bg-slate-200 text-slate-500'
                                            }`}>
                                            {step > s.num ? '‚úì' : s.icon}
                                        </div>
                                        <span className="mt-2 text-sm font-medium text-slate-700">{s.label}</span>
                                    </div>
                                    {i < 2 && (
                                        <div className={`flex-1 h-1 mx-4 ${step > s.num ? 'bg-green-500' : 'bg-slate-200'}`}></div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Step 1 */}
                    {step === 1 && (
                        <div className="bg-white rounded-xl shadow-lg p-8">
                            <div className="text-center mb-6">
                                <div className="text-6xl mb-4">üì•</div>
                                <h2 className="text-2xl font-bold text-slate-800 mb-2">ËºâÂÖ•ËàäË≥áÊñô</h2>
                                <p className="text-slate-600">Ë´ãÂæûËàä API Ë§áË£Ω JSON Êï∏Êìö‰∏¶Ë≤ºÂà∞‰∏ãÊñπ</p>
                            </div>

                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                                <h3 className="font-bold text-blue-900 mb-2">üìù Êìç‰ΩúÊ≠•È©üÔºö</h3>
                                <ol className="text-sm text-blue-800 space-y-1 list-decimal list-inside">
                                    <li>ÊâìÈñãËàä APIÔºö<a href={OLD_API} target="_blank" className="underline text-blue-600">ÈªûÊìäÈÄôË£°</a></li>
                                    <li>Ë§áË£ΩÊï¥ÂÄã JSON Êï∏ÊìöÔºàÂæû <code className="bg-blue-100 px-1">[</code> Âà∞ <code className="bg-blue-100 px-1">]</code>Ôºâ</li>
                                    <li>Ë≤ºÂà∞‰∏ãÊñπÊñáÊú¨Ê°Ü</li>
                                    <li>ÈªûÊìä„ÄåÈñãÂßãËß£Êûê„Äç</li>
                                </ol>
                            </div>

                            <textarea
                                id="jsonInput"
                                className="w-full h-64 p-4 border-2 border-slate-300 rounded-lg font-mono text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"
                                placeholder='Ë≤º‰∏ä JSON Êï∏ÊìöÔºå‰æãÂ¶Ç:\n[\n  {"id": 123, "project": "Machine", "task": "...", ...},\n  ...\n]'
                            ></textarea>

                            <button
                                onClick={() => {
                                    const jsonText = document.getElementById('jsonInput').value;
                                    if (!jsonText.trim()) {
                                        alert('Ë´ãÂÖàË≤º‰∏ä JSON Êï∏Êìö');
                                        return;
                                    }
                                    loadDataFromJSON(jsonText);
                                }}
                                disabled={loading}
                                className={`mt-4 w-full px-8 py-3 rounded-lg font-bold text-white transition-all ${loading ? 'bg-slate-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 hover:shadow-lg'
                                    }`}
                            >
                                {loading ? 'Ëß£Êûê‰∏≠...' : 'ÈñãÂßãËß£Êûê'}
                            </button>
                        </div>
                    )}

                    {/* Step 2 */}
                    {step === 2 && (
                        <div className="space-y-6">
                            <div className="grid grid-cols-3 gap-4">
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <div className="text-sm text-blue-600 font-medium">Á∏ΩÁ≠ÜÊï∏</div>
                                    <div className="text-3xl font-bold text-blue-700">{transformedData.length}</div>
                                </div>
                                <div className="bg-orange-50 border border-orange-200 rounded-lg p-4">
                                    <div className="text-sm text-orange-600 font-medium">ID Ë°ùÁ™Å</div>
                                    <div className="text-3xl font-bold text-orange-700">{conflicts.length}</div>
                                </div>
                                <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                    <div className="text-sm text-green-600 font-medium">ÂèØÂåØÂÖ•</div>
                                    <div className="text-3xl font-bold text-green-700">{transformedData.length - conflicts.length}</div>
                                </div>
                            </div>

                            <div className="bg-white rounded-xl shadow-lg p-6">
                                <h3 className="text-lg font-bold text-slate-800 mb-4">Ë≥áÊñôÈ†êË¶ΩÔºàÂâç 10 Á≠ÜÔºâ</h3>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead className="bg-slate-50">
                                            <tr>
                                                <th className="px-4 py-2 text-left">ID</th>
                                                <th className="px-4 py-2 text-left">Team</th>
                                                <th className="px-4 py-2 text-left">Project</th>
                                                <th className="px-4 py-2 text-left">Task</th>
                                                <th className="px-4 py-2 text-left">Owner</th>
                                                <th className="px-4 py-2 text-left">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {transformedData.slice(0, 10).map((task, i) => {
                                                const isConflict = conflicts.some(c => c.id === task.id);
                                                return (
                                                    <tr key={i} className={isConflict ? 'bg-orange-50' : 'hover:bg-slate-50'}>
                                                        <td className="px-4 py-2 text-xs">{task.id}</td>
                                                        <td className="px-4 py-2">{task.team}</td>
                                                        <td className="px-4 py-2">{task.project}</td>
                                                        <td className="px-4 py-2">{task.task}</td>
                                                        <td className="px-4 py-2">{task.owner}</td>
                                                        <td className="px-4 py-2">{task.status}</td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div className="flex gap-4 justify-center">
                                <button
                                    onClick={() => setStep(1)}
                                    className="px-6 py-3 bg-slate-200 text-slate-700 rounded-lg font-bold hover:bg-slate-300 transition-colors"
                                >
                                    ÈáçÊñ∞ËºâÂÖ•
                                </button>
                                <button
                                    onClick={executeImport}
                                    disabled={loading}
                                    className={`px-8 py-3 rounded-lg font-bold text-white transition-all ${loading ? 'bg-slate-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700 hover:shadow-lg'
                                        }`}
                                >
                                    Á¢∫Ë™ç‰∏¶Âü∑Ë°åÂåØÂÖ•
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Step 3 */}
                    {step === 3 && (
                        <div className="space-y-6">
                            <div className="bg-white rounded-xl shadow-lg p-6">
                                <h3 className="text-lg font-bold text-slate-800 mb-4">ÂåØÂÖ•ÈÄ≤Â∫¶</h3>
                                <div className="mb-4">
                                    <div className="flex justify-between text-sm text-slate-600 mb-2">
                                        <span>ÈÄ≤Â∫¶</span>
                                        <span>{progress}%</span>
                                    </div>
                                    <div className="h-4 bg-slate-200 rounded-full overflow-hidden">
                                        <div
                                            className="h-full bg-gradient-to-r from-indigo-500 to-indigo-600 transition-all duration-300"
                                            style={{ width: `${progress}%` }}
                                        ></div>
                                    </div>
                                </div>

                                {!loading && progress === 100 && (
                                    <div className="grid grid-cols-4 gap-4 mt-6">
                                        <div className="text-center p-4 bg-blue-50 rounded-lg">
                                            <div className="text-2xl font-bold text-blue-700">{stats.total}</div>
                                            <div className="text-sm text-blue-600">Á∏ΩË®à</div>
                                        </div>
                                        <div className="text-center p-4 bg-green-50 rounded-lg">
                                            <div className="text-2xl font-bold text-green-700">{stats.success}</div>
                                            <div className="text-sm text-green-600">ÊàêÂäü</div>
                                        </div>
                                        <div className="text-center p-4 bg-red-50 rounded-lg">
                                            <div className="text-2xl font-bold text-red-700">{stats.failed}</div>
                                            <div className="text-sm text-red-600">Â§±Êïó</div>
                                        </div>
                                        <div className="text-center p-4 bg-orange-50 rounded-lg">
                                            <div className="text-2xl font-bold text-orange-700">{stats.skipped}</div>
                                            <div className="text-sm text-orange-600">Ë∑≥ÈÅé</div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {!loading && progress === 100 && (
                                <div className="text-center">
                                    <a
                                        href="index.html"
                                        className="inline-block px-8 py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 hover:shadow-lg transition-all"
                                    >
                                        ÂâçÂæÄ Project Tracker Êü•Áúã
                                    </a>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Log Console */}
                    {log.length > 0 && (
                        <div className="bg-slate-900 rounded-xl shadow-lg p-6 mt-6">
                            <h3 className="text-lg font-bold text-white mb-4">Âü∑Ë°åÊó•Ë™å</h3>
                            <div className="bg-black rounded-lg p-4 h-64 overflow-y-auto font-mono text-sm">
                                {log.map((entry, i) => (
                                    <div key={i} className={`mb-1 ${entry.type === 'error' ? 'text-red-400' :
                                            entry.type === 'warning' ? 'text-yellow-400' :
                                                'text-green-400'
                                        }`}>
                                        <span className="text-slate-500">[{entry.time}]</span> {entry.message}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<MigrationTool />, document.getElementById('app'));
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</body>

</html>