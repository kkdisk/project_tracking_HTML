<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Tracker v6.8 </title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>

    <!-- Prop Types -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>

    <!-- Recharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.10.3/Recharts.min.js"></script>

    <!-- Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <!-- SheetJS for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Data Converter - 強制重新載入修復後的版本 -->
    <script src="js/data_converter.js?v=13101322"></script>

    <!-- 立即覆寫 normalizeDate 函數以修復 Excel 日期問題 -->
    <script>
        // 強制刪除舊版本（如果存在）
        if (typeof normalizeDate !== 'undefined') {
            try {
                delete window.normalizeDate;
                // 也嘗試刪除全域作用域中的定義
                if (typeof normalizeDate !== 'undefined') {
                    normalizeDate = undefined;
                }
            } catch (e) {
                console.warn('[FIX] 無法刪除舊 normalizeDate:', e);
            }
        }

        // 定義新的 normalizeDate 函數（支援 Excel 序列號 + ISO 字串）
        window.normalizeDate = function (dateInput) {
            if (!dateInput && dateInput !== 0) return '';

            // 已經是 YYYY-MM-DD 格式
            if (typeof dateInput === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateInput)) {
                return dateInput;
            }

            try {
                let date;

                // 處理 Excel 日期序列號（數字類型）
                if (typeof dateInput === 'number') {
                    console.log('[FIX] 處理 Excel 序列號:', dateInput);
                    // Excel 的日期序列號基準是 1900-01-01
                    const excelEpoch = new Date(1899, 11, 30); // 1899-12-30
                    const milliseconds = dateInput * 86400000;
                    date = new Date(excelEpoch.getTime() + milliseconds);
                    console.log('[FIX] 轉換結果:', date.toISOString());
                } else if (typeof dateInput === 'string') {
                    // 處理 ISO 字串（Google Sheets）或其他日期字串
                    console.log('[FIX] 處理日期字串:', dateInput);
                    date = new Date(dateInput);

                    // 如果是 ISO 字串格式（含時區），需要調整為當地日期
                    if (/^\d{4}-\d{2}-\d{2}T/.test(dateInput)) {
                        // ISO 字串包含時間，可能有時區問題
                        // 使用 UTC 日期部分避免時區轉換
                        const utcDate = new Date(dateInput);
                        date = new Date(utcDate.getUTCFullYear(), utcDate.getUTCMonth(), utcDate.getUTCDate());
                        console.log('[FIX] ISO 字串調整為本地日期:', date);
                    }
                } else {
                    // 其他類型嘗試直接解析
                    date = new Date(dateInput);
                }

                if (isNaN(date.getTime())) {
                    console.warn('[FIX] 無法解析:', dateInput);
                    return '';
                }

                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const result = `${year}-${month}-${day}`;
                console.log('[FIX] 最終結果:', result);
                return result;
            } catch (e) {
                console.error('[FIX] 錯誤:', dateInput, e);
                return '';
            }
        };

        // 強制設置為全域函數（多種方式確保生效）
        if (typeof window !== 'undefined') {
            window.normalizeDate = window.normalizeDate;
        }
        if (typeof global !== 'undefined') {
            global.normalizeDate = window.normalizeDate;
        }
        // 直接賦值到全域作用域
        normalizeDate = window.normalizeDate;

        console.log('[FIX] normalizeDate 已強制覆寫，測試:', normalizeDate(45672));
    </script>

    <style>
        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8fafc;
            margin: 0;
            padding: 0;
        }

        .toggle-checkbox:checked {
            right: 0;
            border-color: #6366f1;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #6366f1;
        }

        .checkbox-container {
            position: relative;
            width: 40px;
            height: 24px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        .calendar-cell {
            min-height: 100px;
            transition: all 0.2s;
        }

        .calendar-cell:hover {
            background-color: #f1f5f9;
        }

        /* --- Gantt Layout (Fixed) --- */
        .gantt-container {
            position: relative;
            overflow: auto;
            height: 100%;
        }

        .gantt-wrapper {
            flex: 1;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .gantt-header-row {
            display: flex;
            position: sticky;
            top: 0;
            z-index: 50;
            background: #f8fafc;
        }

        .gantt-body {
            overflow: auto;
            flex: 1;
        }

        /* Headers */
        .gantt-header-task {
            position: sticky;
            left: 0;
            z-index: 40;
            background-color: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            font-weight: bold;
            padding: 8px;
            height: 60px;
            display: flex;
            align-items: center;
            border-right: 1px solid #e2e8f0;
            width: 200px;
            flex-shrink: 0;
        }

        .gantt-header-timeline {
            position: sticky;
            top: 0;
            z-index: 30;
            background-color: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            height: 60px;
            display: flex;
            flex-direction: column;
        }

        .gantt-header-wrapper {
            display: flex;
            width: max-content;
        }

        .gantt-header-month-row {
            height: 30px;
            display: flex;
            border-bottom: 1px solid #e2e8f0;
        }

        .gantt-header-day-row {
            height: 30px;
            display: flex;
        }

        .gantt-month-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: #475569;
            border-right: 1px solid #e2e8f0;
            box-sizing: border-box;
        }

        .gantt-day-cell {
            border-right: 1px solid #f1f5f9;
            height: 100%;
            text-align: center;
            font-size: 0.7rem;
            padding-top: 4px;
            box-sizing: border-box;
            color: #64748b;
        }

        .is-weekend {
            background-color: #f8fafc;
        }

        /* Body */
        .gantt-body-content {
            position: relative;
            width: max-content;
            min-width: 100%;
        }

        /* Row (Crucial Fix: display: flex) */
        .gantt-row {
            display: flex;
            height: 40px;
            border-bottom: 1px solid #f1f5f9;
            background-color: #fff;
            position: relative;
        }

        .gantt-row:hover {
            background-color: #f8fafc;
        }

        .gantt-task-col {
            width: 200px;
            flex-shrink: 0;
            padding: 8px;
            border-right: 1px solid #e2e8f0;
            font-size: 0.875rem;
            background: #fff;
            position: sticky;
            left: 0;
            z-index: 35;
            height: 40px;
            display: flex;
            align-items: center;
            box-shadow: 1px 0 3px rgba(0, 0, 0, 0.05);
        }

        .gantt-row:hover .gantt-task-col {
            background-color: #f8fafc;
        }

        .gantt-timeline-col {
            position: relative;
            flex: 1;
            height: 40px;
        }

        /* Grid Lines */
        .gantt-grid-lines {
            position: absolute;
            top: 0;
            left: 200px;
            bottom: 0;
            display: flex;
            pointer-events: none;
            z-index: 0;
        }

        .gantt-grid-col {
            border-right: 1px solid #f1f5f9;
            height: 100%;
            box-sizing: border-box;
        }

        /* Bars */
        .gantt-bar {
            position: absolute;
            height: 24px;
            top: 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 8px;
            white-space: nowrap;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
            z-index: 20;
        }

        .gantt-bar:hover {
            opacity: 0.9;
            transform: scaleY(1.05);
            z-index: 25;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Today Line */
        .today-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #ef4444;
            z-index: 15;
            pointer-events: none;
            opacity: 0.5;
        }

        /* SVG */
        .dependency-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        /* Tooltip style */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 50;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            pointer-events: none;
            white-space: normal;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Modal scroll styling */
        .overflow-y-auto {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
        }

        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }

        .overflow-y-auto::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend } = window.Recharts || {};

        const API_URL = "https://script.google.com/macros/s/AKfycbxXrSwPBhGcyGhWc8Q4zAeCcugafQhunMX7tWAZHA73gUUzBiRIp95s2ZfWAV4ppkJK/exec";
        const PX_PER_DAY = 40;
        const ROW_HEIGHT = 40;

        // --- Improved Date Helpers ---
        const getTaiwanToday = () => new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Taipei' });

        // 使用全域 normalizeDate（已在 HTML head 中定義，支援 Excel 序列號）
        const normalizeDate = window.normalizeDate || ((dateStr) => {
            console.error('[ERROR] window.normalizeDate 未定義！');
            return '';
        });

        const getStartDate = (endDateStr, duration) => {
            if (!duration || !endDateStr) return '';
            try {
                const end = new Date(endDateStr);
                const start = new Date(end);
                start.setDate(end.getDate() - duration);
                return start.toLocaleDateString('en-CA', { timeZone: 'Asia/Taipei' });
            } catch (e) { return ''; }
        };

        // --- Icons ---
        const Icon = ({ path, size = 18, color = "currentColor", onClick, className = "" }) => (
            <svg onClick={onClick} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={{ cursor: onClick ? 'pointer' : 'default' }}>
                {path}
            </svg>
        );

        const paths = {
            flag: <React.Fragment><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z" /><line x1="4" y1="22" x2="4" y2="15" /></React.Fragment>,
            clock: <React.Fragment><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></React.Fragment>,
            calendar: <React.Fragment><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></React.Fragment>,
            list: <React.Fragment><line x1="8" y1="6" x2="21" y2="6" /><line x1="8" y1="12" x2="21" y2="12" /><line x1="8" y1="18" x2="21" y2="18" /><line x1="3" y1="6" x2="3.01" y2="6" /><line x1="3" y1="12" x2="3.01" y2="12" /><line x1="3" y1="18" x2="3.01" y2="18" /></React.Fragment>,
            plus: <React.Fragment><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></React.Fragment>,
            trash: <React.Fragment><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></React.Fragment>,
            edit: <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />,
            x: <React.Fragment><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></React.Fragment>,
            alert: <React.Fragment><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></React.Fragment>,
            check: <React.Fragment><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></React.Fragment>,
            timer: <React.Fragment><line x1="10" y1="2" x2="14" y2="2" /><line x1="12" y1="14" x2="15" y2="11" /><circle cx="12" cy="14" r="8" /></React.Fragment>,
            left: <polyline points="15 18 9 12 15 6" />,
            right: <polyline points="9 18 15 12 9 6" />,
            file: <React.Fragment><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><polyline points="10 9 9 9 8 9" /></React.Fragment>,
            link: <React.Fragment><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" /><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" /></React.Fragment>,
            gantt: <React.Fragment><path d="M12 2v20" /><path d="M2 6h20" /><path d="M6 10h8" /><path d="M4 14h12" /><path d="M8 18h10" /></React.Fragment>,
            settings: <React.Fragment><circle cx="12" cy="12" r="3" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" /></React.Fragment>,
            search: <React.Fragment><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /></React.Fragment>
        };

        const INITIAL_DATA = [
            { id: 1, team: '晶片', category: 'Flow', task: '架構確認', owner: 'Anting', date: '2025-12-12', status: 'Done', priority: 'High', duration: 3, isCheckpoint: true, dependency: '', notes: '' }
        ];

        const CATEGORIES = ['Mechanism', 'Electrical', 'Software', 'QA', 'Design', 'Flow'];
        // ✅ TEAMS/PROJECTS/OWNERS 已移至 App 組件內部，從 API 動態載入

        // ✅ Task ID部門代碼Mapping (用於未來Task ID升級)
        const DEPT_CODES = {
            '晶片': 'CHIP',
            '機構': 'MECH',
            '軟體': 'SW',
            '電控': 'EC',
            '流道': 'FLOW',
            '生醫': 'BIO',
            'QA': 'QA',
            '管理': 'MGT',
            'issue': 'ISS'
        };

        // Team 色彩配置
        const getTeamColor = (team) => {
            const colors = {
                '晶片': '#3b82f6',      // blue
                '機構': '#8b5cf6',      // purple
                '軟體': '#10b981',      // emerald
                '電控': '#f59e0b',      // amber
                '流道': '#06b6d4',      // cyan
                '生醫': '#ec4899',      // pink
                'QA': '#6366f1',        // indigo
                '管理': '#84cc16',      // lime
                'issue': '#ef4444'      // red
            };
            return colors[team] || '#64748b'; // slate as default
        };

        const getTeamBadgeClass = (team) => {
            const classes = {
                '晶片': 'text-blue-600 border-blue-200 bg-blue-50',
                '機構': 'text-purple-600 border-purple-200 bg-purple-50',
                '軟體': 'text-emerald-600 border-emerald-200 bg-emerald-50',
                '電控': 'text-amber-600 border-amber-200 bg-amber-50',
                '流道': 'text-cyan-600 border-cyan-200 bg-cyan-50',
                '生醫': 'text-pink-600 border-pink-200 bg-pink-50',
                'QA': 'text-indigo-600 border-indigo-200 bg-indigo-50',
                '管理': 'text-lime-600 border-lime-200 bg-lime-50',
                'issue': 'text-red-600 border-red-200 bg-red-50'
            };
            return classes[team] || 'text-slate-600 border-slate-200 bg-slate-50';
        };

        // 專案顏色對應
        const getProjectColor = (project) => {
            const colors = {
                'CKSX': 'text-blue-600 bg-blue-100 border-blue-300',
                'Jamstec': 'text-emerald-600 bg-emerald-100 border-emerald-300',
                'Genentech': 'text-purple-600 bg-purple-100 border-purple-300',
                '5880 Chip': 'text-amber-600 bg-amber-100 border-amber-300',
                'Internal': 'text-slate-600 bg-slate-100 border-slate-300',
                'TBD': 'text-gray-500 bg-gray-100 border-gray-300',
                'Other': 'text-pink-600 bg-pink-100 border-pink-300'
            };
            return colors[project] || 'text-gray-600 bg-gray-100 border-gray-300';
        };


        const App = () => {
            const [tasks, setTasks] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isOffline, setIsOffline] = useState(false);
            const [viewMode, setViewMode] = useState('dashboard');
            const [filterTeam, setFilterTeam] = useState('All');
            const [filterProject, setFilterProject] = useState('All'); // ✅ 新增Project篩選
            const [filterStat, setFilterStat] = useState(null);
            const [ganttFilterTeam, setGanttFilterTeam] = useState('All');
            const [showDependencies, setShowDependencies] = useState(false);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingTask, setEditingTask] = useState(null);
            const [apiError, setApiError] = useState(null);

            const [todayStr, setTodayStr] = useState('');
            const [calendarMonth, setCalendarMonth] = useState(new Date());
            const [isMobile, setIsMobile] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [highlightUrgent, setHighlightUrgent] = useState(() => {
                const saved = localStorage.getItem('highlightUrgent');
                return saved !== null ? JSON.parse(saved) : true;
            });

            // Excel 上傳相關
            const [dataSource, setDataSource] = useState('google'); // 'google' 或 'excel'
            const [uploadProgress, setUploadProgress] = useState('');
            const fileInputRef = useRef(null);

            // 隱藏已完成任務的勾選框狀態 (預設隱藏)
            const [hideCompleted, setHideCompleted] = useState(() => {
                const saved = localStorage.getItem('hideCompleted');
                return saved !== null ? JSON.parse(saved) : true; // 預設隱藏
            });

            // ✅ Phase 1: 動態主資料
            const [dynamicTeams, setDynamicTeams] = useState([]);
            const [dynamicProjects, setDynamicProjects] = useState([]);
            const [dynamicOwners, setDynamicOwners] = useState([]);

            // 持久化高亮設定
            useEffect(() => {
                localStorage.setItem('highlightUrgent', JSON.stringify(highlightUrgent));
            }, [highlightUrgent]);

            // 持久化隱藏已完成設定
            useEffect(() => {
                localStorage.setItem('hideCompleted', JSON.stringify(hideCompleted));
            }, [hideCompleted]);

            // 偵測行動裝置
            useEffect(() => {
                const checkMobile = () => setIsMobile(window.innerWidth < 768);
                checkMobile();
                window.addEventListener('resize', checkMobile);
                return () => window.removeEventListener('resize', checkMobile);
            }, []);

            useEffect(() => {
                setTodayStr(getTaiwanToday());
                setCalendarMonth(new Date());
            }, []);

            // ✅ Phase 1: 載入動態主資料
            useEffect(() => {
                const loadMasterData = async () => {
                    try {
                        // 載入 Teams
                        const teamsRes = await fetch(`${API_URL}?action=getTeams`);
                        const teamsData = await teamsRes.json();
                        if (teamsData.success) {
                            setDynamicTeams(teamsData.data.filter(t => t.isActive).map(t => t.teamName));
                            console.log('✅ 動態載入 Teams:', teamsData.data.length);
                        }

                        // 載入 Projects
                        const projectsRes = await fetch(`${API_URL}?action=getProjects`);
                        const projectsData = await projectsRes.json();
                        if (projectsData.success) {
                            setDynamicProjects(projectsData.data.map(p => p.projectName));
                            console.log('✅ 動態載入 Projects:', projectsData.data.length);
                        }

                        // 載入 Owners
                        const ownersRes = await fetch(`${API_URL}?action=getOwners`);
                        const ownersData = await ownersRes.json();
                        if (ownersData.success) {
                            setDynamicOwners(ownersData.data.filter(o => o.isActive).map(o => o.ownerName));
                            console.log('✅ 動態載入 Owners:', ownersData.data.length);
                        }
                    } catch (error) {
                        console.error('❌ 載入主資料失敗:', error);
                        // 失敗時使用備份的硬編碼列表
                    }
                };
                loadMasterData();
            }, []);

            // ✅ Phase 1: 動態主資料 (備份列表內嵌)
            const TEAMS_FALLBACK = ['晶片', '機構', '軟體', '電控', '流道', '生醫', 'QA', '管理', 'issue'];
            const PROJECTS_FALLBACK = ['CKSX', 'Jamstec', 'Genentech', '5880 Chip', 'Internal', 'TBD', 'Other'];
            const OWNERS_FALLBACK = ['Anting', '宗轅', 'Jerry', '子宗', 'Jun', '慶德', 'HW', 'EE', 'RD', 'QA', 'SW', 'All', 'Unassigned'];

            const TEAMS = dynamicTeams.length > 0 ? dynamicTeams : TEAMS_FALLBACK;
            const PROJECTS = dynamicProjects.length > 0 ? dynamicProjects : PROJECTS_FALLBACK;
            const OWNERS = dynamicOwners.length > 0 ? dynamicOwners : OWNERS_FALLBACK;

            useEffect(() => {
                setIsLoading(true);
                const fetchData = async () => {
                    try {
                        setApiError(null);
                        const controller = new AbortController();
                        const id = setTimeout(() => controller.abort(), 8000);
                        const response = await fetch(API_URL + '?action=read', { signal: controller.signal });
                        clearTimeout(id);
                        if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
                        const result = await response.json();

                        console.log('===== Google Sheets 資料除錯 =====');
                        console.log('API完整回應:', result);

                        // ✅ 修正: 從result中取出data陣列
                        const data = result.data || result; // 支援兩種格式: {data: [...]} 或 直接 [...]

                        console.log('資料筆數:', data.length);
                        if (data.length > 0) {
                            console.log('第一筆資料:', data[0]);
                            console.log('欄位名稱:', Object.keys(data[0]));
                        }

                        if (Array.isArray(data) && data.length > 0) {
                            // 檢查資料格式：UnifiedTaskManager 或 Project Tracker
                            const firstItem = data[0];
                            const isUTMFormat = firstItem.hasOwnProperty('ID') || firstItem.hasOwnProperty('Task');

                            console.log('資料格式:', isUTMFormat ? 'UnifiedTaskManager' : 'Project Tracker');

                            let formatted;
                            if (isUTMFormat) {
                                // UnifiedTaskManager 格式 - 使用轉換器
                                const convertResult = convertUTMToTracker(data);
                                formatted = convertResult.data;
                                console.log('轉換結果:', convertResult.stats);
                            } else {
                                // Project Tracker 格式
                                formatted = data.map(item => ({
                                    ...item,
                                    id: item.id, // 保持為字串格式 (新的Task ID是字串)
                                    duration: Number(item.duration),
                                    isCheckpoint: item.isCheckpoint === true || item.isCheckpoint === "TRUE",
                                    date: normalizeDate(item.date),
                                    dependency: item.dependency || '',
                                    notes: item.notes || '',
                                    category: item.category || item.team || 'Mechanism'
                                }));
                            }
                            setTasks(formatted);
                            setDataSource('google');
                            setIsOffline(false);
                        } else {
                            setTasks(INITIAL_DATA);
                            setIsOffline(false);
                        }

                    } catch (err) {
                        console.error("API Error:", err);
                        let errorMsg = '未知錯誤';

                        if (err.name === 'AbortError') {
                            errorMsg = '連線逾時 (超過8秒)';
                        } else if (err.message.includes('Failed to fetch')) {
                            errorMsg = '網路連線失敗，請檢查網路';
                        } else if (err.message.includes('HTTP Error')) {
                            errorMsg = `伺服器錯誤: ${err.message}`;
                        } else {
                            errorMsg = err.message;
                        }

                        setApiError(errorMsg);

                        // 嘗試從本地儲存讀取備份
                        const backup = localStorage.getItem('tasks_backup');
                        if (backup) {
                            try {
                                const backupTasks = JSON.parse(backup);
                                const backupTime = localStorage.getItem('tasks_backup_time');
                                setTasks(backupTasks);
                                setApiError(`${errorMsg} - 使用本地備份 (${new Date(backupTime).toLocaleString('zh-TW')})`);
                            } catch (e) {
                                setTasks(INITIAL_DATA);
                            }
                        } else {
                            setTasks(INITIAL_DATA);
                        }
                        setIsOffline(true);
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchData();
            }, []);

            // Excel 檔案上傳處理
            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                // 檢查檔案類型
                const validExtensions = ['.xlsx', '.xls', '.csv'];
                const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
                if (!validExtensions.includes(fileExtension)) {
                    alert('檔案格式不支援！請上傳 Excel (.xlsx, .xls) 或 CSV (.csv) 檔案');
                    return;
                }

                setIsLoading(true);
                setUploadProgress(`正在讀取 ${file.name}...`);

                try {
                    const reader = new FileReader();

                    reader.onload = (e) => {
                        try {
                            setUploadProgress('正在解析檔案...');

                            // 使用 SheetJS 解析
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });

                            // 讀取第一個工作表
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            // 使用 raw: true 保留原始數字格式，不自動轉換日期
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: true });

                            console.log('===== Excel 解析除錯資訊 =====');
                            console.log('工作表名稱:', sheetName);
                            console.log('原始資料筆數:', jsonData.length);
                            console.log('前 3 筆原始資料:', jsonData.slice(0, 3));
                            if (jsonData.length > 0) {
                                console.log('Excel 欄位名稱:', Object.keys(jsonData[0]));
                                // 新增：檢查日期欄位的實際值
                                const firstRow = jsonData[0];
                                console.log('第一筆日期欄位值檢查:');
                                console.log('  - Due date:', firstRow['Due date'], '類型:', typeof firstRow['Due date']);
                                console.log('  - Start date:', firstRow['Start date'], '類型:', typeof firstRow['Start date']);
                                console.log('  - Issue date:', firstRow['Issue date'], '類型:', typeof firstRow['Issue date']);
                            }

                            setUploadProgress('正在轉換資料格式...');

                            // 使用轉換器轉換資料
                            const result = convertUTMToTracker(jsonData);

                            console.log('===== 資料轉換結果 =====');
                            console.log('轉換成功:', result.success);
                            console.log('成功筆數:', result.stats.converted);
                            console.log('失敗筆數:', result.stats.failed);
                            console.log('錯誤訊息:', result.errors);
                            console.log('前 3 筆轉換後資料:', result.data.slice(0, 3));
                            if (result.data.length > 0) {
                                console.log('第一筆轉換後的日期欄位:');
                                console.log('  - date (End Date):', result.data[0].date);
                                console.log('  - startDate:', result.data[0].startDate);
                                console.log('  - issueDate:', result.data[0].issueDate);
                            }

                            if (!result.success) {
                                // 顯示錯誤但仍載入成功的資料
                                const errorMsg = result.errors.join('\n');
                                if (result.data.length > 0) {
                                    alert(`部分資料轉換失敗:\n${errorMsg}\n\n已成功載入 ${result.stats.converted} / ${result.stats.total} 筆任務`);
                                } else {
                                    throw new Error(`資料轉換失敗:\n${errorMsg}`);
                                }
                            }

                            if (result.data.length === 0) {
                                throw new Error('檔案中沒有有效的任務資料');
                            }

                            // 更新任務資料
                            setTasks(result.data);
                            setDataSource('excel');
                            setIsOffline(true);
                            setApiError(null);

                            // 儲存到本地備份
                            try {
                                localStorage.setItem('tasks_backup', JSON.stringify(result.data));
                                localStorage.setItem('tasks_backup_time', new Date().toISOString());
                                localStorage.setItem('tasks_backup_source', file.name);
                            } catch (e) {
                                console.warn('本地儲存失敗:', e);
                            }

                            setUploadProgress(`✓ 成功載入 ${result.data.length} 筆任務 (來自 ${file.name})`);
                            setTimeout(() => setUploadProgress(''), 3000);

                        } catch (parseError) {
                            console.error('解析錯誤:', parseError);
                            alert(`檔案解析失敗: ${parseError.message}`);
                            setUploadProgress('');
                        } finally {
                            setIsLoading(false);
                        }
                    };

                    reader.onerror = (error) => {
                        console.error('檔案讀取錯誤:', error);
                        alert('檔案讀取失敗，請重試');
                        setUploadProgress('');
                        setIsLoading(false);
                    };

                    // 讀取檔案
                    reader.readAsArrayBuffer(file);

                } catch (error) {
                    console.error('上傳錯誤:', error);
                    alert(`上傳失敗: ${error.message}`);
                    setUploadProgress('');
                    setIsLoading(false);
                }
            };

            // 效能優化：使用 useMemo 避免不必要的統計計算
            // 只有在 tasks、todayStr 或 filterProject 改變時才重新計算
            const stats = useMemo(() => {
                if (!todayStr) return { total: 0, checkpoints: 0, pendingHigh: 0, completed: 0, lateStart: 0, delayed: 0 };
                const baseTasks = tasks.filter(t => filterTeam === 'All' || (t.team && t.team === filterTeam));
                return {
                    total: baseTasks.length,
                    checkpoints: baseTasks.filter(t => t.isCheckpoint).length,
                    pendingHigh: baseTasks.filter(t => t.priority === 'High' && t.status !== 'Done').length,
                    completed: baseTasks.filter(t => t.status === 'Done').length,
                    lateStart: baseTasks.filter(t => {
                        const startDate = getStartDate(t.date, t.duration);
                        return t.status === 'Todo' && startDate <= todayStr && t.date >= todayStr;
                    }).length,
                    // 修正：延遲任務應基於實際日期判斷，而非status欄位
                    // 延遲 = 完成日期已過（< 今天）且尚未完成的任務
                    delayed: baseTasks.filter(t => t.date < todayStr && t.status !== 'Done').length
                };
            }, [tasks, todayStr, filterTeam]);

            // 效能優化：使用 useMemo 快取篩選結果
            // 避免每次渲染都重新執行篩選邏輯
            const filteredTasks = useMemo(() => {
                const filterFunctions = {
                    'Checkpoints': (t) => t.isCheckpoint,
                    'Urgent': (t) => t.status !== 'Done' && t.priority === 'High',
                    'Completed': (t) => t.status === 'Done',
                    'LateStart': (t) => {
                        const startDate = getStartDate(t.date, t.duration);
                        return t.status === 'Todo' && startDate <= todayStr && t.date >= todayStr;
                    },
                    'Delayed': (t) => t.date < todayStr && t.status !== 'Done'
                };

                // ✅ 修正Team篩選邏輯 - 支持Issue Pool
                let result = tasks.filter(t => {
                    if (filterTeam === 'All') return true;

                    // Issue特殊處理:顯示team=issue或issuePool=true的任務
                    if (filterTeam === 'issue' || filterTeam === 'Issue') {
                        return (t.team && (t.team === 'issue' || t.team === 'Issue')) || t.issuePool === true;
                    }

                    // 其他Team正常篩選
                    return t.team && t.team === filterTeam;
                });

                // ✅ 新增:Project篩選
                if (filterProject !== 'All') {
                    result = result.filter(t => t.project && t.project === filterProject);
                }

                if (filterStat && filterFunctions[filterStat]) {
                    result = result.filter(filterFunctions[filterStat]);
                }

                // 搜尋篩選：支援多欄位搜尋
                if (searchQuery.trim()) {
                    const query = searchQuery.toLowerCase();
                    result = result.filter(t => {
                        // 安全地將欄位轉換為字符串再進行搜尋
                        const matchTask = t.task && String(t.task).toLowerCase().includes(query);
                        const matchOwner = t.owner && String(t.owner).toLowerCase().includes(query);
                        const matchNotes = t.notes && String(t.notes).toLowerCase().includes(query);
                        const matchCategory = t.category && String(t.category).toLowerCase().includes(query);
                        const matchTeam = t.team && String(t.team).toLowerCase().includes(query);
                        return matchTask || matchOwner || matchNotes || matchCategory || matchTeam;
                    });
                }

                // 隱藏已完成的任務
                if (hideCompleted) {
                    result = result.filter(t => t.status !== 'Done');
                }

                return result;
            }, [tasks, filterTeam, filterProject, filterStat, todayStr, searchQuery, hideCompleted]);

            // 效能優化：快取系統警告訊息
            const alerts = useMemo(() => {
                if (!todayStr) return [];
                const list = [];
                const overdueCount = tasks.filter(t => t.date < todayStr && t.status !== 'Done').length;
                if (overdueCount > 0) list.push({ type: 'danger', msg: `有 ${overdueCount} 個任務已逾期` });
                if (apiError) list.push({ type: 'warning', msg: `系統離線中 (${apiError})` });
                return list;
            }, [tasks, todayStr, apiError]);

            // 效能優化：快取日曆視圖資料
            // 只有在月份或任務改變時才重新計算
            const calendarDays = useMemo(() => {
                const year = calendarMonth.getFullYear();
                const month = calendarMonth.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const days = [];
                for (let i = 0; i < firstDay.getDay(); i++) days.push(null);
                for (let i = 1; i <= lastDay.getDate(); i++) {
                    const dStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    days.push({ date: i, fullDate: dStr, tasks: tasks.filter(t => t.date === dStr) });
                }
                return days;
            }, [calendarMonth, tasks]);

            // 解析相依性字串為陣列
            const parseDependencies = (depStr) => {
                if (!depStr || typeof depStr !== 'string') return [];
                return depStr.split(',').map(id => id.trim()).filter(id => id);
            };

            // 驗證相依性格式與有效性
            const validateDependencies = (depStr, currentTaskId, allTasks) => {
                const errors = [];
                if (!depStr || !depStr.trim()) return errors;

                const depIds = parseDependencies(depStr);

                // 限制最大相依數量
                if (depIds.length > 10) {
                    errors.push('⚠️ 相依性數量不可超過 10 個');
                    return errors;
                }

                for (const depId of depIds) {
                    // 檢查格式（必須是數字）
                    if (isNaN(depId) || depId.includes('.')) {
                        errors.push(`❌ 相依性 ID "${depId}" 格式不正確（必須是整數）`);
                        continue;
                    }

                    // 檢查是否相依自己
                    if (String(depId) === String(currentTaskId)) {
                        errors.push(`❌ 任務不能相依自己 (ID: ${depId})`);
                        continue;
                    }

                    // 檢查相依的任務是否存在
                    const depTask = allTasks.find(t => String(t.id) === String(depId));
                    if (!depTask) {
                        errors.push(`⚠️ 找不到相依任務 ID: ${depId}`);
                    }
                }

                return errors;
            };

            const validateTask = (task) => {
                const errors = [];

                // 任務名稱驗證
                if (!task.task?.trim()) {
                    errors.push('❌ 任務名稱不能為空');
                } else if (task.task.length > 100) {
                    errors.push('❌ 任務名稱不能超過100字元');
                }

                // 日期驗證
                const normalizedDate = normalizeDate(task.date);
                if (!task.date || !normalizedDate) {
                    errors.push('❌ 完成日期格式不正確');
                } else {
                    const taskDate = new Date(normalizedDate);
                    const startDate = new Date(getStartDate(normalizedDate, task.duration));

                    if (startDate > taskDate) {
                        errors.push('⚠️ 開始日期晚於完成日期，請確認工時設定');
                    }

                    // 檢查日期是否在合理範圍內（過去5年到未來5年）
                    const fiveYearsAgo = new Date();
                    fiveYearsAgo.setFullYear(fiveYearsAgo.getFullYear() - 5);
                    const fiveYearsLater = new Date();
                    fiveYearsLater.setFullYear(fiveYearsLater.getFullYear() + 5);

                    if (taskDate < fiveYearsAgo || taskDate > fiveYearsLater) {
                        errors.push('⚠️ 日期超出合理範圍（5年內）');
                    }
                }

                // 工時驗證
                if (task.duration < 0) {
                    errors.push('❌ 工時不能為負數');
                } else if (task.duration > 365) {
                    errors.push('⚠️ 工時超過365天，請確認是否正確');
                }

                // 負責人驗證
                if (!task.owner?.trim()) {
                    errors.push('❌ 負責人不能為空');
                }

                return errors;
            };

            // 修改為支援多個相依性的循環檢查
            const detectCircularDependency = (taskId, dependencyStr, currentTasks) => {
                const depIds = parseDependencies(dependencyStr);
                if (depIds.length === 0) return false;

                // 使用 BFS 檢查每個相依性鏈
                for (const depId of depIds) {
                    const visited = new Set();
                    const queue = [depId];
                    let depth = 0;

                    while (queue.length > 0 && depth < 100) {
                        const current = queue.shift();

                        // 檢查是否形成循環
                        if (String(current) === String(taskId)) return true;

                        // 避免重複訪問
                        if (visited.has(current)) continue;
                        visited.add(current);

                        // 找到當前任務的所有相依性
                        const parent = currentTasks.find(t => String(t.id) === String(current));
                        if (parent?.dependency) {
                            const parentDeps = parseDependencies(parent.dependency);
                            queue.push(...parentDeps);
                        }

                        depth++;
                    }
                }
                return false;
            };

            const handleSave = (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const defaultDate = getTaiwanToday();

                // ✅ 方案 A 修改：新增時不傳 id，讓後端自動生成新格式 ID
                const isEditing = !!editingTask;
                const newItem = {
                    // 只在編輯時包含 id
                    ...(isEditing && { id: editingTask.id }),
                    project: fd.get('project'),
                    team: fd.get('team'),
                    task: fd.get('task'),
                    owner: fd.get('owner'),
                    startDate: fd.get('startDate') || '',
                    date: fd.get('date') || defaultDate,
                    duration: parseInt(fd.get('duration') || 0),
                    isCheckpoint: fd.get('isCheckpoint') === 'on',
                    issuePool: fd.get('issuePool') === 'on',
                    priority: fd.get('priority'),
                    status: fd.get('status'),
                    dependency: fd.get('dependency'),
                    verification: fd.get('verification'),
                    notes: fd.get('notes')
                };

                const validationErrors = validateTask(newItem);
                if (validationErrors.length > 0) { alert('驗證失敗:\n' + validationErrors.join('\n')); return; }

                // 驗證相依性格式與有效性（新增時跳過 id 檢查）
                if (isEditing) {
                    const depErrors = validateDependencies(newItem.dependency, newItem.id, tasks);
                    if (depErrors.length > 0) { alert('相依性驗證失敗:\n' + depErrors.join('\n')); return; }

                    // 檢查循環相依性
                    if (newItem.dependency && detectCircularDependency(newItem.id, newItem.dependency, tasks)) {
                        alert('錯誤：偵測到循環相依性！\n任務之間的相依關係形成了迴圈，請調整相依設定。'); return;
                    }
                }

                // 本地更新（編輯時）或臨時新增
                if (isEditing) {
                    const updatedTasks = tasks.map(t => t.id === newItem.id ? newItem : t);
                    setTasks(updatedTasks);

                    // 儲存到本地備份
                    try {
                        localStorage.setItem('tasks_backup', JSON.stringify(updatedTasks));
                        localStorage.setItem('tasks_backup_time', new Date().toISOString());
                    } catch (e) {
                        console.warn('本地儲存失敗:', e);
                    }
                }

                setIsModalOpen(false);

                if (!isOffline) {
                    const payload = {
                        action: isEditing ? 'update' : 'upsert',  // ✅ 使用 upsert 讓後端處理
                        data: newItem
                    };

                    console.log('🚀 發送到API:', payload.action, isEditing ? `任務ID: ${newItem.id}` : '新任務（後端將生成ID）');

                    fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',  // ✅ Google Apps Script需要此設定
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    })
                        .then(() => {
                            console.log('✅ 已發送至 Google Sheets');

                            // ✅ 新增任務後重新載入資料以取得後端生成的新 ID
                            if (!isEditing) {
                                console.log('🔄 重新載入資料以取得新 Task ID...');
                                setIsLoading(true);

                                // 延遲 1 秒後重新載入，給後端時間處理
                                setTimeout(() => {
                                    fetch(API_URL + '?action=read')
                                        .then(res => res.json())
                                        .then(result => {
                                            const data = result.data || result;
                                            if (Array.isArray(data) && data.length > 0) {
                                                const formatted = data.map(item => ({
                                                    ...item,
                                                    id: item.id,
                                                    duration: Number(item.duration),
                                                    isCheckpoint: item.isCheckpoint === true || item.isCheckpoint === "TRUE",
                                                    date: normalizeDate(item.date),
                                                    dependency: item.dependency || '',
                                                    notes: item.notes || '',
                                                    category: item.category || item.team || 'Mechanism'
                                                }));
                                                setTasks(formatted);
                                                console.log('✅ 資料已重新載入，新 Task ID:', formatted[formatted.length - 1]?.id);
                                            }
                                        })
                                        .catch(err => {
                                            console.error('❌ 重新載入失敗:', err);
                                        })
                                        .finally(() => {
                                            setIsLoading(false);
                                        });
                                }, 1000);
                            }
                        })
                        .catch(err => {
                            console.error("❌ 發送失敗:", err);
                            alert('儲存到 Google Sheets 時發生錯誤，但本地已更新');
                        });
                }
            };

            const handleDelete = (id) => {
                if (!confirm('確定要刪除此任務嗎？(將同步刪除 Google Sheet 資料)')) return;
                setTasks(prev => prev.filter(x => x.id !== id));

                console.log('🗑️ 刪除任務 ID:', id);

                if (!isOffline) {
                    fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'delete', data: { id: id } })
                    })
                        .then(() => console.log('✅ 刪除成功 (已同步至 Google Sheets)'))
                        .catch(err => {
                            console.error("❌ Delete Error:", err);
                        });
                }
            };

            const toggleStatFilter = (type) => { setFilterStat(prev => prev === type ? null : type); setViewMode('dashboard'); };
            const changeMonth = (delta) => { const d = new Date(calendarMonth); d.setMonth(d.getMonth() + delta); setCalendarMonth(d); };

            // 取得任務行高亮樣式
            const getRowHighlight = (task) => {
                if (!highlightUrgent) return '';

                // 已完成的任務不高亮
                if (task.status === 'Done') return '';

                // 延遲任務（最高優先）- 包含 status 為 Delayed 或完成日期已過
                const isOverdue = task.date < todayStr;
                if (task.status === 'Delayed' || (task.status !== 'Done' && isOverdue)) {
                    return 'bg-red-50 border-l-4 border-red-500';
                }

                // 應開工未動
                const startDate = getStartDate(task.date, task.duration);
                if (task.status === 'Todo' && startDate <= todayStr && task.date >= todayStr) {
                    return 'bg-yellow-50 border-l-4 border-yellow-500';
                }

                return '';
            };

            const chartData = TEAMS.map(team => ({
                name: team,
                value: tasks.filter(t => t.team && t.team === team).length,
                color: getTeamColor(team)
            })).filter(item => item.value > 0); // 只顯示有任務的 Team

            const getStatusBadge = (t) => {
                if (t.date < todayStr && t.status !== 'Done') return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-red-100 text-red-700 border border-red-200">⛔ 逾期</span>;
                const startDate = getStartDate(t.date, t.duration);
                if (t.status === 'Todo' && startDate <= todayStr) return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-yellow-100 text-yellow-700 border border-yellow-200">⚠️ 應開工</span>;
                switch (t.status) {
                    case 'Todo': return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-gray-100 text-gray-600 border border-gray-200">待執行</span>;
                    case 'InProgress': case 'Pending': return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-blue-100 text-blue-700 border border-blue-200">進行中</span>;
                    case 'Done': return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-green-100 text-green-700 border border-green-200">完成</span>;
                    case 'Delayed': return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-orange-100 text-orange-700 border border-orange-200">延誤</span>;
                    default: return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-gray-100 text-gray-600">{t.status}</span>;
                }
            };

            // --- Gantt Chart View (Corrected Layout) ---
            const GanttView = () => {
                const { sortedTasks, minDate, totalDays } = useMemo(() => {
                    // 先依據 Team 篩選
                    let ganttTasks = tasks.filter(t => ganttFilterTeam === 'All' || (t.team && t.team === ganttFilterTeam));

                    // 再依據搜尋條件篩選（與 Dashboard 相同邏輯）
                    if (searchQuery.trim()) {
                        const query = searchQuery.toLowerCase();
                        ganttTasks = ganttTasks.filter(t => {
                            // 安全地將欄位轉換為字符串再進行搜尋
                            const matchTask = t.task && String(t.task).toLowerCase().includes(query);
                            const matchOwner = t.owner && String(t.owner).toLowerCase().includes(query);
                            const matchTeam = t.team && String(t.team).toLowerCase().includes(query);
                            const matchNotes = t.notes && String(t.notes).toLowerCase().includes(query);
                            return matchTask || matchOwner || matchTeam || matchNotes;
                        });
                    }

                    const sorted = ganttTasks.sort((a, b) => new Date(getStartDate(a.date, a.duration)) - new Date(getStartDate(b.date, b.duration)));
                    let min = new Date();
                    let max = new Date();
                    if (sorted.length > 0) {
                        const dates = sorted.flatMap(t => [new Date(getStartDate(t.date, t.duration)), new Date(t.date)]);
                        min = new Date(Math.min(...dates));
                        max = new Date(Math.max(...dates));
                    }
                    min.setDate(min.getDate() - 5);
                    max.setDate(max.getDate() + 15);
                    const days = Math.ceil((max - min) / (1000 * 60 * 60 * 24));
                    return { sortedTasks: sorted, minDate: min, totalDays: days };
                }, [tasks, ganttFilterTeam, searchQuery]);

                const getLeftPos = (dStr) => {
                    const d = new Date(dStr);
                    const diff = Math.ceil((d - minDate) / (1000 * 60 * 60 * 24));
                    return diff * PX_PER_DAY;
                };

                const todayPos = getLeftPos(todayStr);

                const drawDependencies = () => {
                    if (!showDependencies) return null;
                    const lines = [];

                    sortedTasks.forEach((task, taskIndex) => {
                        if (!task.dependency) return;

                        // 解析多個相依性
                        const depIds = parseDependencies(task.dependency);

                        depIds.forEach(depId => {
                            const parent = sortedTasks.find(p => String(p.id) === String(depId));
                            const parentIndex = sortedTasks.indexOf(parent);
                            if (!parent || parentIndex === -1) return;

                            const parentStartStr = getStartDate(parent.date, parent.duration);
                            const parentX = getLeftPos(parentStartStr) + (parent.duration * PX_PER_DAY);
                            const parentY = parentIndex * ROW_HEIGHT + 20;
                            const childStartStr = getStartDate(task.date, task.duration);
                            const childX = getLeftPos(childStartStr);
                            const childY = taskIndex * ROW_HEIGHT + 20;

                            const path = `M ${parentX} ${parentY} C ${parentX + 20} ${parentY}, ${childX - 20} ${childY}, ${childX} ${childY}`;
                            lines.push(
                                <path key={`${parent.id}-${task.id}`} d={path} stroke="#94a3b8" strokeWidth="1.5" fill="none" markerEnd="url(#arrowhead)" />
                            );
                        });
                    });

                    return lines;
                };

                // Group days by month for the month header
                const monthHeaders = useMemo(() => {
                    const headers = [];
                    let currentMonth = -1;
                    let monthStartDay = 0;

                    for (let i = 0; i < totalDays; i++) {
                        const d = new Date(minDate);
                        d.setDate(d.getDate() + i);
                        const month = d.getMonth();

                        if (month !== currentMonth) {
                            if (currentMonth !== -1) {
                                headers.push({
                                    month: currentMonth,
                                    year: new Date(minDate.getTime() + (monthStartDay * 24 * 60 * 60 * 1000)).getFullYear(),
                                    startDay: monthStartDay,
                                    daysCount: i - monthStartDay
                                });
                            }
                            currentMonth = month;
                            monthStartDay = i;
                        }
                    }
                    // Add last month segment
                    headers.push({
                        month: currentMonth,
                        year: new Date(minDate.getTime() + (monthStartDay * 24 * 60 * 60 * 1000)).getFullYear(),
                        startDay: monthStartDay,
                        daysCount: totalDays - monthStartDay
                    });

                    return headers;
                }, [minDate, totalDays]);

                // Grid lines for timeline
                const gridLines = Array.from({ length: totalDays }).map((_, i) => (
                    <div key={i} className={`gantt-grid-col ${i % 7 === 0 || i % 7 === 6 ? 'bg-slate-50' : ''}`} style={{ width: `${PX_PER_DAY}px` }}></div>
                ));

                // Timeline day header cells
                const timelineDayHeaders = Array.from({ length: totalDays }).map((_, i) => {
                    const d = new Date(minDate);
                    d.setDate(d.getDate() + i);
                    return <div key={i} className={`gantt-day-cell ${d.getDay() === 0 || d.getDay() === 6 ? 'is-weekend' : ''}`} style={{ width: `${PX_PER_DAY}px` }}>{d.getDate()}</div>
                });

                // 同步滾動 refs
                const headerRef = useRef(null);
                const bodyRef = useRef(null);

                // 同步水平滾動
                useEffect(() => {
                    const bodyEl = bodyRef.current;
                    const headerEl = headerRef.current;

                    if (!bodyEl || !headerEl) return;

                    const handleBodyScroll = () => {
                        if (headerEl) {
                            headerEl.scrollLeft = bodyEl.scrollLeft;
                        }
                    };

                    bodyEl.addEventListener('scroll', handleBodyScroll);
                    return () => bodyEl.removeEventListener('scroll', handleBodyScroll);
                }, []);

                // 行動版友善提示
                if (isMobile) {
                    return (
                        <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden p-8 text-center">
                            <div className="text-6xl mb-4">📱</div>
                            <h3 className="text-xl font-bold text-slate-800 mb-2">建議使用桌面版瀏覽</h3>
                            <p className="text-slate-600 mb-4">
                                甘特圖在大螢幕上有更好的使用體驗。<br />
                                建議您在桌上型電腦或平板橫向模式下查看。
                            </p>
                            <button
                                onClick={() => setViewMode('dashboard')}
                                className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors"
                            >
                                返回列表視圖
                            </button>
                        </div>
                    );
                }

                return (
                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col h-[600px]">
                        <div className="p-4 border-b bg-slate-50 flex justify-between items-center">
                            <h3 className="font-bold text-slate-700">專案甘特圖 (Gantt)</h3>
                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-2 text-xs text-slate-600 bg-white px-2 py-1 rounded border shadow-sm">
                                    <input type="checkbox" id="toggleDeps" checked={showDependencies} onChange={(e) => setShowDependencies(e.target.checked)} className="rounded text-indigo-600 focus:ring-indigo-500" />
                                    <label htmlFor="toggleDeps" className="cursor-pointer select-none">顯示連線 (Beta)</label>
                                </div>
                                <div className="text-xs text-slate-500 flex gap-2">
                                    {TEAMS.map(t => (
                                        <span key={t} onClick={() => setGanttFilterTeam(prev => prev === t ? 'All' : t)}
                                            className={`inline-flex items-center cursor-pointer px-2 py-1 rounded transition-colors ${ganttFilterTeam === 'All' || ganttFilterTeam === t ? 'bg-indigo-100 text-indigo-700 font-bold' : 'bg-slate-100 text-slate-400'}`}>
                                            {t}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="gantt-wrapper">
                            {/* Header Row */}
                            <div className="gantt-header-row" ref={headerRef} style={{ overflowX: 'hidden' }}>
                                <div className="gantt-header-wrapper">
                                    <div className="gantt-header-task">任務名稱</div>
                                    <div className="gantt-header-timeline" style={{ width: `${totalDays * PX_PER_DAY}px` }}>
                                        <div className="gantt-header-month-row">
                                            {monthHeaders.map((m, idx) => (
                                                <div key={idx} className={`gantt-month-cell ${idx % 2 === 0 ? 'bg-white' : 'bg-slate-50'}`} style={{ width: `${m.daysCount * PX_PER_DAY}px` }}>
                                                    {m.year}年{m.month + 1}月
                                                </div>
                                            ))}
                                        </div>
                                        <div className="gantt-header-day-row">
                                            {timelineDayHeaders}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Body */}
                            <div className="gantt-body" ref={bodyRef}>
                                <div className="gantt-body-content" style={{ width: `${200 + totalDays * PX_PER_DAY}px` }}>
                                    {/* Grid Background */}
                                    <div className="gantt-grid-lines" style={{ width: `${totalDays * PX_PER_DAY}px` }}>{gridLines}</div>

                                    {/* Today Line */}
                                    {todayPos > 0 && <div className="today-line" style={{ left: `${200 + todayPos}px`, height: '100%' }}></div>}

                                    {/* SVG Lines */}
                                    <svg className="dependency-svg" style={{ left: '200px', width: `${totalDays * PX_PER_DAY}px`, height: `${sortedTasks.length * ROW_HEIGHT}px` }}>
                                        <defs>
                                            <marker id="arrowhead" markerWidth="6" markerHeight="4" refX="5" refY="2" orient="auto">
                                                <polygon points="0 0, 6 2, 0 4" fill="#94a3b8" />
                                            </marker>
                                        </defs>
                                        {drawDependencies()}
                                    </svg>

                                    {/* Task Rows */}
                                    {sortedTasks.map(t => {
                                        const start = getStartDate(t.date, t.duration);
                                        const left = getLeftPos(start);
                                        const width = t.duration * PX_PER_DAY;
                                        const colorClass = t.project === 'PlanB' ? 'bg-emerald-500' : t.project === 'Machine' ? 'bg-purple-500' : 'bg-blue-500';

                                        return (
                                            <div key={t.id} className="gantt-row">
                                                <div className="gantt-task-col truncate" title={t.task}>{t.task}</div>
                                                <div className="gantt-timeline-col">
                                                    <div
                                                        className={`gantt-bar ${colorClass} ${t.status === 'Done' ? 'opacity-50 grayscale' : ''}`}
                                                        style={{ left: `${left}px`, width: `${width}px` }}
                                                        onClick={() => { setEditingTask(t); setIsModalOpen(true); }}
                                                        title={`${t.task} (${t.duration}天)`}
                                                    >
                                                        {t.duration > 2 && <span className="text-[10px] pl-1">{t.owner}</span>}
                                                    </div>
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen pb-10">
                    {/* Header */}
                    <div className="bg-white border-b sticky top-0 z-30 shadow-sm px-6 py-4 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <div className="bg-indigo-600 text-white p-2 rounded-lg"><Icon path={paths.list} /></div>
                            <h1 className="text-xl font-bold text-slate-800">Project Tracker <span className="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full">v6.9</span></h1>
                            {isLoading && <div className="flex items-center text-sm text-slate-500 gap-2 ml-4"><div className="w-4 h-4 border-2 border-indigo-600 border-t-transparent rounded-full spinner"></div> 載入中...</div>}
                            {uploadProgress && <div className="flex items-center text-sm text-indigo-600 gap-2 ml-4 bg-indigo-50 px-2 py-1 rounded"><Icon path={paths.file} size={14} /> {uploadProgress}</div>}
                            {isOffline && dataSource === 'excel' && <div className="flex items-center text-sm text-emerald-600 gap-2 ml-4 bg-emerald-50 px-2 py-1 rounded"><Icon path={paths.file} size={14} /> Excel 模式</div>}
                            {isOffline && dataSource === 'google' && <div className="flex items-center text-sm text-red-500 gap-2 ml-4 bg-red-50 px-2 py-1 rounded"><Icon path={paths.alert} size={14} /> 離線</div>}
                            <div className="text-xs bg-slate-100 text-slate-500 px-3 py-1 rounded-full hidden sm:block ml-4 flex items-center gap-1">
                                <Icon path={paths.clock} size={12} /> {todayStr}
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                            {/* 視圖切換按鈕組 - Pill樣式 */}
                            <div className="bg-slate-100 p-1 rounded-lg flex gap-1">
                                <button
                                    onClick={() => setViewMode('dashboard')}
                                    className={`px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center gap-2 ${viewMode === 'dashboard'
                                        ? 'bg-white text-indigo-600 shadow-md'
                                        : 'text-slate-600 hover:text-slate-900'
                                        }`}
                                    title="列表"
                                    aria-pressed={viewMode === 'dashboard'}
                                >
                                    <Icon path={paths.list} size={16} />
                                    <span className="hidden sm:inline">列表</span>
                                </button>
                                <button
                                    onClick={() => setViewMode('calendar')}
                                    className={`px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center gap-2 ${viewMode === 'calendar'
                                        ? 'bg-white text-indigo-600 shadow-md'
                                        : 'text-slate-600 hover:text-slate-900'
                                        }`}
                                    title="日曆"
                                    aria-pressed={viewMode === 'calendar'}
                                >
                                    <Icon path={paths.calendar} size={16} />
                                    <span className="hidden sm:inline">日曆</span>
                                </button>
                                <button
                                    onClick={() => setViewMode('gantt')}
                                    className={`px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center gap-2 ${viewMode === 'gantt'
                                        ? 'bg-white text-indigo-600 shadow-md'
                                        : 'text-slate-600 hover:text-slate-900'
                                        }`}
                                    title="甘特圖"
                                    aria-pressed={viewMode === 'gantt'}
                                >
                                    <Icon path={paths.gantt} size={16} />
                                    <span className="hidden sm:inline">甘特圖</span>
                                </button>

                                {/* 設定按鈕 - Phase 1: 系統管理介面 */}
                                <button
                                    onClick={() => setViewMode('settings')}
                                    className={`px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium transition-all duration-200 ${viewMode === 'settings'
                                        ? 'bg-indigo-100 text-indigo-700 shadow-sm ring-2 ring-indigo-200'
                                        : 'text-slate-600 hover:bg-slate-100 hover:text-slate-800'
                                        }`}
                                    title="設定"
                                    aria-pressed={viewMode === 'settings'}
                                >
                                    <Icon path={paths.settings} size={16} />
                                    <span className="hidden sm:inline">設定</span>
                                </button>
                            </div>

                            <div className="w-px h-8 bg-slate-300"></div>

                            {/* Excel 上傳按鈕 - 優化樣式 */}
                            <button
                                onClick={() => fileInputRef.current?.click()}
                                className="bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium transition-all duration-200 shadow-md hover:shadow-lg hover:-translate-y-0.5"
                                aria-label="上傳 Excel 檔案"
                                title="上傳 UnifiedTaskManager Excel 檔案"
                            >
                                <Icon path={paths.file} size={16} />
                                <span className="hidden sm:inline">上傳 Excel</span>
                            </button>
                            <input
                                ref={fileInputRef}
                                type="file"
                                accept=".xlsx,.xls,.csv"
                                onChange={handleFileUpload}
                                className="hidden"
                                aria-hidden="true"
                            />
                            <button
                                onClick={() => { setEditingTask(null); setIsModalOpen(true); }}
                                className="bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium transition-all duration-200 shadow-md hover:shadow-lg hover:-translate-y-0.5"
                                aria-label="新增任務"
                            >
                                <Icon path={paths.plus} size={16} />
                                <span className="hidden sm:inline">新增</span>
                            </button>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 py-8">
                        {/* Error Banner */}
                        {alerts.length > 0 && (
                            <div className="mb-6 grid gap-2">
                                {alerts.map((a, i) => (
                                    <div key={i} className={`p-3 rounded-md border flex items-center gap-2 text-sm font-medium ${a.type === 'danger' ? 'bg-red-50 border-red-200 text-red-700' : 'bg-orange-50 border-orange-200 text-orange-700'}`}>
                                        <Icon path={paths.alert} size={16} /> {a.msg}
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Stat Cards - 1行緊湊版 */}
                        <div className="grid grid-cols-1 md:grid-cols-6 gap-3 mb-4">
                            {[
                                { label: '總任務', val: stats.total, color: 'text-slate-800', bgGradient: 'from-slate-50 to-slate-100', icon: '📊', type: null },
                                { label: '檢查點', val: stats.checkpoints, color: 'text-indigo-600', bgGradient: 'from-indigo-50 to-indigo-100', icon: '📍', type: 'Checkpoints' },
                                { label: '待辦急件', val: stats.pendingHigh, color: 'text-orange-600', bgGradient: 'from-orange-50 to-orange-100', icon: '⚡', type: 'Urgent' },
                                { label: '應開工未動', val: stats.lateStart, color: 'text-red-600', bgGradient: 'from-red-50 to-red-100', icon: '⏰', type: 'LateStart' },
                                { label: '已逾期', val: stats.delayed, color: 'text-rose-600', bgGradient: 'from-rose-50 to-rose-100', icon: '❌', type: 'Delayed' },
                                { label: '已完成', val: stats.completed, color: 'text-green-600', bgGradient: 'from-green-50 to-green-100', icon: '✓', type: 'Completed' }
                            ].map((s, i) => (
                                <button
                                    key={i}
                                    onClick={() => s.type !== undefined && toggleStatFilter(s.type)}
                                    className={`bg-gradient-to-br ${s.bgGradient} p-4 rounded-lg border-2 shadow-md text-left transition-all duration-200 hover:shadow-xl hover:-translate-y-1 hover:scale-105 ${filterStat === s.type
                                        ? 'ring-2 ring-indigo-500 border-indigo-300'
                                        : 'border-transparent hover:border-slate-200'
                                        }`}
                                >
                                    <div className="flex items-center justify-between mb-1.5">
                                        <div className="text-xs text-slate-600 font-medium">{s.label}</div>
                                        <div className="text-xl">{s.icon}</div>
                                    </div>
                                    <div className={`text-3xl font-bold ${s.color}`}>{s.val}</div>
                                </button>
                            ))}
                        </div>

                        {/* Main Views */}
                        {/* Gantt 視圖專用搜尋框 */}
                        {viewMode === 'gantt' && (
                            <div className="bg-white rounded-lg border border-slate-200 shadow-sm p-4 space-y-3 mb-6">
                                <div className="relative">
                                    <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400">
                                        <Icon path={paths.search} size={16} />
                                    </div>
                                    <input
                                        type="text"
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        placeholder="搜尋任務或負責人..."
                                        className="w-full pl-10 pr-10 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"
                                        autoComplete="off"
                                    />
                                    {searchQuery && (
                                        <button
                                            onClick={() => setSearchQuery('')}
                                            className="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors"
                                            aria-label="清除搜尋"
                                        >
                                            <Icon path={paths.x} size={16} />
                                        </button>
                                    )}
                                </div>
                                {searchQuery && (
                                    <div className="flex items-center gap-2 text-xs text-indigo-700">
                                        <Icon path={paths.search} size={12} />
                                        <span>搜尋「<strong>{searchQuery}</strong>」</span>
                                        <button
                                            onClick={() => setSearchQuery('')}
                                            className="text-indigo-600 hover:text-indigo-800 font-medium ml-auto"
                                        >
                                            清除搜尋
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}
                        {viewMode === 'gantt' ? <GanttView /> : (
                            viewMode === 'settings' ? (
                                <SettingsView apiUrl={API_URL} />
                            ) : viewMode === 'dashboard' ? (
                                <div className="space-y-4">
                                    {/* 篩選與搜尋區 - 優化布局 */}
                                    <div className="space-y-3">
                                        {/* 第一行: Team 篩選按鈕 */}
                                        <div className="flex flex-wrap gap-2 bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                                            {['All', ...TEAMS].map(t => (
                                                <button
                                                    key={t}
                                                    onClick={() => setFilterTeam(t)}
                                                    className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all whitespace-nowrap ${filterTeam === t
                                                        ? 'bg-slate-800 text-white shadow-md'
                                                        : 'text-slate-600 hover:bg-slate-100 hover:shadow-sm'
                                                        }`}
                                                >
                                                    {t}
                                                </button>
                                            ))}
                                        </div>

                                        {/* ✅ 新增: Project 篩選按鈕 */}
                                        <div className="flex flex-wrap gap-2 bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                                            <span className="text-xs text-slate-500 font-semibold self-center mr-2">專案:</span>
                                            {['All', ...PROJECTS].map(p => (
                                                <button
                                                    key={p}
                                                    onClick={() => setFilterProject(p)}
                                                    className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all whitespace-nowrap ${filterProject === p
                                                        ? `${getProjectColor(p)} shadow-md`
                                                        : 'text-slate-600 hover:bg-slate-100 hover:shadow-sm'
                                                        }`}
                                                >
                                                    {p}
                                                </button>
                                            ))}
                                        </div>

                                        {/* 第二行: 搜尋框 + 複選框 */}
                                        <div className="flex flex-col sm:flex-row gap-3 items-stretch sm:items-center">
                                            {/* 搜尋框 */}
                                            <div className="relative flex-1">
                                                <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400">
                                                    <Icon path={paths.search} size={16} />
                                                </div>
                                                <input
                                                    type="text"
                                                    value={searchQuery}
                                                    onChange={(e) => setSearchQuery(e.target.value)}
                                                    placeholder="搜尋任務或負責人..."
                                                    className="w-full pl-10 pr-10 py-2.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none shadow-sm"
                                                />
                                                {searchQuery && (
                                                    <button
                                                        onClick={() => setSearchQuery('')}
                                                        className="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors"
                                                        aria-label="清除搜尋"
                                                    >
                                                        <Icon path={paths.x} size={16} />
                                                    </button>
                                                )}
                                            </div>

                                            {/* 隱藏已完成勾選框 */}
                                            <label className="flex items-center gap-2 cursor-pointer text-sm text-slate-700 hover:text-indigo-600 transition-colors bg-white px-4 py-2.5 rounded-lg border border-slate-200 shadow-sm whitespace-nowrap">

                                                <input
                                                    type="checkbox"
                                                    checked={hideCompleted}
                                                    onChange={(e) => setHideCompleted(e.target.checked)}
                                                    className="w-4 h-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500 focus:ring-2"
                                                />
                                                <span className="font-medium">隱藏已完成</span>
                                            </label>

                                            {/* 高亮開關 */}
                                            <div className="flex items-center gap-2 text-sm bg-white px-3 py-2 rounded-lg border">
                                                <input
                                                    type="checkbox"
                                                    id="highlightUrgent"
                                                    checked={highlightUrgent}
                                                    onChange={(e) => setHighlightUrgent(e.target.checked)}
                                                    className="rounded text-indigo-600 focus:ring-indigo-500 cursor-pointer"
                                                />
                                                <label htmlFor="highlightUrgent" className="text-slate-600 cursor-pointer select-none whitespace-nowrap">
                                                    強調延遲/應開工
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    {/* 搜尋結果提示 */}
                                    {searchQuery && (
                                        <div className="px-4 py-3 bg-indigo-50 border border-indigo-200 rounded-lg flex items-center justify-between">
                                            <span className="text-sm text-indigo-700 flex items-center gap-2">
                                                <Icon path={paths.search} size={14} />
                                                搜尋「<strong>{searchQuery}</strong>」找到 <strong>{filteredTasks.length}</strong> 個結果
                                            </span>
                                            <button
                                                onClick={() => setSearchQuery('')}
                                                className="text-indigo-600 hover:text-indigo-800 text-sm font-medium transition-colors"
                                            >
                                                清除搜尋
                                            </button>
                                        </div>
                                    )}

                                    {filteredTasks.length === 0 && !isLoading ? (
                                        <div className="p-12 text-center bg-white rounded-xl border shadow-sm">
                                            <div className="text-slate-300 mb-4"><Icon path={paths.list} size={48} className="mx-auto" /></div>
                                            <h3 className="text-lg font-bold text-slate-600 mb-2">沒有符合條件的任務</h3>
                                            <p className="text-slate-400">請調整篩選條件或新增任務</p>
                                        </div>
                                    ) : (
                                        <div className="bg-white rounded-xl border-2 border-slate-200 shadow-md overflow-hidden">
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm">
                                                    <thead className="bg-gradient-to-r from-slate-50 to-slate-100 border-b-2 border-slate-200">
                                                        <tr>
                                                            <th className="px-4 py-4 text-left font-semibold text-slate-700 w-44">ID</th>
                                                            <th className="px-4 py-4 text-left font-semibold text-slate-700 w-32">狀態</th>
                                                            <th className="px-4 py-4 text-left font-semibold text-slate-700">任務</th>
                                                            <th className="px-4 py-4 text-left font-semibold text-slate-700 w-36">工時/建議開始</th>
                                                            <th className="px-4 py-4 text-left font-semibold text-slate-700 w-28">完成日</th>
                                                            <th className="px-4 py-4 text-left font-semibold text-slate-700 w-20">負責人</th>
                                                            <th className="px-4 py-4 text-right font-semibold text-slate-700 w-24">動作</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-slate-200">
                                                        {filteredTasks.sort((a, b) => new Date(a.date) - new Date(b.date)).map(t => (
                                                            <tr
                                                                key={t.id}
                                                                className={`hover:bg-slate-50 group transition-all duration-150 ${t.isCheckpoint ? 'bg-indigo-50/50' : ''} ${getRowHighlight(t)}`}
                                                                tabIndex={0}
                                                            >
                                                                <td className="px-4 py-4">
                                                                    <div className="font-mono text-xs text-slate-600 font-semibold">#{t.id}</div>
                                                                </td>
                                                                <td className="px-4 py-4">
                                                                    {getStatusBadge(t)}
                                                                    <div className={`text-[10px] mt-1.5 px-2 py-0.5 w-fit rounded-full border font-medium ${getTeamBadgeClass(t.team)}`}>{t.team}</div>
                                                                    {t.project && <div className={`text-[10px] mt-1 px-2 py-0.5 w-fit rounded-md border font-medium ${getProjectColor(t.project)}`}>{t.project}</div>}
                                                                </td>
                                                                <td className="px-4 py-4">
                                                                    <div className="font-medium text-slate-900 flex items-center gap-2">
                                                                        {t.isCheckpoint && <Icon path={paths.flag} size={14} className="text-indigo-600 fill-indigo-100 flex-shrink-0" />}
                                                                        <span className="line-clamp-2">{t.task}</span>
                                                                        {t.dependency && <div className="tooltip-container flex-shrink-0"><Icon path={paths.link} size={12} className="text-slate-400" /><span className="tooltip-text">前置任務: {parseDependencies(t.dependency).map(id => `#${id}`).join(', ')}</span></div>}
                                                                        {t.notes && <div className="tooltip-container flex-shrink-0"><Icon path={paths.file} size={12} className="text-slate-400" /><span className="tooltip-text">{t.notes}</span></div>}
                                                                    </div>
                                                                    {t.priority === 'High' && <span className="text-[10px] text-orange-600 font-bold mt-1 inline-block">⚡ 急件</span>}
                                                                </td>
                                                                <td className="px-4 py-4 text-slate-600">
                                                                    <div className="flex items-center gap-1.5"><Icon path={paths.timer} size={14} className="text-slate-400" /> <span className="font-medium">{t.duration}</span> 天</div>
                                                                    <div className="text-[10px] text-slate-400 mt-1">Start: {getStartDate(t.date, t.duration)}</div>
                                                                </td>
                                                                <td className="px-4 py-4">
                                                                    <div className="font-semibold text-slate-700">{t.date}</div>
                                                                </td>
                                                                <td className="px-4 py-4">
                                                                    <div className="w-8 h-8 rounded-full bg-gradient-to-br from-slate-200 to-slate-300 flex items-center justify-center text-xs font-bold text-slate-700 shadow-sm">
                                                                        {t.owner ? t.owner[0] : '?'}
                                                                    </div>
                                                                </td>
                                                                <td className="px-4 py-4 text-right">
                                                                    <div className="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-all duration-200">
                                                                        <button
                                                                            onClick={() => { setEditingTask(t); setIsModalOpen(true); }}
                                                                            className="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded transition-colors"
                                                                            title="編輯"
                                                                        >
                                                                            <Icon path={paths.edit} size={16} />
                                                                        </button>
                                                                        <button
                                                                            onClick={() => handleDelete(t.id)}
                                                                            className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors"
                                                                            title="刪除"
                                                                        >
                                                                            <Icon path={paths.trash} size={16} />
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    )}

                                    {/* 圓餅圖 - 移到任務列表下方 */}
                                    <div className="bg-white p-6 rounded-xl border-2 border-slate-200 shadow-md">
                                        <div className="flex items-center justify-between mb-4">
                                            <h3 className="font-bold text-slate-800 text-lg flex items-center gap-2">
                                                <span>📊</span>
                                                專案分布
                                            </h3>
                                            <div className="text-xs text-slate-500">
                                                依Team分類統計
                                            </div>
                                        </div>
                                        <div className="h-80">
                                            {window.Recharts && (
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <PieChart>
                                                        <Pie
                                                            data={chartData}
                                                            dataKey="value"
                                                            cx="50%"
                                                            cy="50%"
                                                            innerRadius={80}
                                                            outerRadius={120}
                                                            paddingAngle={5}
                                                        >
                                                            {chartData.map((e, i) => <Cell key={i} fill={e.color} />)}
                                                        </Pie>
                                                        <Tooltip />
                                                        <Legend verticalAlign="bottom" height={36} />
                                                    </PieChart>
                                                </ResponsiveContainer>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-lg font-bold text-slate-800">
                                            {calendarMonth.toLocaleString('default', { year: 'numeric', month: 'long' })}
                                        </h2>
                                        <div className="flex gap-2">
                                            <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-slate-100 rounded-full"><Icon path={paths.left} /></button>
                                            <button onClick={() => changeMonth(1)} className="p-2 hover:bg-slate-100 rounded-full"><Icon path={paths.right} /></button>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-7 gap-px bg-slate-200 border border-slate-200 rounded-lg overflow-hidden">
                                        {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => (
                                            <div key={d} className="bg-slate-50 py-2 text-center text-xs font-bold text-slate-500 uppercase">{d}</div>
                                        ))}
                                        {calendarDays.map((day, idx) => (
                                            <div key={idx} className={`bg-white min-h-[120px] p-2 relative calendar-cell ${!day ? 'bg-slate-50/50' : ''}`}>
                                                {day && (
                                                    <>
                                                        <span className={`text-xs font-medium ${day.date === new Date().getDate() && calendarMonth.getMonth() === new Date().getMonth() ? 'bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center' : 'text-slate-400'}`}>{day.date}</span>
                                                        <div className="mt-1 space-y-1 overflow-y-auto max-h-[100px] scrollbar-hide">
                                                            {day.tasks.map(t => (
                                                                <div key={t.id}
                                                                    onClick={() => { setEditingTask(t); setIsModalOpen(true); }}
                                                                    className={`group text-[10px] p-1 rounded border-l-2 cursor-pointer hover:opacity-80 flex items-center gap-1 ${getProjectColor(t.project)} ${t.isCheckpoint ? 'font-bold' : ''}`}>
                                                                    {t.isCheckpoint && <Icon path={paths.flag} size={8} />}
                                                                    <span className="truncate">
                                                                        <span className="font-mono text-[9px] mr-1 opacity-70 hidden group-hover:inline">#{t.id}</span>
                                                                        {t.task}
                                                                    </span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )
                        )}
                    </div>

                    {
                        isModalOpen && (
                            <div
                                className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
                                role="dialog"
                                aria-modal="true"
                                aria-labelledby="modal-title"
                            >
                                <div className="bg-white rounded-xl shadow-xl w-full max-w-lg max-h-[90vh] animate-fade-in overflow-hidden flex flex-col">
                                    <div className="p-4 border-b flex justify-between items-center bg-slate-50 flex-shrink-0">
                                        <h3 id="modal-title" className="font-bold text-slate-800">{editingTask ? '編輯任務' : '新增任務'}</h3>
                                        <button
                                            onClick={() => setIsModalOpen(false)}
                                            className="text-slate-400 hover:text-slate-600"
                                            aria-label="關閉對話框"
                                        >
                                            <Icon path={paths.x} />
                                        </button>
                                    </div>
                                    {/* 可滾動內容區 */}
                                    <div className="overflow-y-auto flex-1">
                                        <form onSubmit={handleSave} id="task-form" className="p-6 space-y-4">
                                            <div>
                                                <label className="block text-sm font-medium text-slate-700 mb-1">任務內容 <span className="text-red-500">*</span></label>
                                                <input name="task" defaultValue={editingTask?.task} required className="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" />
                                            </div>

                                            {/* 基本資訊區塊 */}
                                            <div className="bg-slate-50 p-4 rounded-lg border space-y-3">
                                                <h4 className="text-xs font-semibold text-slate-600 uppercase">基本資訊</h4>

                                                {/* Project - 新增! */}
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">
                                                        專案 (Project) <span className="text-red-500">*</span>
                                                    </label>
                                                    <select name="project" defaultValue={editingTask?.project || PROJECTS[0]} required className="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500">
                                                        {PROJECTS.map(p => <option key={p} value={p}>{p}</option>)}
                                                    </select>
                                                </div>

                                                {/* Team改為單列 */}
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">Team <span className="text-red-500">*</span></label>
                                                    <select name="team" defaultValue={editingTask?.team || '晶片'} className="w-full border rounded-lg p-2 text-sm">
                                                        {TEAMS.map(t => <option key={t} value={t}>{t}</option>)}
                                                    </select>
                                                </div>

                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-1">負責人 <span className="text-red-500">*</span></label>
                                                        <input list="owners" name="owner" defaultValue={editingTask?.owner} required className="w-full border rounded-lg p-2 text-sm" />
                                                        <datalist id="owners">{OWNERS.map(o => <option key={o} value={o} />)}</datalist>
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-1">預計工時 (天)</label>
                                                        <input type="number" name="duration" defaultValue={editingTask?.duration || 1} min="0" className="w-full border rounded-lg p-2 text-sm" />
                                                    </div>
                                                </div>
                                            </div>

                                            {/* 時間規劃區塊 */}
                                            <div className="bg-slate-50 p-4 rounded-lg border space-y-3">
                                                <h4 className="text-xs font-semibold text-slate-600 uppercase">時間規劃</h4>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-1">開始日期</label>
                                                        <input type="date" name="startDate" defaultValue={editingTask?.startDate || ''} className="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500" />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-1">完成日 <span className="text-red-500">*</span></label>
                                                        <input type="date" name="date" defaultValue={editingTask?.date || todayStr} required className="w-full border rounded-lg p-2 text-sm" />
                                                    </div>
                                                </div>
                                            </div>

                                            {/* 狀態與優先級區塊 */}
                                            <div className="bg-slate-50 p-4 rounded-lg border space-y-3">
                                                <h4 className="text-xs font-semibold text-slate-600 uppercase">狀態與優先級</h4>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-1">狀態</label>
                                                        <select name="status" defaultValue={editingTask?.status || 'Todo'} className="w-full border rounded-lg p-2 text-sm">
                                                            <option value="Todo">待執行</option>
                                                            <option value="InProgress">進行中</option>
                                                            <option value="Pending">暫停/等待</option>
                                                            <option value="Done">完成</option>
                                                            <option value="Closed">不執行/取消</option>
                                                            <option value="Delayed">延誤</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-1">優先級</label>
                                                        <select name="priority" defaultValue={editingTask?.priority || 'Medium'} className="w-full border rounded-lg p-2 text-sm">
                                                            <option value="Low">Low</option><option value="Medium">Medium</option><option value="High">High</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* 關聯資訊區塊 */}
                                            <div className="space-y-3">
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">前置任務 / 相依性 (Dependency)</label>
                                                    <input name="dependency" defaultValue={editingTask?.dependency} placeholder="輸入前置任務 ID，多個請用逗號分隔 (例如: 5,12,18)" className="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" />
                                                    <p className="text-xs text-slate-500 mt-1">💡 提示:可填寫多個 ID,用逗號分隔,最多 10 個</p>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">驗證方式 (Verification)</label>
                                                    <textarea name="verification" defaultValue={editingTask?.verification} rows="2" placeholder="如何驗證此任務已完成? 例如: 通過測試、客戶簽收、文件審核..." className="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"></textarea>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">備註 (Notes)</label>
                                                    <textarea name="notes" defaultValue={editingTask?.notes} rows="2" placeholder="詳細說明..." className="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"></textarea>
                                                </div>
                                            </div>

                                            {/* 特殊標記區塊 */}
                                            <div className="bg-slate-50 p-4 rounded-lg border space-y-3">
                                                <h4 className="text-xs font-semibold text-slate-600 uppercase">特殊標記</h4>

                                                {/* Checkpoint複選框 */}
                                                <div className="flex items-center gap-3">
                                                    <div className="checkbox-container">
                                                        <input type="checkbox" name="isCheckpoint" id="chk" defaultChecked={editingTask?.isCheckpoint} className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all" />
                                                        <label htmlFor="chk" className="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer transition-all"></label>
                                                    </div>
                                                    <label htmlFor="chk" className="text-sm font-medium text-slate-700 cursor-pointer flex items-center gap-1">設為檢查點 (Checkpoint) <Icon path={paths.flag} size={14} /></label>
                                                </div>

                                                {/* Issue Pool複選框 - 新增! */}
                                                <div className="flex items-center gap-3">
                                                    <input
                                                        type="checkbox"
                                                        name="issuePool"
                                                        id="issuePool"
                                                        defaultChecked={editingTask?.issuePool || false}
                                                        className="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer"
                                                    />
                                                    <label htmlFor="issuePool" className="text-sm font-medium text-slate-700 cursor-pointer">
                                                        🔖 加入Issue認領區
                                                    </label>
                                                </div>
                                            </div>
                                        </form>
                                    </div>

                                    {/* 固定按鈕區 */}
                                    <div className="p-4 border-t bg-white flex justify-end gap-2 flex-shrink-0">
                                        <button type="button" onClick={() => setIsModalOpen(false)} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm">取消</button>
                                        <button type="submit" form="task-form" className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 shadow-sm">儲存</button>
                                    </div>
                                </div>
                            </div>
                        )
                    }
                </div >
            );
        };

    </script>

    <!-- ==================== 外部組件引入 ==================== -->
    <!-- Phase 1: 系統管理介面 -->
    <script type="text/babel" src="js/components/SettingsView.js"></script>

    <!-- ==================== 應用啟動 ==================== -->
    <script type="text/babel">
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

</body>

</html>