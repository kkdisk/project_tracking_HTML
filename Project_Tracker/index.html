<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Tracker v6.8 </title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            safelist: [
                'bg-rose-50', 'bg-rose-50/50', 'border-rose-500', 'bg-rose-100', 'text-rose-700',
                'bg-red-50', 'hover:bg-red-50/30', 'border-red-500', 'bg-red-100', 'text-red-700', 'border-red-200',
                'bg-orange-50', 'bg-orange-50/30', 'border-orange-500', 'bg-orange-100', 'text-orange-700', 'border-orange-200',
                'bg-yellow-100', 'text-yellow-700', 'border-yellow-200',
                'border-l-4'
            ]
        }
    </script>

    <!-- React & ReactDOM -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>

    <!-- Prop Types -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>

    <!-- Recharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.10.3/Recharts.min.js"></script>

    <!-- Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <!-- SheetJS for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Data Converter - å¼·åˆ¶é‡æ–°è¼‰å…¥ä¿®å¾©å¾Œçš„ç‰ˆæœ¬ -->
    <script src="js/data_converter.js?v=13101322"></script>

    <!-- ç«‹å³è¦†å¯« normalizeDate å‡½æ•¸ä»¥ä¿®å¾© Excel æ—¥æœŸå•é¡Œ -->
    <script>
        // å¼·åˆ¶åˆªé™¤èˆŠç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (typeof normalizeDate !== 'undefined') {
            try {
                delete window.normalizeDate;
                // ä¹Ÿå˜—è©¦åˆªé™¤å…¨åŸŸä½œç”¨åŸŸä¸­çš„å®šç¾©
                if (typeof normalizeDate !== 'undefined') {
                    normalizeDate = undefined;
                }
            } catch (e) {
                console.warn('[FIX] ç„¡æ³•åˆªé™¤èˆŠ normalizeDate:', e);
            }
        }

        // å®šç¾©æ–°çš„ normalizeDate å‡½æ•¸ï¼ˆæ”¯æ´ Excel åºåˆ—è™Ÿ + ISO å­—ä¸²ï¼‰
        window.normalizeDate = function (dateInput) {
            if (!dateInput && dateInput !== 0) return '';

            // å·²ç¶“æ˜¯ YYYY-MM-DD æ ¼å¼
            if (typeof dateInput === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateInput)) {
                return dateInput;
            }

            try {
                let date;

                // è™•ç† Excel æ—¥æœŸåºåˆ—è™Ÿï¼ˆæ•¸å­—é¡å‹ï¼‰
                if (typeof dateInput === 'number') {
                    console.log('[FIX] è™•ç† Excel åºåˆ—è™Ÿ:', dateInput);
                    // Excel çš„æ—¥æœŸåºåˆ—è™ŸåŸºæº–æ˜¯ 1900-01-01
                    const excelEpoch = new Date(1899, 11, 30); // 1899-12-30
                    const milliseconds = dateInput * 86400000;
                    date = new Date(excelEpoch.getTime() + milliseconds);
                    console.log('[FIX] è½‰æ›çµæœ:', date.toISOString());
                } else if (typeof dateInput === 'string') {
                    // è™•ç† ISO å­—ä¸²ï¼ˆGoogle Sheetsï¼‰æˆ–å…¶ä»–æ—¥æœŸå­—ä¸²
                    console.log('[FIX] è™•ç†æ—¥æœŸå­—ä¸²:', dateInput);
                    date = new Date(dateInput);

                    // å¦‚æœæ˜¯ ISO å­—ä¸²æ ¼å¼ï¼ˆå«æ™‚å€ï¼‰ï¼Œéœ€è¦èª¿æ•´ç‚ºç•¶åœ°æ—¥æœŸ
                    if (/^\d{4}-\d{2}-\d{2}T/.test(dateInput)) {
                        // ISO å­—ä¸²åŒ…å«æ™‚é–“ï¼Œå¯èƒ½æœ‰æ™‚å€å•é¡Œ
                        // ä½¿ç”¨ UTC æ—¥æœŸéƒ¨åˆ†é¿å…æ™‚å€è½‰æ›
                        const utcDate = new Date(dateInput);
                        date = new Date(utcDate.getUTCFullYear(), utcDate.getUTCMonth(), utcDate.getUTCDate());
                        console.log('[FIX] ISO å­—ä¸²èª¿æ•´ç‚ºæœ¬åœ°æ—¥æœŸ:', date);
                    }
                } else {
                    // å…¶ä»–é¡å‹å˜—è©¦ç›´æ¥è§£æ
                    date = new Date(dateInput);
                }

                if (isNaN(date.getTime())) {
                    console.warn('[FIX] ç„¡æ³•è§£æ:', dateInput);
                    return '';
                }

                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const result = `${year}-${month}-${day}`;
                console.log('[FIX] æœ€çµ‚çµæœ:', result);
                return result;
            } catch (e) {
                console.error('[FIX] éŒ¯èª¤:', dateInput, e);
                return '';
            }
        };

        // å¼·åˆ¶è¨­ç½®ç‚ºå…¨åŸŸå‡½æ•¸ï¼ˆå¤šç¨®æ–¹å¼ç¢ºä¿ç”Ÿæ•ˆï¼‰
        if (typeof window !== 'undefined') {
            window.normalizeDate = window.normalizeDate;
        }
        if (typeof global !== 'undefined') {
            global.normalizeDate = window.normalizeDate;
        }
        // ç›´æ¥è³¦å€¼åˆ°å…¨åŸŸä½œç”¨åŸŸ
        normalizeDate = window.normalizeDate;

        console.log('[FIX] normalizeDate å·²å¼·åˆ¶è¦†å¯«ï¼Œæ¸¬è©¦:', normalizeDate(45672));
    </script>

    <style>
        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8fafc;
            margin: 0;
            padding: 0;
        }

        .toggle-checkbox:checked {
            right: 0;
            border-color: #6366f1;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #6366f1;
        }

        .checkbox-container {
            position: relative;
            width: 40px;
            height: 24px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        .calendar-cell {
            min-height: 100px;
            transition: all 0.2s;
        }

        .calendar-cell:hover {
            background-color: #f1f5f9;
        }

        /* --- Gantt Layout (Fixed) --- */
        .gantt-container {
            position: relative;
            overflow: auto;
            height: 100%;
        }

        .gantt-wrapper {
            flex: 1;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .gantt-header-row {
            display: flex;
            position: sticky;
            top: 0;
            z-index: 50;
            background: #f8fafc;
        }

        .gantt-body {
            overflow: auto;
            flex: 1;
        }

        /* Headers */
        .gantt-header-task {
            position: sticky;
            left: 0;
            z-index: 40;
            background-color: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            font-weight: bold;
            padding: 8px;
            height: 60px;
            display: flex;
            align-items: center;
            border-right: 1px solid #e2e8f0;
            width: 200px;
            flex-shrink: 0;
        }

        .gantt-header-timeline {
            position: sticky;
            top: 0;
            z-index: 30;
            background-color: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            height: 60px;
            display: flex;
            flex-direction: column;
        }

        .gantt-header-wrapper {
            display: flex;
            width: max-content;
        }

        .gantt-header-month-row {
            height: 30px;
            display: flex;
            border-bottom: 1px solid #e2e8f0;
        }

        .gantt-header-day-row {
            height: 30px;
            display: flex;
        }

        .gantt-month-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: #475569;
            border-right: 1px solid #e2e8f0;
            box-sizing: border-box;
        }

        .gantt-day-cell {
            border-right: 1px solid #f1f5f9;
            height: 100%;
            text-align: center;
            font-size: 0.7rem;
            padding-top: 4px;
            box-sizing: border-box;
            color: #64748b;
        }

        .is-weekend {
            background-color: #f8fafc;
        }

        /* Body */
        .gantt-body-content {
            position: relative;
            width: max-content;
            min-width: 100%;
        }

        /* Row (Crucial Fix: display: flex) */
        .gantt-row {
            display: flex;
            height: 40px;
            border-bottom: 1px solid #f1f5f9;
            background-color: #fff;
            position: relative;
        }

        .gantt-row:hover {
            background-color: #f8fafc;
        }

        .gantt-task-col {
            width: 200px;
            flex-shrink: 0;
            padding: 8px;
            border-right: 1px solid #e2e8f0;
            font-size: 0.875rem;
            background: #fff;
            position: sticky;
            left: 0;
            z-index: 35;
            height: 40px;
            display: flex;
            align-items: center;
            box-shadow: 1px 0 3px rgba(0, 0, 0, 0.05);
        }

        .gantt-row:hover .gantt-task-col {
            background-color: #f8fafc;
        }

        .gantt-timeline-col {
            position: relative;
            flex: 1;
            height: 40px;
        }

        /* Grid Lines */
        .gantt-grid-lines {
            position: absolute;
            top: 0;
            left: 200px;
            bottom: 0;
            display: flex;
            pointer-events: none;
            z-index: 0;
        }

        .gantt-grid-col {
            border-right: 1px solid #f1f5f9;
            height: 100%;
            box-sizing: border-box;
        }

        /* Bars */
        .gantt-bar {
            position: absolute;
            height: 24px;
            top: 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 8px;
            white-space: nowrap;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
            z-index: 20;
        }

        .gantt-bar:hover {
            opacity: 0.9;
            transform: scaleY(1.05);
            z-index: 25;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Today Line */
        .today-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #ef4444;
            z-index: 15;
            pointer-events: none;
            opacity: 0.5;
        }

        /* SVG */
        .dependency-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        /* Tooltip style */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 50;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            pointer-events: none;
            white-space: normal;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Modal scroll styling */
        .overflow-y-auto {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
        }

        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }

        .overflow-y-auto::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script src="js/config.js"></script>
    <script type="text/babel" src="js/utils/icons.js"></script>
    <script type="text/babel" src="js/utils/helpers.js"></script>
    <script type="text/babel" src="js/components/GanttView.js"></script>
    <script type="text/babel" src="js/components/CalendarView.js"></script>
    <script type="text/babel" src="js/components/TaskModal.js"></script>
    <script type="text/babel" src="js/components/Dashboard.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend } = window.Recharts || {};

        // CATEGORIES moved to config.js

        // âœ… Task IDéƒ¨é–€ä»£ç¢¼Mapping (ç”¨æ–¼æœªä¾†Task IDå‡ç´š)
        const DEPT_CODES = {
            'æ™¶ç‰‡': 'CHIP',
            'æ©Ÿæ§‹': 'MECH',
            'è»Ÿé«”': 'SW',
            'é›»æ§': 'EC',
            'æµé“': 'FLOW',
            'ç”Ÿé†«': 'BIO',
            'QA': 'QA',
            'ç®¡ç†': 'MGT',
            'issue': 'ISS'
        };


        const App = () => {
            const [tasks, setTasks] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isOffline, setIsOffline] = useState(false);
            const [viewMode, setViewMode] = useState('dashboard');
            const [filterTeam, setFilterTeam] = useState('All');
            const [filterProject, setFilterProject] = useState('All'); // âœ… æ–°å¢Projectç¯©é¸
            const [filterStat, setFilterStat] = useState(null);
            const [ganttFilterTeam, setGanttFilterTeam] = useState('All');
            const [showDependencies, setShowDependencies] = useState(false);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingTask, setEditingTask] = useState(null);
            const [apiError, setApiError] = useState(null);

            const [todayStr, setTodayStr] = useState('');
            const [calendarMonth, setCalendarMonth] = useState(new Date());
            const [isMobile, setIsMobile] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [highlightUrgent, setHighlightUrgent] = useState(() => {
                const saved = localStorage.getItem('highlightUrgent');
                return saved !== null ? JSON.parse(saved) : true;
            });

            // Excel ä¸Šå‚³ç›¸é—œ
            const [dataSource, setDataSource] = useState('google'); // 'google' æˆ– 'excel'
            const [uploadProgress, setUploadProgress] = useState('');
            const fileInputRef = useRef(null);

            // éš±è—å·²å®Œæˆä»»å‹™çš„å‹¾é¸æ¡†ç‹€æ…‹ (é è¨­éš±è—)
            const [hideCompleted, setHideCompleted] = useState(() => {
                const saved = localStorage.getItem('hideCompleted');
                return saved !== null ? JSON.parse(saved) : true; // é è¨­éš±è—
            });

            // âœ… Phase 1: å‹•æ…‹ä¸»è³‡æ–™
            const [dynamicTeams, setDynamicTeams] = useState([]);
            const [dynamicProjects, setDynamicProjects] = useState([]);
            const [dynamicOwners, setDynamicOwners] = useState([]);

            // æŒä¹…åŒ–é«˜äº®è¨­å®š
            useEffect(() => {
                localStorage.setItem('highlightUrgent', JSON.stringify(highlightUrgent));
            }, [highlightUrgent]);

            // æŒä¹…åŒ–éš±è—å·²å®Œæˆè¨­å®š
            useEffect(() => {
                localStorage.setItem('hideCompleted', JSON.stringify(hideCompleted));
            }, [hideCompleted]);

            // åµæ¸¬è¡Œå‹•è£ç½®
            useEffect(() => {
                const checkMobile = () => setIsMobile(window.innerWidth < 768);
                checkMobile();
                window.addEventListener('resize', checkMobile);
                return () => window.removeEventListener('resize', checkMobile);
            }, []);

            useEffect(() => {
                setTodayStr(getTaiwanToday());
                setCalendarMonth(new Date());
            }, []);

            // âœ… Phase 1: è¼‰å…¥å‹•æ…‹ä¸»è³‡æ–™
            useEffect(() => {
                const loadMasterData = async () => {
                    try {
                        // è¼‰å…¥ Teams
                        const teamsRes = await fetch(`${API_URL}?action=getTeams`);
                        const teamsData = await teamsRes.json();
                        if (teamsData.success) {
                            setDynamicTeams(teamsData.data.filter(t => t.isActive).map(t => t.teamName));
                            console.log('âœ… å‹•æ…‹è¼‰å…¥ Teams:', teamsData.data.length);
                        }

                        // è¼‰å…¥ Projects
                        const projectsRes = await fetch(`${API_URL}?action=getProjects`);
                        const projectsData = await projectsRes.json();
                        if (projectsData.success) {
                            setDynamicProjects(projectsData.data.map(p => p.projectName));
                            console.log('âœ… å‹•æ…‹è¼‰å…¥ Projects:', projectsData.data.length);
                        }

                        // è¼‰å…¥ Owners
                        const ownersRes = await fetch(`${API_URL}?action=getOwners`);
                        const ownersData = await ownersRes.json();
                        if (ownersData.success) {
                            setDynamicOwners(ownersData.data.filter(o => o.isActive).map(o => o.ownerName));
                            console.log('âœ… å‹•æ…‹è¼‰å…¥ Owners:', ownersData.data.length);
                        }
                    } catch (error) {
                        console.error('âŒ è¼‰å…¥ä¸»è³‡æ–™å¤±æ•—:', error);
                        // å¤±æ•—æ™‚ä½¿ç”¨å‚™ä»½çš„ç¡¬ç·¨ç¢¼åˆ—è¡¨
                    }
                };
                loadMasterData();
            }, []);

            // âœ… Phase 1: å‹•æ…‹ä¸»è³‡æ–™ (å‚™ä»½åˆ—è¡¨å…§åµŒ)
            const TEAMS_FALLBACK = ['æ™¶ç‰‡', 'æ©Ÿæ§‹', 'è»Ÿé«”', 'é›»æ§', 'æµé“', 'ç”Ÿé†«', 'QA', 'ç®¡ç†', 'issue'];
            const PROJECTS_FALLBACK = ['CKSX', 'Jamstec', 'Genentech', '5880 Chip', 'Internal', 'TBD', 'Other'];
            const OWNERS_FALLBACK = ['Anting', 'å®—è½…', 'Jerry', 'å­å®—', 'Jun', 'æ…¶å¾·', 'HW', 'EE', 'RD', 'QA', 'SW', 'All', 'Unassigned'];

            const TEAMS = dynamicTeams.length > 0 ? dynamicTeams : TEAMS_FALLBACK;
            const PROJECTS = dynamicProjects.length > 0 ? dynamicProjects : PROJECTS_FALLBACK;
            const OWNERS = dynamicOwners.length > 0 ? dynamicOwners : OWNERS_FALLBACK;

            useEffect(() => {
                setIsLoading(true);
                const fetchData = async () => {
                    try {
                        setApiError(null);
                        const controller = new AbortController();
                        const id = setTimeout(() => controller.abort(), 8000);
                        const response = await fetch(API_URL + '?action=read', { signal: controller.signal });
                        clearTimeout(id);
                        if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
                        const result = await response.json();

                        console.log('===== Google Sheets è³‡æ–™é™¤éŒ¯ =====');
                        console.log('APIå®Œæ•´å›æ‡‰:', result);

                        // âœ… ä¿®æ­£: å¾resultä¸­å–å‡ºdataé™£åˆ—
                        const data = result.data || result; // æ”¯æ´å…©ç¨®æ ¼å¼: {data: [...]} æˆ– ç›´æ¥ [...]

                        console.log('è³‡æ–™ç­†æ•¸:', data.length);
                        if (data.length > 0) {
                            console.log('ç¬¬ä¸€ç­†è³‡æ–™:', data[0]);
                            console.log('æ¬„ä½åç¨±:', Object.keys(data[0]));
                        }

                        if (Array.isArray(data) && data.length > 0) {
                            // æª¢æŸ¥è³‡æ–™æ ¼å¼ï¼šUnifiedTaskManager æˆ– Project Tracker
                            const firstItem = data[0];
                            const isUTMFormat = firstItem.hasOwnProperty('ID') || firstItem.hasOwnProperty('Task');

                            console.log('è³‡æ–™æ ¼å¼:', isUTMFormat ? 'UnifiedTaskManager' : 'Project Tracker');

                            let formatted;
                            if (isUTMFormat) {
                                // UnifiedTaskManager æ ¼å¼ - ä½¿ç”¨è½‰æ›å™¨
                                const convertResult = convertUTMToTracker(data);
                                formatted = convertResult.data;
                                console.log('è½‰æ›çµæœ:', convertResult.stats);
                            } else {
                                // Project Tracker æ ¼å¼
                                formatted = data.map(item => ({
                                    ...item,
                                    id: item.id, // ä¿æŒç‚ºå­—ä¸²æ ¼å¼ (æ–°çš„Task IDæ˜¯å­—ä¸²)
                                    duration: Number(item.duration),
                                    isCheckpoint: item.isCheckpoint === true || item.isCheckpoint === "TRUE",
                                    date: normalizeDate(item.date),
                                    dependency: item.dependency || '',
                                    notes: item.notes || '',
                                    category: item.category || item.team || 'Mechanism'
                                }));
                            }
                            setTasks(formatted);
                            setDataSource('google');
                            setIsOffline(false);
                        } else {
                            setTasks(INITIAL_DATA);
                            setIsOffline(false);
                        }

                    } catch (err) {
                        console.error("API Error:", err);
                        let errorMsg = 'æœªçŸ¥éŒ¯èª¤';

                        if (err.name === 'AbortError') {
                            errorMsg = 'é€£ç·šé€¾æ™‚ (è¶…é8ç§’)';
                        } else if (err.message.includes('Failed to fetch')) {
                            errorMsg = 'ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯';
                        } else if (err.message.includes('HTTP Error')) {
                            errorMsg = `ä¼ºæœå™¨éŒ¯èª¤: ${err.message}`;
                        } else {
                            errorMsg = err.message;
                        }

                        setApiError(errorMsg);

                        // å˜—è©¦å¾æœ¬åœ°å„²å­˜è®€å–å‚™ä»½
                        const backup = localStorage.getItem('tasks_backup');
                        if (backup) {
                            try {
                                const backupTasks = JSON.parse(backup);
                                const backupTime = localStorage.getItem('tasks_backup_time');
                                setTasks(backupTasks);
                                setApiError(`${errorMsg} - ä½¿ç”¨æœ¬åœ°å‚™ä»½ (${new Date(backupTime).toLocaleString('zh-TW')})`);
                            } catch (e) {
                                setTasks(INITIAL_DATA);
                            }
                        } else {
                            setTasks(INITIAL_DATA);
                        }
                        setIsOffline(true);
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchData();
            }, []);

            // Excel æª”æ¡ˆä¸Šå‚³è™•ç†
            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                // æª¢æŸ¥æª”æ¡ˆé¡å‹
                const validExtensions = ['.xlsx', '.xls', '.csv'];
                const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
                if (!validExtensions.includes(fileExtension)) {
                    alert('æª”æ¡ˆæ ¼å¼ä¸æ”¯æ´ï¼è«‹ä¸Šå‚³ Excel (.xlsx, .xls) æˆ– CSV (.csv) æª”æ¡ˆ');
                    return;
                }

                setIsLoading(true);
                setUploadProgress(`æ­£åœ¨è®€å– ${file.name}...`);

                try {
                    const reader = new FileReader();

                    reader.onload = (e) => {
                        try {
                            setUploadProgress('æ­£åœ¨è§£ææª”æ¡ˆ...');

                            // ä½¿ç”¨ SheetJS è§£æ
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });

                            // è®€å–ç¬¬ä¸€å€‹å·¥ä½œè¡¨
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            // ä½¿ç”¨ raw: true ä¿ç•™åŸå§‹æ•¸å­—æ ¼å¼ï¼Œä¸è‡ªå‹•è½‰æ›æ—¥æœŸ
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: true });

                            console.log('===== Excel è§£æé™¤éŒ¯è³‡è¨Š =====');
                            console.log('å·¥ä½œè¡¨åç¨±:', sheetName);
                            console.log('åŸå§‹è³‡æ–™ç­†æ•¸:', jsonData.length);
                            console.log('å‰ 3 ç­†åŸå§‹è³‡æ–™:', jsonData.slice(0, 3));
                            if (jsonData.length > 0) {
                                console.log('Excel æ¬„ä½åç¨±:', Object.keys(jsonData[0]));
                                // æ–°å¢ï¼šæª¢æŸ¥æ—¥æœŸæ¬„ä½çš„å¯¦éš›å€¼
                                const firstRow = jsonData[0];
                                console.log('ç¬¬ä¸€ç­†æ—¥æœŸæ¬„ä½å€¼æª¢æŸ¥:');
                                console.log('  - Due date:', firstRow['Due date'], 'é¡å‹:', typeof firstRow['Due date']);
                                console.log('  - Start date:', firstRow['Start date'], 'é¡å‹:', typeof firstRow['Start date']);
                                console.log('  - Issue date:', firstRow['Issue date'], 'é¡å‹:', typeof firstRow['Issue date']);
                            }

                            setUploadProgress('æ­£åœ¨è½‰æ›è³‡æ–™æ ¼å¼...');

                            // ä½¿ç”¨è½‰æ›å™¨è½‰æ›è³‡æ–™
                            const result = convertUTMToTracker(jsonData);

                            console.log('===== è³‡æ–™è½‰æ›çµæœ =====');
                            console.log('è½‰æ›æˆåŠŸ:', result.success);
                            console.log('æˆåŠŸç­†æ•¸:', result.stats.converted);
                            console.log('å¤±æ•—ç­†æ•¸:', result.stats.failed);
                            console.log('éŒ¯èª¤è¨Šæ¯:', result.errors);
                            console.log('å‰ 3 ç­†è½‰æ›å¾Œè³‡æ–™:', result.data.slice(0, 3));
                            if (result.data.length > 0) {
                                console.log('ç¬¬ä¸€ç­†è½‰æ›å¾Œçš„æ—¥æœŸæ¬„ä½:');
                                console.log('  - date (End Date):', result.data[0].date);
                                console.log('  - startDate:', result.data[0].startDate);
                                console.log('  - issueDate:', result.data[0].issueDate);
                            }

                            if (!result.success) {
                                // é¡¯ç¤ºéŒ¯èª¤ä½†ä»è¼‰å…¥æˆåŠŸçš„è³‡æ–™
                                const errorMsg = result.errors.join('\n');
                                if (result.data.length > 0) {
                                    alert(`éƒ¨åˆ†è³‡æ–™è½‰æ›å¤±æ•—:\n${errorMsg}\n\nå·²æˆåŠŸè¼‰å…¥ ${result.stats.converted} / ${result.stats.total} ç­†ä»»å‹™`);
                                } else {
                                    throw new Error(`è³‡æ–™è½‰æ›å¤±æ•—:\n${errorMsg}`);
                                }
                            }

                            if (result.data.length === 0) {
                                throw new Error('æª”æ¡ˆä¸­æ²’æœ‰æœ‰æ•ˆçš„ä»»å‹™è³‡æ–™');
                            }

                            // æ›´æ–°ä»»å‹™è³‡æ–™
                            setTasks(result.data);
                            setDataSource('excel');
                            setIsOffline(true);
                            setApiError(null);

                            // å„²å­˜åˆ°æœ¬åœ°å‚™ä»½
                            try {
                                localStorage.setItem('tasks_backup', JSON.stringify(result.data));
                                localStorage.setItem('tasks_backup_time', new Date().toISOString());
                                localStorage.setItem('tasks_backup_source', file.name);
                            } catch (e) {
                                console.warn('æœ¬åœ°å„²å­˜å¤±æ•—:', e);
                            }

                            setUploadProgress(`âœ“ æˆåŠŸè¼‰å…¥ ${result.data.length} ç­†ä»»å‹™ (ä¾†è‡ª ${file.name})`);
                            setTimeout(() => setUploadProgress(''), 3000);

                        } catch (parseError) {
                            console.error('è§£æéŒ¯èª¤:', parseError);
                            alert(`æª”æ¡ˆè§£æå¤±æ•—: ${parseError.message}`);
                            setUploadProgress('');
                        } finally {
                            setIsLoading(false);
                        }
                    };

                    reader.onerror = (error) => {
                        console.error('æª”æ¡ˆè®€å–éŒ¯èª¤:', error);
                        alert('æª”æ¡ˆè®€å–å¤±æ•—ï¼Œè«‹é‡è©¦');
                        setUploadProgress('');
                        setIsLoading(false);
                    };

                    // è®€å–æª”æ¡ˆ
                    reader.readAsArrayBuffer(file);

                } catch (error) {
                    console.error('ä¸Šå‚³éŒ¯èª¤:', error);
                    alert(`ä¸Šå‚³å¤±æ•—: ${error.message}`);
                    setUploadProgress('');
                    setIsLoading(false);
                }
            };

            // æ•ˆèƒ½å„ªåŒ–ï¼šä½¿ç”¨ useMemo é¿å…ä¸å¿…è¦çš„çµ±è¨ˆè¨ˆç®—
            // åªæœ‰åœ¨ tasksã€todayStr æˆ– filterProject æ”¹è®Šæ™‚æ‰é‡æ–°è¨ˆç®—
            const stats = useMemo(() => {
                if (!todayStr) return { total: 0, checkpoints: 0, pendingHigh: 0, completed: 0, lateStart: 0, delayed: 0 };
                const baseTasks = tasks.filter(t => filterTeam === 'All' || (t.team && t.team === filterTeam));
                return {
                    total: baseTasks.length,
                    checkpoints: baseTasks.filter(t => t.isCheckpoint).length,
                    pendingHigh: baseTasks.filter(t => t.priority === 'High' && t.status !== 'Done').length,
                    completed: baseTasks.filter(t => t.status === 'Done').length,
                    lateStart: baseTasks.filter(t => {
                        const startDate = getStartDate(t.date, t.duration);
                        return t.status === 'Todo' && startDate <= todayStr && t.date >= todayStr;
                    }).length,
                    // ä¿®æ­£ï¼šå»¶é²ä»»å‹™æ‡‰åŸºæ–¼å¯¦éš›æ—¥æœŸåˆ¤æ–·ï¼Œè€Œéstatusæ¬„ä½
                    // å»¶é² = å®Œæˆæ—¥æœŸå·²éï¼ˆ< ä»Šå¤©ï¼‰ä¸”å°šæœªå®Œæˆçš„ä»»å‹™
                    delayed: baseTasks.filter(t => t.date < todayStr && t.status !== 'Done').length
                };
            }, [tasks, todayStr, filterTeam]);

            // æ•ˆèƒ½å„ªåŒ–ï¼šä½¿ç”¨ useMemo å¿«å–ç¯©é¸çµæœ
            // é¿å…æ¯æ¬¡æ¸²æŸ“éƒ½é‡æ–°åŸ·è¡Œç¯©é¸é‚è¼¯
            const filteredTasks = useMemo(() => {
                const filterFunctions = {
                    'Checkpoints': (t) => t.isCheckpoint,
                    'Urgent': (t) => t.status !== 'Done' && t.priority === 'High',
                    'Completed': (t) => t.status === 'Done',
                    'LateStart': (t) => {
                        const startDate = getStartDate(t.date, t.duration);
                        return t.status === 'Todo' && startDate <= todayStr && t.date >= todayStr;
                    },
                    'Delayed': (t) => t.date < todayStr && t.status !== 'Done'
                };

                // âœ… ä¿®æ­£Teamç¯©é¸é‚è¼¯ - æ”¯æŒIssue Pool
                let result = tasks.filter(t => {
                    if (filterTeam === 'All') return true;

                    // Issueç‰¹æ®Šè™•ç†:é¡¯ç¤ºteam=issueæˆ–issuePool=trueçš„ä»»å‹™
                    if (filterTeam === 'issue' || filterTeam === 'Issue') {
                        return (t.team && (t.team === 'issue' || t.team === 'Issue')) || t.issuePool === true;
                    }

                    // å…¶ä»–Teamæ­£å¸¸ç¯©é¸
                    return t.team && t.team === filterTeam;
                });

                // âœ… æ–°å¢:Projectç¯©é¸
                if (filterProject !== 'All') {
                    result = result.filter(t => t.project && t.project === filterProject);
                }

                if (filterStat && filterFunctions[filterStat]) {
                    result = result.filter(filterFunctions[filterStat]);
                }

                // æœå°‹ç¯©é¸ï¼šæ”¯æ´å¤šæ¬„ä½æœå°‹
                if (searchQuery.trim()) {
                    const query = searchQuery.toLowerCase();
                    result = result.filter(t => {
                        // å®‰å…¨åœ°å°‡æ¬„ä½è½‰æ›ç‚ºå­—ç¬¦ä¸²å†é€²è¡Œæœå°‹
                        const matchTask = t.task && String(t.task).toLowerCase().includes(query);
                        const matchOwner = t.owner && String(t.owner).toLowerCase().includes(query);
                        const matchNotes = t.notes && String(t.notes).toLowerCase().includes(query);
                        const matchCategory = t.category && String(t.category).toLowerCase().includes(query);
                        const matchTeam = t.team && String(t.team).toLowerCase().includes(query);
                        return matchTask || matchOwner || matchNotes || matchCategory || matchTeam;
                    });
                }

                // éš±è—å·²å®Œæˆçš„ä»»å‹™
                if (hideCompleted) {
                    result = result.filter(t => t.status !== 'Done');
                }

                return result;
            }, [tasks, filterTeam, filterProject, filterStat, todayStr, searchQuery, hideCompleted]);

            // æ•ˆèƒ½å„ªåŒ–ï¼šå¿«å–ç³»çµ±è­¦å‘Šè¨Šæ¯
            const alerts = useMemo(() => {
                if (!todayStr) return [];
                const list = [];
                const overdueCount = tasks.filter(t => t.date < todayStr && t.status !== 'Done').length;
                if (overdueCount > 0) list.push({ type: 'danger', msg: `æœ‰ ${overdueCount} å€‹ä»»å‹™å·²é€¾æœŸ` });
                if (apiError) list.push({ type: 'warning', msg: `ç³»çµ±é›¢ç·šä¸­ (${apiError})` });
                return list;
            }, [tasks, todayStr, apiError]);

            // æ•ˆèƒ½å„ªåŒ–ï¼šå¿«å–æ—¥æ›†è¦–åœ–è³‡æ–™
            // åªæœ‰åœ¨æœˆä»½æˆ–ä»»å‹™æ”¹è®Šæ™‚æ‰é‡æ–°è¨ˆç®—
            const calendarDays = useMemo(() => {
                const year = calendarMonth.getFullYear();
                const month = calendarMonth.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const days = [];
                for (let i = 0; i < firstDay.getDay(); i++) days.push(null);
                for (let i = 1; i <= lastDay.getDate(); i++) {
                    const dStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    days.push({ date: i, fullDate: dStr, tasks: tasks.filter(t => t.date === dStr) });
                }
                return days;
            }, [calendarMonth, tasks]);

            // Chart Data
            const chartData = useMemo(() => {
                // Use dynamicTeams if available, otherwise fallback to TEAMS
                const teamList = dynamicTeams.length > 0 ? dynamicTeams : TEAMS;
                return teamList.map(team => ({
                    name: team,
                    value: tasks.filter(t => t.team && t.team === team).length,
                    color: getTeamColor(team)
                })).filter(item => item.value > 0);
            }, [tasks, dynamicTeams]);

            // è§£æç›¸ä¾æ€§å­—ä¸²ç‚ºé™£åˆ—
            const parseDependencies = (depStr) => {
                if (!depStr || typeof depStr !== 'string') return [];
                return depStr.split(',').map(id => id.trim()).filter(id => id);
            };

            // Validation/Logic moved to helpers.js
            // App only triggers handleSave which uses helpers


            const handleSave = (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const defaultDate = getTaiwanToday();

                // âœ… æ–¹æ¡ˆ A ä¿®æ”¹ï¼šæ–°å¢æ™‚ä¸å‚³ idï¼Œè®“å¾Œç«¯è‡ªå‹•ç”Ÿæˆæ–°æ ¼å¼ ID
                const isEditing = !!editingTask;
                const newItem = {
                    // åªåœ¨ç·¨è¼¯æ™‚åŒ…å« id
                    ...(isEditing && { id: editingTask.id }),
                    project: fd.get('project'),
                    team: fd.get('team'),
                    task: fd.get('task'),
                    owner: fd.get('owner'),
                    startDate: fd.get('startDate') || '',
                    date: fd.get('date') || defaultDate,
                    duration: parseInt(fd.get('duration') || 0),
                    isCheckpoint: fd.get('isCheckpoint') === 'on',
                    issuePool: fd.get('issuePool') === 'on',
                    priority: fd.get('priority'),
                    status: fd.get('status'),
                    dependency: fd.get('dependency'),
                    verification: fd.get('verification'),
                    notes: fd.get('notes')
                };

                const validationErrors = validateTask(newItem);
                if (validationErrors.length > 0) { alert('é©—è­‰å¤±æ•—:\n' + validationErrors.join('\n')); return; }

                // é©—è­‰ç›¸ä¾æ€§æ ¼å¼èˆ‡æœ‰æ•ˆæ€§ï¼ˆæ–°å¢æ™‚è·³é id æª¢æŸ¥ï¼‰
                if (isEditing) {
                    const depErrors = validateDependencies(newItem.dependency, newItem.id, tasks);
                    if (depErrors.length > 0) { alert('ç›¸ä¾æ€§é©—è­‰å¤±æ•—:\n' + depErrors.join('\n')); return; }

                    // æª¢æŸ¥å¾ªç’°ç›¸ä¾æ€§
                    if (newItem.dependency && detectCircularDependency(newItem.id, newItem.dependency, tasks)) {
                        alert('éŒ¯èª¤ï¼šåµæ¸¬åˆ°å¾ªç’°ç›¸ä¾æ€§ï¼\nä»»å‹™ä¹‹é–“çš„ç›¸ä¾é—œä¿‚å½¢æˆäº†è¿´åœˆï¼Œè«‹èª¿æ•´ç›¸ä¾è¨­å®šã€‚'); return;
                    }
                }

                // æœ¬åœ°æ›´æ–°ï¼ˆç·¨è¼¯æ™‚ï¼‰æˆ–è‡¨æ™‚æ–°å¢
                if (isEditing) {
                    const updatedTasks = tasks.map(t => t.id === newItem.id ? newItem : t);
                    setTasks(updatedTasks);

                    // å„²å­˜åˆ°æœ¬åœ°å‚™ä»½
                    try {
                        localStorage.setItem('tasks_backup', JSON.stringify(updatedTasks));
                        localStorage.setItem('tasks_backup_time', new Date().toISOString());
                    } catch (e) {
                        console.warn('æœ¬åœ°å„²å­˜å¤±æ•—:', e);
                    }
                }

                setIsModalOpen(false);

                if (!isOffline) {
                    const payload = {
                        action: isEditing ? 'update' : 'upsert',  // âœ… ä½¿ç”¨ upsert è®“å¾Œç«¯è™•ç†
                        data: newItem
                    };

                    console.log('ğŸš€ ç™¼é€åˆ°API:', payload.action, isEditing ? `ä»»å‹™ID: ${newItem.id}` : 'æ–°ä»»å‹™ï¼ˆå¾Œç«¯å°‡ç”ŸæˆIDï¼‰');

                    fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',  // âœ… Google Apps Scriptéœ€è¦æ­¤è¨­å®š
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    })
                        .then(() => {
                            console.log('âœ… å·²ç™¼é€è‡³ Google Sheets');

                            // âœ… æ–°å¢ä»»å‹™å¾Œé‡æ–°è¼‰å…¥è³‡æ–™ä»¥å–å¾—å¾Œç«¯ç”Ÿæˆçš„æ–° ID
                            if (!isEditing) {
                                console.log('ğŸ”„ é‡æ–°è¼‰å…¥è³‡æ–™ä»¥å–å¾—æ–° Task ID...');
                                setIsLoading(true);

                                // å»¶é² 1 ç§’å¾Œé‡æ–°è¼‰å…¥ï¼Œçµ¦å¾Œç«¯æ™‚é–“è™•ç†
                                setTimeout(() => {
                                    fetch(API_URL + '?action=read')
                                        .then(res => res.json())
                                        .then(result => {
                                            const data = result.data || result;
                                            if (Array.isArray(data) && data.length > 0) {
                                                const formatted = data.map(item => ({
                                                    ...item,
                                                    id: item.id,
                                                    duration: Number(item.duration),
                                                    isCheckpoint: item.isCheckpoint === true || item.isCheckpoint === "TRUE",
                                                    date: normalizeDate(item.date),
                                                    dependency: item.dependency || '',
                                                    notes: item.notes || '',
                                                    category: item.category || item.team || 'Mechanism'
                                                }));
                                                setTasks(formatted);
                                                console.log('âœ… è³‡æ–™å·²é‡æ–°è¼‰å…¥ï¼Œæ–° Task ID:', formatted[formatted.length - 1]?.id);
                                            }
                                        })
                                        .catch(err => {
                                            console.error('âŒ é‡æ–°è¼‰å…¥å¤±æ•—:', err);
                                        })
                                        .finally(() => {
                                            setIsLoading(false);
                                        });
                                }, 1000);
                            }
                        })
                        .catch(err => {
                            console.error("âŒ ç™¼é€å¤±æ•—:", err);
                            alert('å„²å­˜åˆ° Google Sheets æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œä½†æœ¬åœ°å·²æ›´æ–°');
                        });
                }
            };

            const handleDelete = (id) => {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ä»»å‹™å—ï¼Ÿ(å°‡åŒæ­¥åˆªé™¤ Google Sheet è³‡æ–™)')) return;
                setTasks(prev => prev.filter(x => x.id !== id));

                console.log('ğŸ—‘ï¸ åˆªé™¤ä»»å‹™ ID:', id);

                if (!isOffline) {
                    fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'delete', data: { id: id } })
                    })
                        .then(() => console.log('âœ… åˆªé™¤æˆåŠŸ (å·²åŒæ­¥è‡³ Google Sheets)'))
                        .catch(err => {
                            console.error("âŒ Delete Error:", err);
                        });
                }
            };


            const toggleStatFilter = (type) => { setFilterStat(prev => prev === type ? null : type); setViewMode('dashboard'); };
            const changeMonth = (delta) => { const d = new Date(calendarMonth); d.setMonth(d.getMonth() + delta); setCalendarMonth(d); };

            return (
                <div className="min-h-screen pb-10">
                    {/* Header */}
                    <div className="bg-white border-b sticky top-0 z-30 shadow-sm px-6 py-4 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <div className="bg-indigo-600 text-white p-2 rounded-lg"><Icon path={paths.list} /></div>
                            <h1 className="text-xl font-bold text-slate-800">Project Tracker <span className="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full">v6.9</span></h1>
                            {isLoading && <div className="flex items-center text-sm text-slate-500 gap-2 ml-4"><div className="w-4 h-4 border-2 border-indigo-600 border-t-transparent rounded-full spinner"></div> è¼‰å…¥ä¸­...</div>}
                            {uploadProgress && <div className="flex items-center text-sm text-indigo-600 gap-2 ml-4 bg-indigo-50 px-2 py-1 rounded"><Icon path={paths.file} size={14} /> {uploadProgress}</div>}
                            {isOffline && dataSource === 'excel' && <div className="flex items-center text-sm text-emerald-600 gap-2 ml-4 bg-emerald-50 px-2 py-1 rounded"><Icon path={paths.file} size={14} /> Excel æ¨¡å¼</div>}
                            {isOffline && dataSource === 'google' && <div className="flex items-center text-sm text-red-500 gap-2 ml-4 bg-red-50 px-2 py-1 rounded"><Icon path={paths.alert} size={14} /> é›¢ç·š</div>}
                            <div className="text-xs bg-slate-100 text-slate-500 px-3 py-1 rounded-full hidden sm:block ml-4 flex items-center gap-1">
                                <Icon path={paths.clock} size={12} /> {todayStr}
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                            {/* è¦–åœ–åˆ‡æ›æŒ‰éˆ•çµ„ - Pillæ¨£å¼ */}
                            <div className="bg-slate-100 p-1 rounded-lg flex gap-1">
                                <button
                                    onClick={() => setViewMode('dashboard')}
                                    className={`px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center gap-2 ${viewMode === 'dashboard'
                                        ? 'bg-white text-indigo-600 shadow-md'
                                        : 'text-slate-600 hover:text-slate-900'
                                        }`}
                                    title="åˆ—è¡¨"
                                    aria-pressed={viewMode === 'dashboard'}
                                >
                                    <Icon path={paths.list} size={16} />
                                    <span className="hidden sm:inline">åˆ—è¡¨</span>
                                </button>
                                <button
                                    onClick={() => setViewMode('calendar')}
                                    className={`px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center gap-2 ${viewMode === 'calendar'
                                        ? 'bg-white text-indigo-600 shadow-md'
                                        : 'text-slate-600 hover:text-slate-900'
                                        }`}
                                    title="æ—¥æ›†"
                                    aria-pressed={viewMode === 'calendar'}
                                >
                                    <Icon path={paths.calendar} size={16} />
                                    <span className="hidden sm:inline">æ—¥æ›†</span>
                                </button>
                                <button
                                    onClick={() => setViewMode('gantt')}
                                    className={`px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center gap-2 ${viewMode === 'gantt'
                                        ? 'bg-white text-indigo-600 shadow-md'
                                        : 'text-slate-600 hover:text-slate-900'
                                        }`}
                                    title="ç”˜ç‰¹åœ–"
                                    aria-pressed={viewMode === 'gantt'}
                                >
                                    <Icon path={paths.gantt} size={16} />
                                    <span className="hidden sm:inline">ç”˜ç‰¹åœ–</span>
                                </button>

                                {/* è¨­å®šæŒ‰éˆ• - Phase 1: ç³»çµ±ç®¡ç†ä»‹é¢ */}
                                <button
                                    onClick={() => setViewMode('settings')}
                                    className={`px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium transition-all duration-200 ${viewMode === 'settings'
                                        ? 'bg-indigo-100 text-indigo-700 shadow-sm ring-2 ring-indigo-200'
                                        : 'text-slate-600 hover:bg-slate-100 hover:text-slate-800'
                                        }`}
                                    title="è¨­å®š"
                                    aria-pressed={viewMode === 'settings'}
                                >
                                    <Icon path={paths.settings} size={16} />
                                    <span className="hidden sm:inline">è¨­å®š</span>
                                </button>
                            </div>

                            <div className="w-px h-8 bg-slate-300"></div>

                            {/* Excel ä¸Šå‚³æŒ‰éˆ• - å„ªåŒ–æ¨£å¼ */}
                            <button
                                onClick={() => fileInputRef.current?.click()}
                                className="bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium transition-all duration-200 shadow-md hover:shadow-lg hover:-translate-y-0.5"
                                aria-label="ä¸Šå‚³ Excel æª”æ¡ˆ"
                                title="ä¸Šå‚³ UnifiedTaskManager Excel æª”æ¡ˆ"
                            >
                                <Icon path={paths.file} size={16} />
                                <span className="hidden sm:inline">ä¸Šå‚³ Excel</span>
                            </button>
                            <input
                                ref={fileInputRef}
                                type="file"
                                accept=".xlsx,.xls,.csv"
                                onChange={handleFileUpload}
                                className="hidden"
                                aria-hidden="true"
                            />
                            <button
                                onClick={() => { setEditingTask(null); setIsModalOpen(true); }}
                                className="bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium transition-all duration-200 shadow-md hover:shadow-lg hover:-translate-y-0.5"
                                aria-label="æ–°å¢ä»»å‹™"
                            >
                                <Icon path={paths.plus} size={16} />
                                <span className="hidden sm:inline">æ–°å¢</span>
                            </button>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 py-8">
                        {/* Error Banner */}
                        {alerts.length > 0 && (
                            <div className="mb-6 grid gap-2">
                                {alerts.map((a, i) => (
                                    <div key={i} className={`p-3 rounded-md border flex items-center gap-2 text-sm font-medium ${a.type === 'danger' ? 'bg-red-50 border-red-200 text-red-700' : 'bg-orange-50 border-orange-200 text-orange-700'}`}>
                                        <Icon path={paths.alert} size={16} /> {a.msg}
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Stat Cards - 1è¡Œç·Šæ¹Šç‰ˆ */}
                        <div className="grid grid-cols-1 md:grid-cols-6 gap-3 mb-4">
                            {[
                                { label: 'ç¸½ä»»å‹™', val: stats.total, color: 'text-slate-800', bgGradient: 'from-slate-50 to-slate-100', icon: 'ğŸ“Š', type: null },
                                { label: 'æª¢æŸ¥é»', val: stats.checkpoints, color: 'text-indigo-600', bgGradient: 'from-indigo-50 to-indigo-100', icon: 'ğŸ“', type: 'Checkpoints' },
                                { label: 'å¾…è¾¦æ€¥ä»¶', val: stats.pendingHigh, color: 'text-orange-600', bgGradient: 'from-orange-50 to-orange-100', icon: 'âš¡', type: 'Urgent' },
                                { label: 'æ‡‰é–‹å·¥æœªå‹•', val: stats.lateStart, color: 'text-red-600', bgGradient: 'from-red-50 to-red-100', icon: 'â°', type: 'LateStart' },
                                { label: 'å·²é€¾æœŸ', val: stats.delayed, color: 'text-rose-600', bgGradient: 'from-rose-50 to-rose-100', icon: 'âŒ', type: 'Delayed' },
                                { label: 'å·²å®Œæˆ', val: stats.completed, color: 'text-green-600', bgGradient: 'from-green-50 to-green-100', icon: 'âœ“', type: 'Completed' }
                            ].map((s, i) => (
                                <button
                                    key={i}
                                    onClick={() => s.type !== undefined && toggleStatFilter(s.type)}
                                    className={`bg-gradient-to-br ${s.bgGradient} p-4 rounded-lg border-2 shadow-md text-left transition-all duration-200 hover:shadow-xl hover:-translate-y-1 hover:scale-105 ${filterStat === s.type
                                        ? 'ring-2 ring-indigo-500 border-indigo-300'
                                        : 'border-transparent hover:border-slate-200'
                                        }`}
                                >
                                    <div className="flex items-center justify-between mb-1.5">
                                        <div className="text-xs text-slate-600 font-medium">{s.label}</div>
                                        <div className="text-xl">{s.icon}</div>
                                    </div>
                                    <div className={`text-3xl font-bold ${s.color}`}>{s.val}</div>
                                </button>
                            ))}
                        </div>

                        {/* Main Views */}
                        {/* Gantt è¦–åœ–å°ˆç”¨æœå°‹æ¡† */}
                        {viewMode === 'gantt' && (
                            <div className="bg-white rounded-lg border border-slate-200 shadow-sm p-4 space-y-3 mb-6">
                                <div className="relative">
                                    <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400">
                                        <Icon path={paths.search} size={16} />
                                    </div>
                                    <input
                                        type="text"
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        placeholder="æœå°‹ä»»å‹™æˆ–è² è²¬äºº..."
                                        className="w-full pl-10 pr-10 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"
                                        autoComplete="off"
                                    />
                                    {searchQuery && (
                                        <button
                                            onClick={() => setSearchQuery('')}
                                            className="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors"
                                            aria-label="æ¸…é™¤æœå°‹"
                                        >
                                            <Icon path={paths.x} size={16} />
                                        </button>
                                    )}
                                </div>
                                {searchQuery && (
                                    <div className="flex items-center gap-2 text-xs text-indigo-700">
                                        <Icon path={paths.search} size={12} />
                                        <span>æœå°‹ã€Œ<strong>{searchQuery}</strong>ã€</span>
                                        <button
                                            onClick={() => setSearchQuery('')}
                                            className="text-indigo-600 hover:text-indigo-800 font-medium ml-auto"
                                        >
                                            æ¸…é™¤æœå°‹
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}
                        {viewMode === 'gantt' ? <GanttView /> : (
                            viewMode === 'settings' ? (
                                <SettingsView apiUrl={API_URL} />
                            ) : viewMode === 'dashboard' ? (
                                <div className="space-y-4">
                                    {/* ç¯©é¸èˆ‡æœå°‹å€ - å„ªåŒ–å¸ƒå±€ */}
                                    <div className="space-y-3">
                                        {/* ç¬¬ä¸€è¡Œ: Team ç¯©é¸æŒ‰éˆ• */}
                                        <div className="flex flex-wrap gap-2 bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                                            {['All', ...TEAMS].map(t => (
                                                <button
                                                    key={t}
                                                    onClick={() => setFilterTeam(t)}
                                                    className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all whitespace-nowrap ${filterTeam === t
                                                        ? 'bg-slate-800 text-white shadow-md'
                                                        : 'text-slate-600 hover:bg-slate-100 hover:shadow-sm'
                                                        }`}
                                                >
                                                    {t}
                                                </button>
                                            ))}
                                        </div>

                                        {/* âœ… æ–°å¢: Project ç¯©é¸æŒ‰éˆ• */}
                                        <div className="flex flex-wrap gap-2 bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                                            <span className="text-xs text-slate-500 font-semibold self-center mr-2">å°ˆæ¡ˆ:</span>
                                            {['All', ...PROJECTS].map(p => (
                                                <button
                                                    key={p}
                                                    onClick={() => setFilterProject(p)}
                                                    className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all whitespace-nowrap ${filterProject === p
                                                        ? `${getProjectColor(p)} shadow-md`
                                                        : 'text-slate-600 hover:bg-slate-100 hover:shadow-sm'
                                                        }`}
                                                >
                                                    {p}
                                                </button>
                                            ))}
                                        </div>

                                        {/* ç¬¬äºŒè¡Œ: æœå°‹æ¡† + è¤‡é¸æ¡† */}
                                        <div className="flex flex-col sm:flex-row gap-3 items-stretch sm:items-center">
                                            {/* æœå°‹æ¡† */}
                                            <div className="relative flex-1">
                                                <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400">
                                                    <Icon path={paths.search} size={16} />
                                                </div>
                                                <input
                                                    type="text"
                                                    value={searchQuery}
                                                    onChange={(e) => setSearchQuery(e.target.value)}
                                                    placeholder="æœå°‹ä»»å‹™æˆ–è² è²¬äºº..."
                                                    className="w-full pl-10 pr-10 py-2.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none shadow-sm"
                                                />
                                                {searchQuery && (
                                                    <button
                                                        onClick={() => setSearchQuery('')}
                                                        className="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors"
                                                        aria-label="æ¸…é™¤æœå°‹"
                                                    >
                                                        <Icon path={paths.x} size={16} />
                                                    </button>
                                                )}
                                            </div>

                                            {/* éš±è—å·²å®Œæˆå‹¾é¸æ¡† */}
                                            <label className="flex items-center gap-2 cursor-pointer text-sm text-slate-700 hover:text-indigo-600 transition-colors bg-white px-4 py-2.5 rounded-lg border border-slate-200 shadow-sm whitespace-nowrap">

                                                <input
                                                    type="checkbox"
                                                    checked={hideCompleted}
                                                    onChange={(e) => setHideCompleted(e.target.checked)}
                                                    className="w-4 h-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500 focus:ring-2"
                                                />
                                                <span className="font-medium">éš±è—å·²å®Œæˆ</span>
                                            </label>

                                            {/* é«˜äº®é–‹é—œ */}
                                            <div className="flex items-center gap-2 text-sm bg-white px-3 py-2 rounded-lg border">
                                                <input
                                                    type="checkbox"
                                                    id="highlightUrgent"
                                                    checked={highlightUrgent}
                                                    onChange={(e) => setHighlightUrgent(e.target.checked)}
                                                    className="rounded text-indigo-600 focus:ring-indigo-500 cursor-pointer"
                                                />
                                                <label htmlFor="highlightUrgent" className="text-slate-600 cursor-pointer select-none whitespace-nowrap">
                                                    å¼·èª¿å»¶é²/æ‡‰é–‹å·¥
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    {/* æœå°‹çµæœæç¤º */}
                                    {searchQuery && (
                                        <div className="px-4 py-3 bg-indigo-50 border border-indigo-200 rounded-lg flex items-center justify-between">
                                            <span className="text-sm text-indigo-700 flex items-center gap-2">
                                                <Icon path={paths.search} size={14} />
                                                æœå°‹ã€Œ<strong>{searchQuery}</strong>ã€æ‰¾åˆ° <strong>{filteredTasks.length}</strong> å€‹çµæœ
                                            </span>
                                            <button
                                                onClick={() => setSearchQuery('')}
                                                className="text-indigo-600 hover:text-indigo-800 text-sm font-medium transition-colors"
                                            >
                                                æ¸…é™¤æœå°‹
                                            </button>
                                        </div>
                                    )}

                                    {filteredTasks.length === 0 && !isLoading ? (
                                        <div className="p-12 text-center bg-white rounded-xl border shadow-sm">
                                            <div className="text-slate-300 mb-4"><Icon path={paths.list} size={48} className="mx-auto" /></div>
                                            <h3 className="text-lg font-bold text-slate-600 mb-2">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ä»»å‹™</h3>
                                            <p className="text-slate-400">è«‹èª¿æ•´ç¯©é¸æ¢ä»¶æˆ–æ–°å¢ä»»å‹™</p>
                                        </div>
                                    ) : (
                                        <div className="bg-white rounded-xl border-2 border-slate-200 shadow-md overflow-hidden">
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm">
                                                    <thead className="bg-gradient-to-r from-slate-50 to-slate-100 border-b-2 border-slate-200">
                                                        <tr>
                                                            <th className="px-4 py-4 text-left font-semibold text-slate-700 w-44">ID</th>
                                                            <th className="px-4 py-4 text-left font-semibold text-slate-700 w-32">ç‹€æ…‹</th>
                                                            <th className="px-4 py-4 text-left font-semibold text-slate-700">ä»»å‹™</th>
                                                            <th className="px-4 py-4 text-left font-semibold text-slate-700 w-36">å·¥æ™‚/å»ºè­°é–‹å§‹</th>
                                                            <th className="px-4 py-4 text-left font-semibold text-slate-700 w-28">å®Œæˆæ—¥</th>
                                                            <th className="px-4 py-4 text-left font-semibold text-slate-700 w-20">è² è²¬äºº</th>
                                                            <th className="px-4 py-4 text-right font-semibold text-slate-700 w-24">å‹•ä½œ</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-slate-200">
                                                        {filteredTasks.sort((a, b) => new Date(a.date) - new Date(b.date)).map(t => (
                                                            <tr
                                                                key={t.id}
                                                                className={`hover:bg-slate-50 group transition-all duration-150 ${t.isCheckpoint ? 'bg-indigo-50/50' : ''} ${getRowHighlight(t, highlightUrgent, todayStr)}`}
                                                                tabIndex={0}
                                                            >
                                                                <td className="px-4 py-4">
                                                                    <div className="font-mono text-xs text-slate-600 font-semibold">#{t.id}</div>
                                                                </td>
                                                                <td className="px-4 py-4">
                                                                    {getStatusBadge(t, todayStr)}
                                                                    <div className={`text-[10px] mt-1.5 px-2 py-0.5 w-fit rounded-full border font-medium ${getTeamBadgeClass(t.team)}`}>{t.team}</div>
                                                                    {t.project && <div className={`text-[10px] mt-1 px-2 py-0.5 w-fit rounded-md border font-medium ${getProjectColor(t.project)}`}>{t.project}</div>}
                                                                </td>
                                                                <td className="px-4 py-4">
                                                                    <div className="font-medium text-slate-900 flex items-center gap-2">
                                                                        {t.isCheckpoint && <Icon path={paths.flag} size={14} className="text-indigo-600 fill-indigo-100 flex-shrink-0" />}
                                                                        <span className="line-clamp-2">{t.task}</span>
                                                                        {t.dependency && <div className="tooltip-container flex-shrink-0"><Icon path={paths.link} size={12} className="text-slate-400" /><span className="tooltip-text">å‰ç½®ä»»å‹™: {parseDependencies(t.dependency).map(id => `#${id}`).join(', ')}</span></div>}
                                                                        {t.notes && <div className="tooltip-container flex-shrink-0"><Icon path={paths.file} size={12} className="text-slate-400" /><span className="tooltip-text">{t.notes}</span></div>}
                                                                    </div>
                                                                    {t.priority === 'High' && <span className="text-[10px] text-orange-600 font-bold mt-1 inline-block">âš¡ æ€¥ä»¶</span>}
                                                                </td>
                                                                <td className="px-4 py-4 text-slate-600">
                                                                    <div className="flex items-center gap-1.5"><Icon path={paths.timer} size={14} className="text-slate-400" /> <span className="font-medium">{t.duration}</span> å¤©</div>
                                                                    <div className="text-[10px] text-slate-400 mt-1">Start: {getStartDate(t.date, t.duration)}</div>
                                                                </td>
                                                                <td className="px-4 py-4">
                                                                    <div className="font-semibold text-slate-700">{t.date}</div>
                                                                </td>
                                                                <td className="px-4 py-4">
                                                                    <div className="w-8 h-8 rounded-full bg-gradient-to-br from-slate-200 to-slate-300 flex items-center justify-center text-xs font-bold text-slate-700 shadow-sm">
                                                                        {t.owner ? t.owner[0] : '?'}
                                                                    </div>
                                                                </td>
                                                                <td className="px-4 py-4 text-right">
                                                                    <div className="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-all duration-200">
                                                                        <button
                                                                            onClick={() => { setEditingTask(t); setIsModalOpen(true); }}
                                                                            className="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded transition-colors"
                                                                            title="ç·¨è¼¯"
                                                                        >
                                                                            <Icon path={paths.edit} size={16} />
                                                                        </button>
                                                                        <button
                                                                            onClick={() => handleDelete(t.id)}
                                                                            className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors"
                                                                            title="åˆªé™¤"
                                                                        >
                                                                            <Icon path={paths.trash} size={16} />
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    )}

                                    {/* åœ“é¤…åœ– - ç§»åˆ°ä»»å‹™åˆ—è¡¨ä¸‹æ–¹ */}
                                    <div className="bg-white p-6 rounded-xl border-2 border-slate-200 shadow-md">
                                        <div className="flex items-center justify-between mb-4">
                                            <h3 className="font-bold text-slate-800 text-lg flex items-center gap-2">
                                                <span>ğŸ“Š</span>
                                                å°ˆæ¡ˆåˆ†å¸ƒ
                                            </h3>
                                            <div className="text-xs text-slate-500">
                                                ä¾Teamåˆ†é¡çµ±è¨ˆ
                                            </div>
                                        </div>
                                        <div className="h-80">
                                            {window.Recharts && (
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <PieChart>
                                                        <Pie
                                                            data={chartData}
                                                            dataKey="value"
                                                            cx="50%"
                                                            cy="50%"
                                                            innerRadius={80}
                                                            outerRadius={120}
                                                            paddingAngle={5}
                                                        >
                                                            {chartData.map((e, i) => <Cell key={i} fill={e.color} />)}
                                                        </Pie>
                                                        <Tooltip />
                                                        <Legend verticalAlign="bottom" height={36} />
                                                    </PieChart>
                                                </ResponsiveContainer>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-lg font-bold text-slate-800">
                                            {calendarMonth.toLocaleString('default', { year: 'numeric', month: 'long' })}
                                        </h2>
                                        <div className="flex gap-2">
                                            <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-slate-100 rounded-full"><Icon path={paths.left} /></button>
                                            <button onClick={() => changeMonth(1)} className="p-2 hover:bg-slate-100 rounded-full"><Icon path={paths.right} /></button>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-7 gap-px bg-slate-200 border border-slate-200 rounded-lg overflow-hidden">
                                        {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => (
                                            <div key={d} className="bg-slate-50 py-2 text-center text-xs font-bold text-slate-500 uppercase">{d}</div>
                                        ))}
                                        {calendarDays.map((day, idx) => (
                                            <div key={idx} className={`bg-white min-h-[120px] p-2 relative calendar-cell ${!day ? 'bg-slate-50/50' : ''}`}>
                                                {day && (
                                                    <>
                                                        <span className={`text-xs font-medium ${day.date === new Date().getDate() && calendarMonth.getMonth() === new Date().getMonth() ? 'bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center' : 'text-slate-400'}`}>{day.date}</span>
                                                        <div className="mt-1 space-y-1 overflow-y-auto max-h-[100px] scrollbar-hide">
                                                            {day.tasks.map(t => (
                                                                <div key={t.id}
                                                                    onClick={() => { setEditingTask(t); setIsModalOpen(true); }}
                                                                    className={`group text-[10px] p-1 rounded border-l-2 cursor-pointer hover:opacity-80 flex items-center gap-1 ${getProjectColor(t.project)} ${t.isCheckpoint ? 'font-bold' : ''}`}>
                                                                    {t.isCheckpoint && <Icon path={paths.flag} size={8} />}
                                                                    <span className="truncate">
                                                                        <span className="font-mono text-[9px] mr-1 opacity-70 hidden group-hover:inline">#{t.id}</span>
                                                                        {t.task}
                                                                    </span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )
                        )}
                    </div>

                    {
                        isModalOpen && (
                            <div
                                className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
                                role="dialog"
                                aria-modal="true"
                                aria-labelledby="modal-title"
                            >
                                <div className="bg-white rounded-xl shadow-xl w-full max-w-lg max-h-[90vh] animate-fade-in overflow-hidden flex flex-col">
                                    <div className="p-4 border-b flex justify-between items-center bg-slate-50 flex-shrink-0">
                                        <h3 id="modal-title" className="font-bold text-slate-800">{editingTask ? 'ç·¨è¼¯ä»»å‹™' : 'æ–°å¢ä»»å‹™'}</h3>
                                        <button
                                            onClick={() => setIsModalOpen(false)}
                                            className="text-slate-400 hover:text-slate-600"
                                            aria-label="é—œé–‰å°è©±æ¡†"
                                        >
                                            <Icon path={paths.x} />
                                        </button>
                                    </div>
                                    {/* å¯æ»¾å‹•å…§å®¹å€ */}
                                    <div className="overflow-y-auto flex-1">
                                        <form onSubmit={handleSave} id="task-form" className="p-6 space-y-4">
                                            <div>
                                                <label className="block text-sm font-medium text-slate-700 mb-1">ä»»å‹™å…§å®¹ <span className="text-red-500">*</span></label>
                                                <input name="task" defaultValue={editingTask?.task} required className="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" />
                                            </div>

                                            {/* åŸºæœ¬è³‡è¨Šå€å¡Š */}
                                            <div className="bg-slate-50 p-4 rounded-lg border space-y-3">
                                                <h4 className="text-xs font-semibold text-slate-600 uppercase">åŸºæœ¬è³‡è¨Š</h4>

                                                {/* Project - æ–°å¢! */}
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">
                                                        å°ˆæ¡ˆ (Project) <span className="text-red-500">*</span>
                                                    </label>
                                                    <select name="project" defaultValue={editingTask?.project || PROJECTS[0]} required className="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500">
                                                        {PROJECTS.map(p => <option key={p} value={p}>{p}</option>)}
                                                    </select>
                                                </div>

                                                {/* Teamæ”¹ç‚ºå–®åˆ— */}
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">Team <span className="text-red-500">*</span></label>
                                                    <select name="team" defaultValue={editingTask?.team || 'æ™¶ç‰‡'} className="w-full border rounded-lg p-2 text-sm">
                                                        {TEAMS.map(t => <option key={t} value={t}>{t}</option>)}
                                                    </select>
                                                </div>

                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-1">è² è²¬äºº <span className="text-red-500">*</span></label>
                                                        <input list="owners" name="owner" defaultValue={editingTask?.owner} required className="w-full border rounded-lg p-2 text-sm" />
                                                        <datalist id="owners">{OWNERS.map(o => <option key={o} value={o} />)}</datalist>
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-1">é è¨ˆå·¥æ™‚ (å¤©)</label>
                                                        <input type="number" name="duration" defaultValue={editingTask?.duration || 1} min="0" className="w-full border rounded-lg p-2 text-sm" />
                                                    </div>
                                                </div>
                                            </div>

                                            {/* æ™‚é–“è¦åŠƒå€å¡Š */}
                                            <div className="bg-slate-50 p-4 rounded-lg border space-y-3">
                                                <h4 className="text-xs font-semibold text-slate-600 uppercase">æ™‚é–“è¦åŠƒ</h4>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-1">é–‹å§‹æ—¥æœŸ</label>
                                                        <input type="date" name="startDate" defaultValue={editingTask?.startDate || ''} className="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500" />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-1">å®Œæˆæ—¥ <span className="text-red-500">*</span></label>
                                                        <input type="date" name="date" defaultValue={editingTask?.date || todayStr} required className="w-full border rounded-lg p-2 text-sm" />
                                                    </div>
                                                </div>
                                            </div>

                                            {/* ç‹€æ…‹èˆ‡å„ªå…ˆç´šå€å¡Š */}
                                            <div className="bg-slate-50 p-4 rounded-lg border space-y-3">
                                                <h4 className="text-xs font-semibold text-slate-600 uppercase">ç‹€æ…‹èˆ‡å„ªå…ˆç´š</h4>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-1">ç‹€æ…‹</label>
                                                        <select name="status" defaultValue={editingTask?.status || 'Todo'} className="w-full border rounded-lg p-2 text-sm">
                                                            <option value="Todo">å¾…åŸ·è¡Œ</option>
                                                            <option value="InProgress">é€²è¡Œä¸­</option>
                                                            <option value="Pending">æš«åœ/ç­‰å¾…</option>
                                                            <option value="Done">å®Œæˆ</option>
                                                            <option value="Closed">ä¸åŸ·è¡Œ/å–æ¶ˆ</option>
                                                            <option value="Delayed">å»¶èª¤</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-slate-700 mb-1">å„ªå…ˆç´š</label>
                                                        <select name="priority" defaultValue={editingTask?.priority || 'Medium'} className="w-full border rounded-lg p-2 text-sm">
                                                            <option value="Low">Low</option><option value="Medium">Medium</option><option value="High">High</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* é—œè¯è³‡è¨Šå€å¡Š */}
                                            <div className="space-y-3">
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">å‰ç½®ä»»å‹™ / ç›¸ä¾æ€§ (Dependency)</label>
                                                    <input name="dependency" defaultValue={editingTask?.dependency} placeholder="è¼¸å…¥å‰ç½®ä»»å‹™ IDï¼Œå¤šå€‹è«‹ç”¨é€—è™Ÿåˆ†éš” (ä¾‹å¦‚: 5,12,18)" className="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" />
                                                    <p className="text-xs text-slate-500 mt-1">ğŸ’¡ æç¤º:å¯å¡«å¯«å¤šå€‹ ID,ç”¨é€—è™Ÿåˆ†éš”,æœ€å¤š 10 å€‹</p>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">é©—è­‰æ–¹å¼ (Verification)</label>
                                                    <textarea name="verification" defaultValue={editingTask?.verification} rows="2" placeholder="å¦‚ä½•é©—è­‰æ­¤ä»»å‹™å·²å®Œæˆ? ä¾‹å¦‚: é€šéæ¸¬è©¦ã€å®¢æˆ¶ç°½æ”¶ã€æ–‡ä»¶å¯©æ ¸..." className="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"></textarea>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-700 mb-1">å‚™è¨» (Notes)</label>
                                                    <textarea name="notes" defaultValue={editingTask?.notes} rows="2" placeholder="è©³ç´°èªªæ˜..." className="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"></textarea>
                                                </div>
                                            </div>

                                            {/* ç‰¹æ®Šæ¨™è¨˜å€å¡Š */}
                                            <div className="bg-slate-50 p-4 rounded-lg border space-y-3">
                                                <h4 className="text-xs font-semibold text-slate-600 uppercase">ç‰¹æ®Šæ¨™è¨˜</h4>

                                                {/* Checkpointè¤‡é¸æ¡† */}
                                                <div className="flex items-center gap-3">
                                                    <div className="checkbox-container">
                                                        <input type="checkbox" name="isCheckpoint" id="chk" defaultChecked={editingTask?.isCheckpoint} className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all" />
                                                        <label htmlFor="chk" className="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer transition-all"></label>
                                                    </div>
                                                    <label htmlFor="chk" className="text-sm font-medium text-slate-700 cursor-pointer flex items-center gap-1">è¨­ç‚ºæª¢æŸ¥é» (Checkpoint) <Icon path={paths.flag} size={14} /></label>
                                                </div>

                                                {/* Issue Poolè¤‡é¸æ¡† - æ–°å¢! */}
                                                <div className="flex items-center gap-3">
                                                    <input
                                                        type="checkbox"
                                                        name="issuePool"
                                                        id="issuePool"
                                                        defaultChecked={editingTask?.issuePool || false}
                                                        className="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer"
                                                    />
                                                    <label htmlFor="issuePool" className="text-sm font-medium text-slate-700 cursor-pointer">
                                                        ğŸ”– åŠ å…¥Issueèªé ˜å€
                                                    </label>
                                                </div>
                                            </div>
                                        </form>
                                    </div>

                                    {/* å›ºå®šæŒ‰éˆ•å€ */}
                                    <div className="p-4 border-t bg-white flex justify-end gap-2 flex-shrink-0">
                                        <button type="button" onClick={() => setIsModalOpen(false)} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm">å–æ¶ˆ</button>
                                        <button type="submit" form="task-form" className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 shadow-sm">å„²å­˜</button>
                                    </div>
                                </div>
                            </div>
                        )
                    }
                </div >
            );
        };

    </script>

    <!-- ==================== å¤–éƒ¨çµ„ä»¶å¼•å…¥ ==================== -->
    <!-- Phase 1: ç³»çµ±ç®¡ç†ä»‹é¢ -->
    <script type="text/babel" src="js/components/SettingsView.js"></script>

    <!-- ==================== æ‡‰ç”¨å•Ÿå‹• ==================== -->
    <script type="text/babel">
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

</body>

</html>