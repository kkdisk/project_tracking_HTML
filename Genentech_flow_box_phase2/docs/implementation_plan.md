# Due Date 變更追蹤功能規劃

針對任務因 delay 而重新規劃 due date 時，提供完整的記錄與視覺化呈現方案。

## 現況分析

### 現有資料結構
```javascript
{
  id, project, category, task, owner,
  date,        // 完成日 (due date)
  duration,    // 預計工時 (天)
  status,      // Todo, InProgress, Done, Delayed, Closed
  priority, dependency, notes, isCheckpoint
}
```

### 問題
- 目前沒有記錄 due date 變更歷史的欄位
- 無法追蹤延期次數與原因
- 甘特圖只顯示當前時程，無法呈現原始規劃 vs 延期後時程

---

## 建議方案

### 方案 A：新增 `originalDate` 欄位（推薦 ⭐）

> [!TIP]
> 這是最簡潔的解法，只需新增一個欄位即可達成目標。

#### 新增欄位
| 欄位名稱 | 類型 | 說明 |
|---------|------|------|
| `originalDate` | string | 首次設定的原始完成日 |

#### 運作邏輯
1. **新任務建立時**：`originalDate = date`
2. **修改完成日時**：只更新 `date`，`originalDate` 保持不變
3. **判斷是否延期**：`date > originalDate` 表示已延期

#### 甘特圖呈現
```
原始時程：[▓▓▓▓▓▓] (淺色/虛線)
目前時程：    [████████] (實色)
```
- 用**淺色半透明**或**虛線邊框**顯示原始時程
- 延期天數 = `date - originalDate`

---

### 方案 B：完整變更歷史記錄（進階）

> [!NOTE]
> 適合需要詳細追蹤每次變更的場景。

#### 新增欄位
| 欄位名稱 | 類型 | 說明 |
|---------|------|------|
| `dateHistory` | JSON string | 變更歷史陣列 |

#### 資料結構範例
```javascript
dateHistory: JSON.stringify([
  { date: "2025-12-15", changedAt: "2025-12-01T10:00:00Z", reason: "初始規劃" },
  { date: "2025-12-20", changedAt: "2025-12-10T14:30:00Z", reason: "等待零件" },
  { date: "2025-12-25", changedAt: "2025-12-18T09:15:00Z", reason: "人力不足" }
])
```

#### 甘特圖呈現
- 顯示多階段時程線（類似里程碑演變）
- 滑鼠懸停可查看變更歷史

---

### 方案 C：結合方案 A + 延期原因欄位

#### 新增欄位
| 欄位名稱 | 類型 | 說明 |
|---------|------|------|
| `originalDate` | string | 原始完成日 |
| `delayReason` | string | 延期原因說明 |
| `delayCount` | number | 延期次數 |

---

---

## 方案 A vs 方案 B 詳細比較

| 比較項目 | 方案 A (originalDate) | 方案 B (dateHistory JSON) |
|---------|----------------------|--------------------------|
| **新增欄位** | 1 個 (`originalDate`) | 1 個 (`dateHistory`) |
| **儲存複雜度** | 簡單字串 | JSON 字串 |
| **變更原因追蹤** | ❌ 無法記錄 | ✅ 每次變更可記錄原因 |
| **歷史紀錄** | 只記錄首次日期 | 完整保留所有變更歷史 |
| **延期次數統計** | 需額外計算 | ✅ 內建（陣列長度） |
| **程式複雜度** | 簡單 | 中等（需 JSON 處理） |
| **效能** | ⚡ 最佳 | 略差（需解析 JSON） |
| **報表分析** | 基礎 | ✅ 可產出詳細變更報告 |

### 方案 B 特有優勢
1. **完整審計軌跡**：每次修改日期都有記錄，可追溯責任
2. **變更原因分析**：可統計延期原因（如「等待零件」出現 5 次）
3. **專案回顧**：結案時可產出完整的時程演變報告
4. **符合 ISO 品質管理**：有完整變更記錄利於稽核

---

## 甘特圖呈現設計

### 🔹 方案 A 甘特圖呈現

```
任務名稱         |  12   13   14   15   16   17   18   19   20   21   22   23
─────────────────┼────────────────────────────────────────────────────────────
流道機殼發包完成  |  ░░░░░░░░░░░ (原始)
                 |            ████████████████ (目前)
                 |            ↑ 延期 5 天
```

- **淺灰虛線**：原始規劃時程 (`originalDate`)
- **實色條**：目前時程 (`date`)
- **標籤**：顯示延期天數

### 🔹 方案 B 甘特圖呈現（進階版）

```
任務名稱         |  12   13   14   15   16   17   18   19   20   21   22   23
─────────────────┼────────────────────────────────────────────────────────────
流道機殼發包完成  |  ░░░░░ (v1: 初始)
                 |      ▒▒▒▒▒▒▒▒ (v2: 等待零件)
                 |             ████████████ (v3: 人力不足)
                 |                         ↑ 總延期 8 天
                 |  [📋 查看變更歷史]
```

- **多層時程條**：每次變更都可視覺化
- **滑鼠懸停**：顯示該版本的變更原因與時間
- **詳細彈窗**：點擊可查看完整歷史表格

### 方案 B 變更歷史彈窗範例

| 版本 | 完成日 | 變更時間 | 變更原因 |
|------|--------|----------|----------|
| 🏁 v1 | 2025-12-15 | 2025-12-01 10:00 | 初始規劃 |
| 🔄 v2 | 2025-12-18 | 2025-12-10 14:30 | 等待零件到貨 |
| 🔄 v3 | 2025-12-23 | 2025-12-16 09:15 | 人力調度問題 |

---

## 建議選擇指南

| 如果您... | 選擇 |
|----------|------|
| 只需看原始 vs 目前時程 | ⭐ 方案 A |
| 需要追蹤每次變更原因 | ⭐ 方案 B |
| 需要產出延期分析報告 | ⭐ 方案 B |
| 希望最快完成實作 | ⭐ 方案 A |
| 配合 ISO/品質稽核需求 | ⭐ 方案 B |

---

## 實作路線

### 變更範圍

#### [MODIFY] [index.html](file:///d:/code/cytesi/project_tracking_HTML_githgb/Genentech_flow_box_phase2/index.html)

1. **資料處理**：API 回傳時初始化 `originalDate`
2. **表單處理**：新增任務時設定 `originalDate = date`
3. **甘特圖**：繪製原始時程的淺色區塊
4. **列表顯示**：顯示延期天數提示

#### [MODIFY] Google Apps Script (後端)
- 新增 `originalDate` 欄位到 Google Sheets
- 處理 upsert 時的欄位儲存

### 甘特圖視覺設計

```css
/* 原始時程條 (淺色) */
.gantt-bar-original {
  background-color: rgba(100, 100, 100, 0.2);
  border: 1px dashed #94a3b8;
}

/* 延期標記 */
.delay-badge {
  background-color: #fee2e2;
  color: #dc2626;
  font-size: 10px;
  padding: 2px 4px;
  border-radius: 4px;
}
```

---

## User Review Required

> [!IMPORTANT]
> 請確認以下決策：

1. **方案選擇**：是否採用方案 A（`originalDate` 單欄位），或需要更完整的歷史記錄（方案 B）？

2. **後端修改**：是否需要我一併提供 Google Apps Script 的修改？或您自行處理後端？

3. **遷移策略**：現有任務的 `originalDate` 預設值要設為當前 `date` 還是留空？

4. **甘特圖呈現偏好**：
   - 選項 1：虛線邊框顯示原始時程
   - 選項 2：半透明淺色背景顯示原始時程
   - 選項 3：只在延期任務旁顯示標籤 (如：「+5天」)

---

## Verification Plan

### 手動測試步驟

1. **新增任務測試**
   - 建立新任務，完成日設為 2025-12-25
   - 確認 `originalDate` 等於 `date`

2. **延期測試**
   - 編輯任務，將完成日改為 2025-12-30
   - 確認 `originalDate` 維持 2025-12-25 不變
   - 確認甘特圖顯示兩條時程線

3. **甘特圖視覺驗證**
   - 延期任務應顯示原始時程（淺色）+ 新時程（實色）
   - 滑鼠懸停應顯示延期天數

4. **列表視圖驗證**
   - 延期任務旁應顯示延期標籤
